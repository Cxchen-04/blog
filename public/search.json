[{"title":"Python åœ¨ Linux è¿ç»´ä¸­çš„åº”ç”¨","url":"/2025/03/26/Python/","content":"Python ç®€ä»‹Python æ˜¯ä¸€é—¨ç®€æ´æ˜“è¯»çš„ç¼–ç¨‹è¯­è¨€ï¼Œéå¸¸é€‚åˆç”¨æ¥ç¼–å†™è‡ªåŠ¨åŒ–è„šæœ¬å’Œè¿ç»´å·¥å…·ã€‚ç›¸æ¯”ä»…èƒ½æ‰§è¡Œç®€å•å‘½ä»¤çš„ Shellï¼ŒPython æ‹¥æœ‰æ›´å®Œå–„çš„è¯­æ³•ã€æµ·é‡çš„ç¬¬ä¸‰æ–¹åº“ä»¥åŠè·¨å¹³å°èƒ½åŠ›ï¼Œå› æ­¤èƒ½æ›´å¥½åœ°åº”å¯¹å¤æ‚åœºæ™¯ã€‚\n\næ˜“ä¸Šæ‰‹ï¼šè¯­æ³•ç›´è§‚ï¼Œå…¥é—¨é—¨æ§›ä½ã€‚\nç”Ÿæ€ä¸°å¯Œï¼šæ‹¥æœ‰æˆåƒä¸Šä¸‡çš„ç¬¬ä¸‰æ–¹åº“ï¼Œå¯å¿«é€Ÿå®ç°ç½‘ç»œè¯·æ±‚ã€æ•°æ®å¤„ç†ã€å›¾å½¢åŒ–ç­‰åŠŸèƒ½ã€‚\nå¯æ‰©å±•ï¼šæ—¢èƒ½å†™å‡ è¡Œè„šæœ¬ï¼Œä¹Ÿèƒ½æ„å»ºå¤§å‹åº”ç”¨ã€‚\n\nä¸‹é¢çš„å†…å®¹å°†ä»‹ç»åœ¨ Linux è¿ç»´ä¸­å¸¸è§çš„ Python æŠ€æœ¯ï¼Œå¸®åŠ©é›¶åŸºç¡€çš„åŒå­¦å¿«é€Ÿå…¥é—¨ã€‚\nå‡†å¤‡å·¥ä½œï¼šå®‰è£…ä¸è¿è¡Œå¤§å¤šæ•° Linux å‘è¡Œç‰ˆéƒ½è‡ªå¸¦ Pythonã€‚å¯ä»¥é€šè¿‡ python3 --version æŸ¥çœ‹å½“å‰ç‰ˆæœ¬ã€‚è‹¥éœ€è¦æ‰‹åŠ¨å®‰è£…ï¼Œå¯åœ¨ Debian&#x2F;Ubuntu ä¸Šæ‰§è¡Œï¼š\nsudo apt update &amp;&amp; sudo apt install -y python3 python3-pip\nè¿è¡Œ Python è„šæœ¬çš„æ–¹å¼æœ‰ä¸¤ç§ï¼š\n\nç›´æ¥è°ƒç”¨è§£é‡Šå™¨ï¼špython3 your_script.py\nåœ¨è„šæœ¬å¼€å¤´æ·»åŠ  shebang å¹¶èµ‹äºˆæ‰§è¡Œæƒé™ï¼š#!/usr/bin/env python3print(&quot;Hello, world!&quot;)\nç„¶å chmod +x your_script.pyï¼Œå³å¯é€šè¿‡ ./your_script.py æ‰§è¡Œã€‚\n\nåŸºç¡€è¯­æ³•é€Ÿè§ˆ# å˜é‡ä¸æ•°æ®ç±»å‹name = &quot;Tom&quot;age = 18is_admin = False# æ¡ä»¶åˆ¤æ–­if age &gt;= 18:    print(&quot;æˆå¹´äºº&quot;)else:    print(&quot;æœªæˆå¹´&quot;)# å¾ªç¯for i in range(3):    print(i)# å‡½æ•°def greet(user):    return f&quot;Hello, &#123;user&#125;!&quot;print(greet(name))\n\nè™½ç„¶è¯­æ³•ç®€å•ï¼Œä½†æŒæ¡å˜é‡ã€åˆ—è¡¨ã€å­—å…¸ã€å¾ªç¯ã€å‡½æ•°ç­‰æ¦‚å¿µåï¼Œå°±èƒ½ç¼–å†™å®ç”¨çš„å°å·¥å…·äº†ã€‚å­¦ä¹ æ—¶å¯ä»¥è¾¹çœ‹è¾¹æ•²ï¼Œæ•ˆæœæ›´ä½³ã€‚\næ ¸å¿ƒæ¦‚å¿µè¡¥å……\nç¼©è¿›ï¼šPython ä½¿ç”¨ç¼©è¿›æ¥åˆ’åˆ†ä»£ç å—ï¼Œé€šå¸¸ä¸ºå››ä¸ªç©ºæ ¼ã€‚\næ³¨é‡Šï¼šä»¥ # å¼€å¤´çš„æ˜¯å•è¡Œæ³¨é‡Šï¼Œå¤šè¡Œæ³¨é‡Šå¯ç”¨ä¸‰å¼•å·åŒ…è£¹ã€‚\nå˜é‡ä½œç”¨åŸŸï¼šå‡½æ•°å†…éƒ¨å£°æ˜çš„å˜é‡ä»…åœ¨å‡½æ•°å†…å¯è§ã€‚\nè„šæœ¬ä¸æ¨¡å—ï¼š.py æ–‡ä»¶æ—¢å¯ä»¥ç›´æ¥æ‰§è¡Œï¼Œä¹Ÿå¯ä»¥è¢«å…¶ä»–ä»£ç  importã€‚\nå…¥å£åˆ¤æ–­ï¼šå¸¸ç”¨ if __name__ == &#39;__main__&#39;: åœ¨è„šæœ¬ç‹¬ç«‹è¿è¡Œæ—¶æ‰§è¡Œæµ‹è¯•ä»£ç ã€‚\n\nå¸¸ç”¨æ ‡å‡†åº“Python è‡ªå¸¦çš„æ ‡å‡†åº“æä¾›äº†å¤§é‡å®ç”¨æ¨¡å—ï¼Œåœ¨è¿ç»´è„šæœ¬ä¸­ç»å¸¸ä¼šç”¨åˆ°ï¼š\n\nosï¼šä¸ç³»ç»Ÿäº¤äº’ï¼Œè·å–ç¯å¢ƒå˜é‡ã€éå†æ–‡ä»¶å¤¹ç­‰ã€‚\nsysï¼šä¸ Python è§£é‡Šå™¨è‡ªèº«ç›¸å…³çš„å‚æ•°å’Œå‡½æ•°ã€‚\nsubprocessï¼šæ‰§è¡Œç³»ç»Ÿå‘½ä»¤å¹¶è·å–è¾“å‡ºï¼Œé€‚åˆæ›¿ä»£ os.systemã€‚\nshutilï¼šé«˜çº§æ–‡ä»¶æ“ä½œï¼Œå¦‚å¤åˆ¶ã€å‹ç¼©ç­‰ã€‚\npathlibï¼šé¢å‘å¯¹è±¡çš„è·¯å¾„å¤„ç†ï¼Œæ›´åŠ ç›´è§‚æ˜“è¯»ã€‚\nloggingï¼šæ ‡å‡†åŒ–æ—¥å¿—è¾“å‡ºï¼Œä¾¿äºæ’æŸ¥é—®é¢˜ã€‚\nargparseï¼šè§£æå‘½ä»¤è¡Œå‚æ•°ï¼Œç¼–å†™æ˜“ç”¨çš„ CLI ç¨‹åºã€‚\njsonï¼šè¯»å†™ JSON é…ç½®æˆ–æ¥å£æ•°æ®ã€‚\nreï¼šä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼è¿›è¡Œæ–‡æœ¬åŒ¹é…å’Œæ›¿æ¢ã€‚\nsocketï¼šç¼–å†™åº•å±‚ç½‘ç»œé€šä¿¡è„šæœ¬ã€‚\n\nç¤ºä¾‹ï¼šä½¿ç”¨ subprocess æ‰§è¡Œ ls å‘½ä»¤å¹¶æ‰“å°ç»“æœã€‚\nimport subprocessres = subprocess.run([&#x27;ls&#x27;, &#x27;-l&#x27;, &#x27;/var/log&#x27;], capture_output=True, text=True)print(res.stdout)\n\nå®ç”¨è¯­æ³•å°è´´å£«\nåˆ—è¡¨æ¨å¯¼å¼ï¼š[x * x for x in range(5)] è®©å¾ªç¯ç”Ÿæˆåˆ—è¡¨æ›´ç®€æ´ã€‚\nwith è¯­å¥ï¼šè‡ªåŠ¨ç®¡ç†æ–‡ä»¶æˆ–ç½‘ç»œè¿æ¥çš„å…³é—­ï¼Œé¿å…å¿˜è®°é‡Šæ”¾èµ„æºã€‚\næ ¼å¼åŒ–å­—ç¬¦ä¸²ï¼šä½¿ç”¨ f&quot;å½“å‰ç”¨æˆ·: &#123;name&#125;&quot; æ›´ç›´è§‚åœ°æ‹¼æ¥å˜é‡ã€‚\n\nç¬¬ä¸‰æ–¹åº“ä¸åŒ…ç®¡ç†Linux ä¸‹æ¨èä½¿ç”¨ pip æˆ– pip3 æ¥å®‰è£…ç¬¬ä¸‰æ–¹åº“ï¼Œä¾‹å¦‚ï¼š\npip3 install requests\nä¸ºäº†é¿å…æ±¡æŸ“ç³»ç»Ÿç¯å¢ƒï¼Œé€šå¸¸ä¼šå…ˆåˆ›å»º è™šæ‹Ÿç¯å¢ƒï¼š\npython3 -m venv venvsource venv/bin/activate\næ¿€æ´»åå®‰è£…çš„åº“éƒ½ä½äº venv ç›®å½•ä¸­ï¼Œéœ€è¦æ—¶å† deactivate é€€å‡ºã€‚\nå¸¸è§çš„è¿ç»´ç›¸å…³åº“åŒ…æ‹¬ï¼š\n\nparamikoï¼šä½¿ç”¨ SSH åè®®è¿œç¨‹æ‰§è¡Œå‘½ä»¤æˆ–ä¼ è¾“æ–‡ä»¶ã€‚\nfabricï¼šåŸºäº paramiko çš„é«˜çº§å°è£…ï¼Œæ›´æ˜“æ‰¹é‡æ‰§è¡Œä»»åŠ¡ã€‚\npsutilï¼šè·å– CPUã€å†…å­˜ã€ç£ç›˜ç­‰ç³»ç»Ÿä¿¡æ¯ã€‚\nscheduleï¼šç”¨ Python ç›´æ¥ç¼–å†™å®šæ—¶ä»»åŠ¡è„šæœ¬ã€‚\nrequestsï¼šæœ€å¸¸ç”¨çš„ HTTP åº“ï¼Œä¾¿äºè°ƒç”¨å„ç±»æ¥å£ã€‚\nFlaskï¼šè½»é‡çº§ Web æ¡†æ¶ï¼Œå¯å¿«é€Ÿåˆ¶ä½œç®€æ˜“åå°é¡µé¢ã€‚\nPyYAMLï¼šè¯»å–å’Œç”Ÿæˆ YAML æ ¼å¼çš„é…ç½®æ–‡ä»¶ã€‚\n\nç¤ºä¾‹ï¼šåˆ©ç”¨ paramiko è¿œç¨‹é‡å¯æœåŠ¡ã€‚\nimport paramikossh = paramiko.SSHClient()ssh.set_missing_host_key_policy(paramiko.AutoAddPolicy())ssh.connect(&#x27;192.168.1.10&#x27;, username=&#x27;root&#x27;, password=&#x27;yourpass&#x27;)stdin, stdout, stderr = ssh.exec_command(&#x27;systemctl restart nginx&#x27;)print(stdout.read().decode())ssh.close()\n\nè‡ªåŠ¨åŒ–åœºæ™¯ç¤ºä¾‹1. æ‰¹é‡ç®¡ç†æœåŠ¡å™¨å‡è®¾æœ‰å¤šå°ä¸»æœºéœ€è¦æ‰§è¡ŒåŒä¸€æ“ä½œï¼Œå¯ä»¥ç¼–å†™è„šæœ¬å¾ªç¯æ‰§è¡Œï¼š\nhosts = [&#x27;192.168.1.10&#x27;, &#x27;192.168.1.11&#x27;]for h in hosts:    ssh = paramiko.SSHClient()    ssh.set_missing_host_key_policy(paramiko.AutoAddPolicy())    ssh.connect(h, username=&#x27;root&#x27;)    ssh.exec_command(&#x27;apt update &amp;&amp; apt upgrade -y&#x27;)    ssh.close()\n\n2. ç›‘æ§ç³»ç»ŸçŠ¶æ€å€ŸåŠ© psutil è·å–ç³»ç»Ÿèµ„æºï¼Œå¹¶æ ¹æ®æ¡ä»¶è§¦å‘å‘Šè­¦ï¼š\nimport psutilcpu = psutil.cpu_percent(interval=1)mem = psutil.virtual_memory().percentif cpu &gt; 80 or mem &gt; 80:    print(&#x27;âš ï¸ èµ„æºä½¿ç”¨ç‡è¿‡é«˜&#x27;)\n\n3. å®šæœŸæ‰§è¡Œä»»åŠ¡é™¤äº†ä½¿ç”¨ Linux è‡ªå¸¦çš„ crontabï¼Œä¹Ÿå¯ä»¥é€šè¿‡ schedule åº“ä»¥æ›´ Pythonic çš„æ–¹å¼å®‰æ’ä»»åŠ¡ï¼š\nimport scheduleimport timedef job():    print(&#x27;æ‰§è¡Œå¤‡ä»½â€¦â€¦&#x27;)schedule.every().day.at(&#x27;02:00&#x27;).do(job)while True:    schedule.run_pending()    time.sleep(1)\n\nä¸è¿ç»´å·¥å…·ç»“åˆPython å¸¸è§çš„è¿ç»´æ¡†æ¶ä¸å¹³å°åŒ…æ‹¬ï¼š\n\nAnsibleï¼šé€šè¿‡ç¼–å†™ YAML æ ¼å¼çš„ Playbook æ‰¹é‡ç®¡ç†æœåŠ¡å™¨ï¼Œåº•å±‚ä½¿ç”¨ Python å®ç°ã€‚\nSaltStackï¼šé¢å‘å¤§è§„æ¨¡é›†ç¾¤çš„é…ç½®ç®¡ç†å’Œè‡ªåŠ¨åŒ–è¿ç»´å·¥å…·ã€‚\nFabricï¼šè½»é‡çº§çš„è¿œç¨‹æ‰§è¡Œåº“ï¼Œé€‚åˆè‡ªå®šä¹‰éƒ¨ç½²æµç¨‹ã€‚\n\nè¿™äº›å·¥å…·æœ¬èº«å°±æ˜¯ç”¨ Python ç¼–å†™çš„ï¼Œå› æ­¤èƒ½ä¸ Python è„šæœ¬æ— ç¼ç»“åˆï¼Œå®ç°æ›´åŠ çµæ´»çš„è‡ªåŠ¨åŒ–æµç¨‹ã€‚\næ—¥å¿—ä¸å¼‚å¸¸å¤„ç†åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œè‰¯å¥½çš„æ—¥å¿—è‡³å…³é‡è¦ã€‚Python çš„ logging æ¨¡å—å¯ä»¥æ–¹ä¾¿åœ°è®°å½•è°ƒè¯•ä¿¡æ¯ï¼š\nimport logginglogging.basicConfig(    filename=&#x27;/var/log/myapp.log&#x27;,    level=logging.INFO,    format=&#x27;%(asctime)s %(levelname)s %(message)s&#x27;)try:    # å…³é”®æ“ä½œ    logging.info(&#x27;å¼€å§‹æ‰§è¡Œä»»åŠ¡&#x27;)except Exception as e:    logging.error(&#x27;å‡ºé”™: %s&#x27;, e)\n\nåŒæ—¶ï¼Œæ•è·å¼‚å¸¸å¹¶åˆç†å¤„ç†ï¼Œå¯ä»¥é¿å…è„šæœ¬åœ¨å…³é”®æ—¶åˆ»çªç„¶ä¸­æ–­ï¼š\ntry:    risky_operation()except Exception as err:    print(&#x27;å‘ç”Ÿé”™è¯¯&#x27;, err)\n\nå®æˆ˜ï¼šç£ç›˜ç©ºé—´å‘Šè­¦è„šæœ¬ä¸‹é¢ç¤ºä¾‹ä¼šæ£€æŸ¥ç£ç›˜ä½¿ç”¨ç‡ï¼Œå¹¶åœ¨è¶…è¿‡é˜ˆå€¼æ—¶å‘é€é‚®ä»¶ï¼š\n#!/usr/bin/env python3import shutilimport smtplibfrom email.mime.text import MIMETextthreshold = 80usage = shutil.disk_usage(&#x27;/&#x27;)percent = usage.used / usage.total * 100if percent &gt; threshold:    msg = MIMEText(f&#x27;Disk usage is &#123;percent:.1f&#125;%!&#x27;)    msg[&#x27;Subject&#x27;] = &#x27;Disk Alert&#x27;    msg[&#x27;From&#x27;] = &#x27;monitor@example.com&#x27;    msg[&#x27;To&#x27;] = &#x27;admin@example.com&#x27;    with smtplib.SMTP(&#x27;smtp.example.com&#x27;) as s:        s.login(&#x27;user&#x27;, &#x27;pass&#x27;)        s.send_message(msg)\nå°†è¯¥è„šæœ¬åŠ å…¥ crontabï¼Œå³å¯å®ç°åŸºç¡€å‘Šè­¦åŠŸèƒ½ã€‚\næŒç»­æ”¹è¿›ä¸å­¦ä¹ å»ºè®®\nå¤šè¯»å®˜æ–¹æ–‡æ¡£ï¼šPython å®˜æ–¹æ•™ç¨‹å’Œå„åº“çš„æ–‡æ¡£æ˜¯æœ€ä½³å­¦ä¹ èµ„æ–™ã€‚\nä»ç®€å•è„šæœ¬å¼€å§‹ï¼šå…ˆè§£å†³å®é™…é—®é¢˜ï¼Œå†é€æ­¥æŠ½è±¡æˆå¯å¤ç”¨çš„å‡½æ•°æˆ–æ¨¡å—ã€‚\nå…³æ³¨ç¤¾åŒºï¼šStack Overflowã€åšå®¢å’Œè®ºå›èƒ½æä¾›ä¸°å¯Œçš„æ¡ˆä¾‹å’Œç»éªŒã€‚\nç¼–å†™æ¨¡å—åŒ–ä»£ç ï¼šéšç€è„šæœ¬å¢å¤šï¼Œå¯é€æ¸å­¦ä¹ é¢å‘å¯¹è±¡å’Œæ¨¡å—åŒ–ç¼–ç¨‹ï¼Œä¾¿äºç»´æŠ¤ã€‚\n\næŒæ¡ä»¥ä¸ŠçŸ¥è¯†åï¼Œä½ å°±èƒ½ä½¿ç”¨ Python é«˜æ•ˆåœ°å¤„ç†æ—¥å¸¸è¿ç»´å·¥ä½œï¼Œä»è€ŒæŠŠç²¾åŠ›æŠ•å…¥åˆ°æ›´é‡è¦çš„ä»»åŠ¡ä¸­ã€‚ç¥ä½ åœ¨è¿ç»´ä¹‹è·¯è¶Šèµ°è¶Šè¿œï¼\n","categories":["è¿ç»´","Python"],"tags":["è¿ç»´","Python","è‡ªåŠ¨åŒ–"]},{"title":"Shell","url":"/2025/03/26/Shell/","content":"ä»€ä¹ˆæ˜¯ ShellShell æ˜¯ Linux å’Œ Unix ç³»ç»Ÿä¸­çš„ â€œå‘½ä»¤è¡Œè§£é‡Šå™¨â€ï¼Œå®ƒå…è®¸æˆ‘ä»¬é€šè¿‡æ–‡æœ¬å‘½ä»¤æ¥å’Œç³»ç»Ÿäº¤äº’ã€‚æœ€å¸¸è§çš„ Bash æ—¢æ˜¯ä¸€é—¨è„šæœ¬è¯­è¨€ï¼Œåˆæä¾›äº†å¼ºå¤§çš„è‡ªåŠ¨åŒ–èƒ½åŠ›ã€‚\nä¸ºä»€ä¹ˆè¿ç»´è¦å­¦ Shell\næ‰¹é‡æ“ä½œï¼šé€šè¿‡è„šæœ¬ä¸€æ¬¡å¤„ç†å¤šå°æœåŠ¡å™¨æˆ–å¤§é‡æ–‡ä»¶ã€‚\nè‡ªåŠ¨åŒ–ï¼šå®šæ—¶ä»»åŠ¡ã€ç›‘æ§è„šæœ¬ã€éƒ¨ç½²è„šæœ¬éƒ½ç¦»ä¸å¼€å®ƒã€‚\næˆæœ¬ä½ï¼šç³»ç»Ÿè‡ªå¸¦ï¼Œæ— éœ€é¢å¤–å®‰è£…ã€‚\nå¯ç§»æ¤ï¼šè„šæœ¬åœ¨å„ Linux å‘è¡Œç‰ˆé—´åŸºæœ¬é€šç”¨ã€‚\n\nç¬¬ä¸€ä¸ªè„šæœ¬#!/bin/bashecho &quot;Hello World&quot;\nä¿å­˜ä¸º hello.shï¼Œç»™æ‰§è¡Œæƒé™åè¿è¡Œï¼š\nchmod +x hello.sh./hello.sh\n\nåŸºæœ¬è¯­æ³•å˜é‡ä¸å­—ç¬¦ä¸²name=&quot;Bob&quot;echo &quot;Hello, $name&quot;\n\nä½¿ç”¨ $(command) å¯ä»¥è·å–å‘½ä»¤ç»“æœï¼šfiles=$(ls /etc | wc -l)\n\næ¡ä»¶åˆ¤æ–­if [ -f /etc/passwd ]; then  echo &quot;æ–‡ä»¶å­˜åœ¨&quot;else  echo &quot;æ–‡ä»¶ä¸å­˜åœ¨&quot;fi\næ”¯æŒ -f (æ–‡ä»¶å­˜åœ¨)ã€-d (ç›®å½•å­˜åœ¨) ç­‰å¤šç§æ¡ä»¶è¡¨è¾¾å¼ã€‚\nå¾ªç¯forfor user in alice bob carol; do  echo &quot;æ¬¢è¿ $user&quot;done\nwhilecounter=0while [ $counter -lt 5 ]; do  echo &quot;è®¡æ•°: $counter&quot;  counter=$((counter+1))done\n\nå‡½æ•°backup_file() &#123;  src=$1  dest=$2  cp &quot;$src&quot; &quot;$dest&quot;&#125;backup_file /etc/hosts /tmp/hosts.bak\nå‡½æ•°è®©è„šæœ¬ç»“æ„æ›´æ¸…æ™°ï¼Œä¹Ÿæ–¹ä¾¿å¤ç”¨ã€‚\nå¸¸è§è¿ç»´åœºæ™¯æ‰¹é‡æ‰§è¡Œå‘½ä»¤å€ŸåŠ© for å¾ªç¯å’Œ ssh å¯ä»¥å¯¹å¤šå°æœåŠ¡å™¨æ‰¹é‡æ“ä½œï¼š\nservers=&quot;192.168.1.10 192.168.1.11&quot;for host in $servers; do  ssh root@$host &quot;systemctl restart nginx&quot;done\n\næ—¥å¿—ç›‘æ§ä½¿ç”¨ tail -f å®æ—¶æŸ¥çœ‹æ—¥å¿—å¹¶é…åˆæ¡ä»¶è§¦å‘å‘Šè­¦ï¼š\ntail -f /var/log/nginx/access.log | while read line; do  echo &quot;$line&quot; | grep &quot;500&quot; &amp;&amp; echo &quot;å‘ç° 500 é”™è¯¯&quot;done\n\nè‡ªåŠ¨å¤‡ä»½#!/bin/bashsrc=/databak=/backup/$(date +%F)mkdir -p &quot;$bak&quot;cp -r &quot;$src&quot; &quot;$bak&quot;\næ­é… crontab å®šæ—¶æ‰§è¡Œå³å¯å®Œæˆæ¯æ—¥å¤‡ä»½ã€‚\nè‡ªåŠ¨åŒ–æŠ€å·§\nç»“åˆ crontab å®šæ—¶è¿è¡Œè„šæœ¬ï¼š# æ¯å¤©å‡Œæ™¨ 2 ç‚¹å¤‡ä»½0 2 * * * /usr/local/bin/backup.sh\nç¯å¢ƒå˜é‡ç®¡ç†ï¼šåœ¨è„šæœ¬å¼€å¤´ä½¿ç”¨ export è®¾ç½®å˜é‡ï¼Œæˆ–åŠ è½½ .env æ–‡ä»¶ã€‚\næ—¥å¿—è®°å½•ï¼šexec &gt;&gt;/var/log/myscript.log 2&gt;&amp;1 å¯æŠŠè„šæœ¬è¾“å‡ºå†™å…¥æ—¥å¿—æ–‡ä»¶ã€‚\nä½¿ç”¨ set -euo pipefail æé«˜å¥å£®æ€§ï¼š#!/bin/bashset -euo pipefail\n\nå®æˆ˜ç¤ºä¾‹ï¼šä¸€é”®éƒ¨ç½² Web æœåŠ¡#!/bin/bashset -eapp_src=/opt/appweb_root=/var/www/html# å®‰è£…ä¾èµ–apt update &amp;&amp; apt install -y nginx git# æ‹‰å–ä»£ç å¹¶éƒ¨ç½²if [ ! -d &quot;$app_src&quot; ]; then  git clone https://example.com/repo.git &quot;$app_src&quot;else  git -C &quot;$app_src&quot; pullficp -r &quot;$app_src&quot;/* &quot;$web_root&quot;/# å¯åŠ¨æœåŠ¡systemctl restart nginx\n\nå­¦ä¹ å»ºè®®\næ¯å¤©å†™ä¸€ç‚¹è„šæœ¬ï¼Œç»ƒä¹ å¸¸ç”¨å‘½ä»¤ã€‚\né˜…è¯»ä»–äººçš„è„šæœ¬ï¼Œç†è§£å…¶ä¸­çš„é€»è¾‘ã€‚\né‡åˆ°é—®é¢˜å…ˆè¯•ç€æ‰‹åŠ¨æ“ä½œï¼Œå†ç”¨è„šæœ¬å°è£…ã€‚\n\nShell æ˜¯ä¸€æŠŠç‘å£«å†›åˆ€ï¼Œä¸º Linux è¿ç»´å¸¦æ¥æ— é™å¯èƒ½ã€‚ç†Ÿç»ƒæŒæ¡åï¼Œä½ å¯ä»¥æŠŠé‡å¤å·¥ä½œäº¤ç»™è„šæœ¬ï¼Œä¸“æ³¨æ›´é«˜ä»·å€¼çš„ä»»åŠ¡ã€‚\næ‰©å±•æ¦‚å¿µ\nShell ä¸ç»ˆç«¯ï¼šç»ˆç«¯ (Terminal) æ˜¯æ˜¾ç¤ºå’Œè¾“å…¥ç•Œé¢ï¼ŒShell æ˜¯çœŸæ­£è§£æå‘½ä»¤çš„ç¨‹åºã€‚å¸¸è§ Shell æœ‰ Bashã€Zsh ç­‰ã€‚\nShebangï¼šè„šæœ¬ç¬¬ä¸€è¡Œ #!/bin/bash æŒ‡å®šç”¨å“ªä¸ªè§£é‡Šå™¨è¿è¡Œï¼Œè¿™æ˜¯è®©è„šæœ¬èƒ½å¤Ÿç›´æ¥æ‰§è¡Œçš„å…³é”®ã€‚\näº¤äº’å¼ä¸éäº¤äº’å¼ï¼šç™»å½•åæ‰‹åŠ¨è¾“å…¥å‘½ä»¤å±äºäº¤äº’å¼ï¼Œå®šæ—¶ä»»åŠ¡æˆ–è„šæœ¬è°ƒç”¨åˆ™æ˜¯éäº¤äº’å¼ï¼Œéœ€è¦ç¡®ä¿å˜é‡ä¸ç¯å¢ƒæ­£ç¡®ã€‚\nç®¡é“ä¸é‡å®šå‘ï¼šä½¿ç”¨ | æŠŠå¤šä¸ªå‘½ä»¤è¿æ¥æˆæµæ°´çº¿ï¼Œ&gt; æˆ– &gt;&gt; æŠŠè¾“å‡ºå†™å…¥æ–‡ä»¶ï¼Œæ˜¯æ„å»ºå¤æ‚æµç¨‹çš„æ ¸å¿ƒæ–¹å¼ã€‚\n\nä¼ä¸šå¸¸ç”¨è„šæœ¬æ¡ˆä¾‹1. æœåŠ¡å¥åº·æ£€æŸ¥#!/bin/bashurl=&quot;https://example.com/health&quot;status=$(curl -s -o /dev/null -w &quot;%&#123;http_code&#125;&quot; &quot;$url&quot;)if [ &quot;$status&quot; != &quot;200&quot; ]; then  echo &quot;[è­¦å‘Š] æœåŠ¡å¼‚å¸¸ï¼ŒçŠ¶æ€ç  $status&quot; | mail -s &quot;Health Check&quot; admin@example.comfi\n\n2. è‡ªåŠ¨æ¸…ç†æ—¥å¿—#!/bin/bashlogdir=/var/log/myappfind &quot;$logdir&quot; -name &quot;*.log&quot; -mtime +7 -delete\n\n3. æ‰¹é‡å‘å¸ƒä»£ç servers=&quot;srv1 srv2 srv3&quot;for h in $servers; do  ssh $h &quot;cd /opt/app &amp;&amp; git pull &amp;&amp; systemctl restart app&quot;done\n\n4. æ•°æ®å¤‡ä»½åŒæ­¥#!/bin/bashsrc=/dataremote=user@backup:/datarsync -avz &quot;$src&quot; &quot;$remote&quot;\n\nä¼ä¸šè„šæœ¬å¾€å¾€å›´ç»•ç›‘æ§ã€å¤‡ä»½ã€éƒ¨ç½²ã€æ¸…ç†ç­‰åœºæ™¯å±•å¼€ã€‚å®è·µä¸­å¯ä»¥æ ¹æ®éœ€è¦ç»„åˆæˆå®Œæ•´çš„è‡ªåŠ¨åŒ–æµç¨‹ã€‚\n","categories":["æœåŠ¡ç«¯","Shell"],"tags":["æœåŠ¡ç«¯","Shell"]},{"title":"Docker","url":"/2025/03/25/docker/","content":"Docker æ˜¯ä¸€ä¸ªå¼€æºçš„åº”ç”¨å®¹å™¨å¼•æ“ï¼ŒåŸºäº Go è¯­è¨€ å¹¶éµä»Apache2.0åè®®å¼€æºã€‚Docker å¯ä»¥è®©å¼€å‘è€…æ‰“åŒ…ä»–ä»¬çš„åº”ç”¨ä»¥åŠä¾èµ–åŒ…åˆ°ä¸€ä¸ªè½»é‡çº§ã€å¯ç§»æ¤çš„å®¹å™¨ä¸­ï¼Œç„¶åå‘å¸ƒåˆ°ä»»ä½•æµè¡Œçš„ Linux æœºå™¨ä¸Šï¼Œä¹Ÿå¯ä»¥å®ç°è™šæ‹ŸåŒ–ã€‚å®¹å™¨æ˜¯å®Œå…¨ä½¿ç”¨æ²™ç®±æœºåˆ¶ï¼Œç›¸äº’ä¹‹é—´ä¸ä¼šæœ‰ä»»ä½•æ¥å£ï¼ˆç±»ä¼¼ iPhone çš„ appï¼‰,æ›´é‡è¦çš„æ˜¯å®¹å™¨æ€§èƒ½å¼€é”€æä½ã€‚\nç®€ä»‹å®¹å™¨æŠ€æœ¯ä¸ä»…é™äºdockerï¼Œä½†æ˜¯dockerç›®å‰æœ€ä¸ºæµè¡Œï¼Œdockerå®¹å™¨æŠ€æœ¯çš„æ ¸å¿ƒä¹‹ä¸€åœ¨äºé•œåƒæ–‡ä»¶ã€‚é•œåƒæ–‡ä»¶ï¼Œé€šä¿—çš„ç†è§£å°±æ˜¯ä¸€ä¸ªè¿›ç¨‹è¿è¡Œæ—¶ä¾èµ–çš„è½¯ä»¶æ–‡ä»¶çš„é›†è£…ç®±ã€‚\nâ€ƒâ€ƒåº”ç”¨é›†ç¾¤éƒ¨ç½²æ—¶ï¼Œæ¯å°æœºå™¨é¦–å…ˆä¼šæ‹‰å–æŒ‡å®šç‰ˆæœ¬çš„é•œåƒæ–‡ä»¶ã€‚å®‰è£…é•œåƒåäº§ç”Ÿäº†dockerå®¹å™¨ã€‚ç”±äºæ‰€æœ‰æœºå™¨çš„é•œåƒæ–‡ä»¶ä¸€æ ·ï¼Œå®¹å™¨çš„è½¯ä»¶ç‰ˆæœ¬æ•…è€Œä¸€æ ·ã€‚å³ä½¿å¼€å‘æˆ–è¿ç»´ä¸­é€”ä¿®æ”¹äº†å®¹å™¨çš„è½¯ä»¶ç‰ˆæœ¬ï¼Œä½†æ˜¯å®¹å™¨é”€æ¯æ—¶ï¼Œè½¯ä»¶çš„æ”¹åŠ¨ä¼šéšå®¹å™¨çš„é”€æ¯ä¸€èµ·æ¹®ç­ã€‚å½“åº”ç”¨ç”¨å·²æœ‰çš„é•œåƒæ–‡ä»¶é‡æ–°éƒ¨ç½²æ—¶ï¼Œç”Ÿæˆçš„dockerå®¹å™¨è·Ÿä¿®æ”¹ä¹‹å‰çš„å®¹å™¨å®Œå…¨ä¸€æ ·ã€‚è¿™ä¹Ÿæ˜¯Infrastructure as codeæ€æƒ³å¸¦æ¥çš„å¥½å¤„ã€‚\nâ€ƒâ€ƒå®¹å™¨å¦‚æœè¦å‡çº§è½¯ä»¶ç‰ˆæœ¬ï¼Œé‚£å°±ä¿®æ”¹é•œåƒæ–‡ä»¶ã€‚è¿™æ ·éƒ¨ç½²æ—¶é›†ç¾¤å†…æ‰€æœ‰çš„æœºå™¨é‡æ–°æ‹‰å–æ–°çš„é•œåƒï¼Œè½¯ä»¶å› æ­¤è·Ÿç€ä¸€èµ·å‡çº§ã€‚è½¯ä»¶ç‰ˆæœ¬æ··ä¹±çš„é—®é¢˜ï¼Œåˆ°dockerè¿™é‡Œï¼Œä¹Ÿå°±å¾—åˆ°äº†å®Œç¾çš„è§£å†³ã€‚\nä¸€ä¸ªç–‘é—®ï¼šæœ‰äº†å®¹å™¨æŠ€æœ¯ï¼Œç”Ÿäº§ç¯å¢ƒä¸ºä½•è¿˜éœ€è¦éƒ¨ç½²è™šæ‹Ÿæœºï¼Ÿ\nè™šæ‹Ÿæœºèƒ½åšåˆ°ç¡¬ä»¶èµ„æºçš„å½»åº•éš”ç¦»ï¼Œdockerä¸è¡Œã€‚è™šæ‹Ÿæœº å’Œ dockerå„å–é•¿å¤„ï¼Œæœ€ä½³CPã€‚\nå®‰è£…dockerè§£å†³å›½å†…Dockeré•œåƒé—®é¢˜ç”±äº2024å¹´6æœˆå¼€å§‹å›½å†…çš„å¤§é‡dockeré•œåƒåœæœğŸ˜¤ï¼ŒDockeræ— æ³•ä¸‹è½½å®‰è£…ğŸ˜­æ­¤ä»“åº“è‡´åŠ›äºè§£å†³å›½å†…ç½‘ç»œåŸå› æ— æ³•ä½¿ç”¨Dockerçš„é—®é¢˜ä½¿ç”¨Github Actionå°†å®˜ç½‘çš„å®‰è£…è„šæœ¬&#x2F;å®‰è£…åŒ…å®šæ—¶ä¸‹è½½åˆ°æœ¬é¡¹ç›®Releaseï¼Œä¾›å›½å†…ä½¿ç”¨å®˜æ–¹å®‰è£…åŒ…ï¼Œå®‰å…¨å¯é æ¯å¤©è‡ªåŠ¨å®šæ—¶åŒæ­¥ï¼Œä¿è¯æœ€æ–°ä½œè€…ï¼šæŠ€æœ¯çˆ¬çˆ¬è™¾Bç«™ï¼ŒæŠ–éŸ³ï¼ŒYoutubeå…¨ç½‘åŒåï¼Œè½¬è½½è¯·æ³¨æ˜ä½œè€…\nLinuxsudo curl -fsSL https://get.docker.com| bash -s docker --mirror Aliyun #ä¸€é”®å®‰è£…å‘½ä»¤sudo curl -fsSL https://github.com/tech-shrimp/docker_installer/releases/download/latest/linux.sh| bash -s docker --mirror Aliyun# å¤‡ç”¨å‘½ä»¤ï¼ˆæ¯å¤©è‡ªåŠ¨ä»å®˜ç½‘å®šæ—¶åŒæ­¥ï¼‰sudo curl -fsSL https://gitee.com/tech-shrimp/docker_installer/releases/download/latest/linux.sh| bash -s docker --mirror Aliyun# å¤‡ç”¨2 ï¼ˆå¦‚æœgithubè®¿é—®ä¸äº†ï¼Œå¯ä»¥ä½¿ç”¨giteeçš„é“¾æ¥ï¼‰sudo service docker start #å¯åŠ¨Docker\n\nCentoså®‰è£…dockerCentOS 7æˆ–æ›´é«˜ç‰ˆæœ¬å¿…é¡»å¯ç”¨CentOS Extraså­˜å‚¨åº“ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œæ­¤å­˜å‚¨åº“å·²å¯ç”¨ï¼Œä½†å¦‚æœå·²ç¦ç”¨ï¼Œåˆ™éœ€è¦ é‡æ–°å¯ç”¨å®ƒã€‚å»ºè®®ä½¿ç”¨overlay2å­˜å‚¨é©±åŠ¨ç¨‹åºã€‚å¦‚æœä»¥å‰å®‰è£…çš„è€ç‰ˆæœ¬ï¼ˆDockeråç§°æ˜¯dockeræˆ–docker-engineï¼‰è¯·å…ˆåˆ é™¤\ncentOSsudo yum remove docker \\docker-client \\docker-client-latest \\docker-common \\docker-latest \\docker-latest-logrotate \\docker-logrotate \\docker-engine\nä¸Šè¿°æ“ä½œåªä¼šåˆ é™¤dockeræœ¬èº«ï¼Œä½†è€ç‰ˆæœ¬ä¿å­˜åœ¨&#x2F;var&#x2F;lib&#x2F;docker&#x2F;çš„å†…å®¹ï¼ŒåŒ…æ‹¬é•œåƒã€å®¹å™¨ã€å·å’Œç½‘ç»œéœ€è¦æ‰‹åŠ¨åˆ é™¤ã€‚\nå®‰è£…æ–¹å¼1.è„šæœ¬å®‰è£…(å¤šç”¨äºæµ‹è¯•å’Œå¼€å‘ç¯å¢ƒ)\ncentOScurl -fsSL https://get.docker.com -o get-docker.shsudo sh get-docker.sh\n\n2.ä½¿ç”¨ä»“åº“å®‰è£…(æ¨è)2.1è®¾ç½®dockerä»“åº“\ncentOSsudo yum install -y yum-utils \\device-mapper-persistent-datalvm2sudo yum-config-manager \\--add-repo \\https://download.docker.com/linux/centos/docker-ce.repo\n2.2å®‰è£…docker CE\ncentOSsudo yum install docker-ce docker-ce-cli container.io # å®‰è£…æœ€æ–°çš„Docker CEç‰ˆæœ¬yum list docker-ce --showduplicates | sort -rsudo yum install docker-ce-&lt;VERSION_STRING&gt; docker-ce-cli-&lt;VERSION_STRING&gt; container.io#è¯´æ˜ï¼š&lt;VERSION_STRING&gt;ï¼Œå–ä¸Šå›¾ä¸­ç¬¬äºŒåˆ—ä¸­çš„ç¬¬ä¸€ä¸ªï¼šæˆ–ç¬¬ä¸€ä¸ªæ•°å­—åˆ°-ä¹‹é—´çš„å­—ç¬¦ä¸²ï¼Œå¦‚18.09.6ã€18.06.2.ceç­‰ã€‚\n\n3.ä½¿ç”¨RPMç¨‹åºåŒ…å®‰è£…ï¼ˆé€‚ç”¨äºæ²¡æœ‰äº’è”ç½‘æ¥å…¥çš„æƒ…å†µï¼‰3.1ä¸‹è½½æ‰€éœ€è¦çš„Dockerç‰ˆæœ¬ä¸‹è½½åœ°å€ï¼š https://download.docker.com/linux/centos/7/x86_64/stable/Packages/\ncentOSsudo yum install /path/to/package.rpm# å…¶ä¸­/path/to/package.rpm,ä¸ºä½ ä¸‹è½½ä¸‹æ¥çš„rpmåŒ…æ‰€åœ¨ä½ç½®å’Œæ–‡ä»¶åç§°sudo systemctl start docker# å¯åŠ¨Dockersudo docker run hello-world# éªŒè¯å®‰è£…æ˜¯å¦æ­£ç¡®\næ›´å¤šä¿¡æ¯: Centoså®‰è£…docker\nUbuntuå®‰è£…dockerDocker éœ€è¦åœ¨64ä½ç‰ˆæœ¬çš„Ubuntuä¸Šå®‰è£…ã€‚æ­¤å¤–ï¼Œä½ è¿˜éœ€è¦ä¿è¯ä½ çš„ Ubuntu å†…æ ¸çš„æœ€å°ç‰ˆæœ¬ä¸ä½äº 3.10ï¼Œå…¶ä¸­3.10 å°ç‰ˆæœ¬å’Œæ›´æ–°ç»´æŠ¤ç‰ˆä¹Ÿæ˜¯å¯ä»¥ä½¿ç”¨çš„ã€‚\nUbuntuuname -r 3.11.0-15-generic\n\nUbuntuwhich wget # æŸ¥çœ‹ä½ æ˜¯å¦å®‰è£…äº†wgetsudo apt-get update sudo apt-get install wget # å¦‚æœwgetæ²¡æœ‰å®‰è£…ï¼Œå…ˆå‡çº§åŒ…ç®¡ç†å™¨ï¼Œç„¶åå†å®‰è£…å®ƒã€‚wget -qO- https://get.docker.com/ | sh  # è·å–æœ€æ–°ç‰ˆæœ¬çš„ Docker å®‰è£…åŒ…sudo docker run hello-world  # éªŒè¯ Docker æ˜¯å¦è¢«æ­£ç¡®çš„å®‰è£… # ä¸Šè¾¹çš„å‘½ä»¤ä¼šä¸‹è½½ä¸€ä¸ªæµ‹è¯•é•œåƒï¼Œå¹¶åœ¨å®¹å™¨å†…è¿è¡Œè¿™ä¸ªé•œåƒ\næ›´å¤šä¿¡æ¯: Ubuntuå®‰è£…docker\nMacoså®‰è£…dockerHomebrew çš„ Cask å·²ç»æ”¯æŒ Docker for Mac\nMacosbrew cask install docker\nåœ¨è½½å…¥ Docker app åï¼Œç‚¹å‡» Nextï¼Œå¯èƒ½ä¼šè¯¢é—®ä½ çš„ macOS ç™»é™†å¯†ç ï¼Œä½ è¾“å…¥å³å¯ã€‚ä¹‹åä¼šå¼¹å‡ºä¸€ä¸ª Docker è¿è¡Œçš„æç¤ºçª—å£ï¼ŒçŠ¶æ€æ ä¸Šä¹Ÿæœ‰æœ‰ä¸ªå°é²¸é±¼çš„å›¾æ ‡ï¼ˆï¼‰ã€‚\næ›´å¤šä¿¡æ¯: Macosaå®‰è£…docker\nä½¿ç”¨dockerPullé•œåƒæ–¹æ¡ˆä¸€ è½¬å­˜åˆ°é˜¿é‡Œäº‘ä½¿ç”¨github Actionå°†å›½å¤–çš„Dockeré•œåƒè½¬å­˜åˆ°é˜¿é‡Œäº‘ç§æœ‰ä»“åº“ï¼Œä¾›å›½å†…æœåŠ¡å™¨ä½¿ç”¨ï¼Œå…è´¹æ˜“ç”¨æ”¯æŒDockerHub, gcr.io, k8s.io, ghcr.ioç­‰ä»»æ„ä»“åº“æ”¯æŒæœ€å¤§40GBçš„å¤§å‹é•œåƒä½¿ç”¨é˜¿é‡Œäº‘çš„å®˜æ–¹çº¿è·¯ï¼Œé€Ÿåº¦å¿«é¡¹ç›®åœ°å€: Github\næ–¹æ¡ˆäºŒ é•œåƒç«™ç°åœ¨åªæœ‰å¾ˆå°‘çš„å›½å†…é•œåƒç«™å­˜æ´»ä¸ä¿è¯é•œåƒé½å…¨,ä¸”ç”¨ä¸”çæƒœä»¥ä¸‹ä¸‰ä¸ªé•œåƒç«™èƒŒé è¾ƒå¤§çš„å¼€æºé¡¹ç›®ï¼Œä¼˜å…ˆæ¨è\n\n\n\né¡¹ç›®åç§°\né¡¹ç›®åœ°å€\nåŠ é€Ÿåœ°å€\n\n\n\n1Panel\nhttps://github.com/1Panel-dev/1Panel/\nhttps://docker.1panel.live\n\n\nDaocloud\nhttps://github.com/DaoCloud/public-image-mirror\nhttps://docker.m.daocloud.io\n\n\nè€—å­é¢æ¿\nhttps://github.com/TheTNB/panel\nhttps://hub.rat.dev\n\n\nlinuxé…ç½®é•œåƒç«™\nLinuxsudo vi /etc/docker/daemon.json #åˆ›å»º/æ‰“å¼€daemonæ–‡ä»¶&#123;    &quot;registry-mirrors&quot;: [        &quot;https://docker.m.daocloud.io&quot;,        &quot;https://docker.1panel.live&quot;,        &quot;https://hub.rat.dev&quot;    ]&#125;# è¾“å…¥ä»¥ä¸Šå†…å®¹ï¼ŒviæŒ‰escï¼Œè¾“å…¥:wqä¿å­˜  nanoè¾“å…¥ctrl+xä¿å­˜é€€å‡ºsudo service docker restart # é‡å¯docker\n\næ–¹æ¡ˆä¸‰ ç¦»çº¿é•œåƒä½¿ç”¨Github Actionä¸‹è½½dockerç¦»çº¿é•œåƒ https://github.com/wukongdaily/DockerTarBuilder\næ–¹æ¡ˆå›› ä½¿ç”¨ä¸€é”®è„šæœ¬dockerbash -c &quot;$(curl -sSLf https://xy.ggbond.org/xy/docker_pull.sh)&quot; -s å®Œæ•´é•œåƒå\næ–¹æ¡ˆäº” ä½¿ç”¨Cloudflare worker è‡ªå»ºé•œåƒåŠ é€Ÿhttps://github.com/cmliu/CF-Workers-docker.io\nå»å“ªé‡Œæ‰¾é•œåƒhttps://docker.fxxk.dedyn.io/\næ›´å¤šä¿¡æ¯: Github Action\nå¸¸ç”¨çš„æ“ä½œå‘½ä»¤ğŸ§± é•œåƒç›¸å…³å‘½ä»¤\n\n\nå‘½ä»¤\nä½œç”¨\n\n\n\ndocker images\næŸ¥çœ‹æœ¬åœ°å·²æœ‰é•œåƒ\n\n\ndocker pull é•œåƒå[:tag]\nä»è¿œç¨‹ä»“åº“æ‹‰å–é•œåƒï¼Œä¾‹å¦‚ï¼šnginx:latest\n\n\ndocker rmi é•œåƒID&#x2F;å\nåˆ é™¤æœ¬åœ°é•œåƒ\n\n\ndocker build -t é•œåƒå .\né€šè¿‡ Dockerfile æ„å»ºé•œåƒ\n\n\ndocker tag åŸå æ–°å\né‡å‘½åé•œåƒæ ‡ç­¾ï¼Œä¾‹å¦‚ï¼šmynginx:v1\n\n\ndocker save -o xx.tar é•œåƒå\nå¯¼å‡ºé•œåƒä¸ºå‹ç¼©åŒ…\n\n\ndocker load -i xx.tar\nå¯¼å…¥å‹ç¼©é•œåƒæ–‡ä»¶\n\n\nğŸš€ å®¹å™¨è¿è¡Œä¸ç®¡ç†å‘½ä»¤\n\n\nå‘½ä»¤\nä½œç”¨\n\n\n\ndocker ps\næŸ¥çœ‹æ­£åœ¨è¿è¡Œçš„å®¹å™¨\n\n\ndocker ps -a\næŸ¥çœ‹æ‰€æœ‰å®¹å™¨ï¼ˆåŒ…æ‹¬å·²åœæ­¢ï¼‰\n\n\ndocker run é•œåƒå\nå¯åŠ¨å®¹å™¨ï¼Œé»˜è®¤åå°è¿è¡Œä¸€æ¬¡å³åœ\n\n\ndocker run -it é•œåƒå &#x2F;bin&#x2F;bash\nå¯åŠ¨å®¹å™¨å¹¶è¿›å…¥äº¤äº’æ¨¡å¼\n\n\ndocker run -d é•œåƒå\nåå°è¿è¡Œå®¹å™¨ï¼ˆdetachedï¼‰\n\n\ndocker run -p å®¿ä¸»ç«¯å£:å®¹å™¨ç«¯å£ é•œåƒå\nç«¯å£æ˜ å°„ï¼Œä¾‹å¦‚ï¼š-p 8080:80\n\n\ndocker run -v å®¿ä¸»è·¯å¾„:å®¹å™¨è·¯å¾„ é•œåƒå\næŒ‚è½½ç›®å½•ï¼Œä¾‹å¦‚ï¼š-v &#x2F;mydata:&#x2F;data\n\n\ndocker start&#x2F;stop&#x2F;restart å®¹å™¨ID\nå¯åŠ¨ &#x2F; åœæ­¢ &#x2F; é‡å¯å®¹å™¨\n\n\ndocker exec -it å®¹å™¨ID bash\nè¿›å…¥å®¹å™¨äº¤äº’ç»ˆç«¯ï¼ˆæ¨èï¼‰\n\n\ndocker logs å®¹å™¨ID\næŸ¥çœ‹å®¹å™¨æ—¥å¿—\n\n\ndocker rm å®¹å™¨ID\nåˆ é™¤å®¹å™¨\n\n\ndocker rm $(docker ps -aq)\nåˆ é™¤æ‰€æœ‰å®¹å™¨ï¼ˆå°å¿ƒä½¿ç”¨ï¼‰\n\n\nğŸ“¦ æ•°æ®å·ï¼ˆVolumeï¼‰ç›¸å…³å‘½ä»¤\n\n\nå‘½ä»¤\nä½œç”¨\n\n\n\ndocker volume ls\næŸ¥çœ‹æ‰€æœ‰æ•°æ®å·\n\n\ndocker volume create åå­—\nåˆ›å»ºæ•°æ®å·\n\n\ndocker volume inspect åå­—\næŸ¥çœ‹æ•°æ®å·è¯¦ç»†ä¿¡æ¯\n\n\ndocker volume rm åå­—\nåˆ é™¤æ•°æ®å·ï¼ˆéœ€å…ˆå¸è½½ï¼‰\n\n\nğŸŒ ç½‘ç»œç›¸å…³å‘½ä»¤\n\n\nå‘½ä»¤\nä½œç”¨\n\n\n\ndocker network ls\næŸ¥çœ‹ç½‘ç»œ\n\n\ndocker network create åå­—\nåˆ›å»ºç½‘ç»œ\n\n\ndocker network inspect åå­—\næŸ¥çœ‹ç½‘ç»œè¯¦æƒ…\n\n\ndocker network connect ç½‘ç»œå å®¹å™¨å\nå°†å®¹å™¨åŠ å…¥æŸä¸ªç½‘ç»œ\n\n\ndocker run â€“network ç½‘ç»œå é•œåƒ\nå¯åŠ¨æ—¶æŒ‡å®šç½‘ç»œ\n\n\nğŸ›  å…¶ä»–å¸¸ç”¨å‘½ä»¤\n\n\nå‘½ä»¤\nä½œç”¨\n\n\n\ndocker info\næŸ¥çœ‹ Docker ç³»ç»Ÿä¿¡æ¯\n\n\ndocker version\næŸ¥çœ‹ Docker ç‰ˆæœ¬\n\n\ndocker system df\næŸ¥çœ‹é•œåƒã€å®¹å™¨ã€æ•°æ®å·å ç”¨ç©ºé—´\n\n\ndocker system prune\næ¸…ç†æ— ç”¨èµ„æºï¼ˆæœªè¿è¡Œçš„å®¹å™¨ã€æ‚¬ç©ºé•œåƒç­‰ï¼‰\n\n\nDocker Dockerfileä¸€ã€ä»€ä¹ˆæ˜¯ Dockerfileï¼ŸDockerfile æ˜¯ä¸€å¥—â€œé£Ÿè°±â€ï¼Œå‘Šè¯‰ Docker å¦‚ä½•æ„å»ºä½ çš„é•œåƒã€‚é€šè¿‡å®ƒï¼Œä½ å¯ä»¥ï¼š    â€¢\tæŒ‡å®šç”¨å“ªä¸ªåŸºç¡€é•œåƒï¼ˆæ¯”å¦‚ Pythonã€Nodeã€Nginxï¼‰    â€¢\tå®‰è£…ä¾èµ–    â€¢\tæ‹·è´æ–‡ä»¶    â€¢\tæ‰§è¡Œå‘½ä»¤    â€¢\tè®¾ç½®è¿è¡ŒæœåŠ¡æ—¶çš„é»˜è®¤å‘½ä»¤\näºŒã€Dockerfile è¯­æ³•ç»“æ„ï¼ˆè¶…æ¸…æ™°ç‰ˆï¼‰# 1. æŒ‡å®šåŸºç¡€é•œåƒï¼ˆå¿…é¡»æœ‰ï¼‰FROM é•œåƒå[:tag]# 2. è®¾ç½®å®¹å™¨ä¸­çš„å·¥ä½œç›®å½•ï¼ˆå¯é€‰ï¼‰WORKDIR /app# 3. æ‹·è´æ–‡ä»¶åˆ°é•œåƒä¸­COPY ..# 4. å®‰è£…ä¾èµ–ï¼ˆå¯å¤šæ¡RUNï¼‰RUN å‘½ä»¤# 5. è®¾ç½®ç¯å¢ƒå˜é‡ï¼ˆå¯é€‰ï¼‰ENV å˜é‡å=å€¼# 6. è®¾ç½®å®¹å™¨å¯åŠ¨æ—¶æ‰§è¡Œçš„å‘½ä»¤CMD [&quot;å‘½ä»¤&quot;,&quot;å‚æ•°&quot;]# 7. è®¾ç½®æš´éœ²çš„ç«¯å£ï¼ˆå¯é€‰ï¼Œç”¨äºæ–‡æ¡£æå‡ï¼‰EXPOSE ç«¯å£å·\nä¸‰ã€æœ€å¸¸è§çš„è¯­å¥è¯¦è§£ + ç¤ºä¾‹\n\n\næŒ‡ä»¤\nç¤ºä¾‹\nè¯´æ˜\n\n\n\nFROM\nFROM node:18\nåŸºç¡€é•œåƒ\n\n\nWORKDIR\nWORKDIR &#x2F;app\nåˆ‡æ¢ç›®å½•ï¼ˆç±»ä¼¼ cdï¼‰\n\n\nCOPY\nCOPY . .\nå°†å½“å‰ç›®å½•å¤åˆ¶åˆ°å®¹å™¨é‡Œ\n\n\nRUN\nRUN npm install\næ„å»ºæœŸé—´æ‰§è¡Œå‘½ä»¤\n\n\nCMD\nCMD [â€œnpmâ€, â€œstartâ€]\nå®¹å™¨å¯åŠ¨æ—¶è¿è¡Œï¼ˆåªèƒ½æœ‰ä¸€æ¡ï¼‰\n\n\nEXPOSE\nEXPOSE 3000\nè¯´æ˜æœåŠ¡ç›‘å¬çš„ç«¯å£ï¼ˆä»…æ–‡æ¡£æç¤ºï¼‰\n\n\nå››ã€å®æˆ˜ç¤ºä¾‹ï¼šFlask Web AppğŸ“ é¡¹ç›®ç»“æ„ï¼š\nmy-flask-app/â”œâ”€â”€ app.pyâ”œâ”€â”€ requirements.txtâ””â”€â”€ Dockerfile\nğŸ“„ app.pyï¼š\nfrom flask import Flaskapp = Flask(__name__)@app.route(&quot;/&quot;)def home():    return &quot;Hello,Docker!&quot;if __name__ == &quot;__main__&quot;:    app.run(host=&quot;0.0.0.0&quot;,port=5000)\nğŸ“„ requirements.txtï¼š\nflask\nğŸ“„ Dockerfileï¼š\nFROM python:3.9-slimWORKDIR /appCOPY ..RUN pip install -r requirements.txtEXPOSE 5000CMD [&quot;python&quot;,&quot;app.py&quot;]\nğŸ›  æ„å»ºé•œåƒå¹¶è¿è¡Œï¼š\ndocker build -t my-flask-app .docker run -d -p 5000:5000 my-flask-app\næµè§ˆå™¨è®¿é—®ï¼šhttp://localhost:5000ğŸ‰ æˆåŠŸï¼\näº”ã€å¸¸è§é—®é¢˜ä¸æŠ€å·§\n\n\né—®é¢˜\nåŸå› ä¸è§£å†³æ–¹å¼\n\n\n\nå®¹å™¨è¿è¡Œåé©¬ä¸Šé€€å‡º\nCMD å†™é”™æˆ–æœåŠ¡æ²¡å¯åŠ¨\n\n\né•œåƒå¤ªå¤§\næ¢ç”¨ -slimã€-alpine é•œåƒ\n\n\næ–‡ä»¶æ²¡æ‹·è¿›å»\nCOPY è·¯å¾„å†™é”™ã€.dockerignore æŠŠå®ƒæ’é™¤äº†\n\n\næ„å»ºæ…¢\nç”¨ .dockerignore æ’é™¤ä¸å¿…è¦çš„æ–‡ä»¶ï¼ˆæ¯”å¦‚ node_modulesï¼‰\n\n\nå…­ã€Dockerfile å°æŠ€å·§åˆé›†# ç¼–è¯‘é˜¶æ®µFROM node:18 as buildWORKDIR /appCOPY ..RUN nom install &amp;&amp; npm run build# éƒ¨ç½²é˜¶æ®µï¼ˆnginxï¼‰FROM nginxCOPY --from=build /app/dist /usr/share/nginx/html#è®¾ç½®ç¯å¢ƒå˜é‡ENV PORT=8080\næœ€åé€ä½ ä¸€å¥å£è¯€ ğŸ§ FROM å®šåŸºç¡€ï¼ŒWORKDIR å®šä½ç½®ï¼ŒCOPY æ‹·ä»£ç ï¼ŒRUN è£…ç¯å¢ƒï¼ŒCMD å¯åŠ¨å®ƒã€‚\nDocker Composeä¸€ã€Docker Composeæ˜¯ä»€ä¹ˆï¼Ÿä»–æ˜¯ä¸€ä¸ªdocker-compose.ymlæ–‡ä»¶ï¼š    â€¢\tæè¿°å¤šä¸ªæœåŠ¡ï¼ˆæ¯”å¦‚ webã€dbã€redisï¼‰    â€¢\tæŒ‡å®šç«¯å£ã€æŒ‚è½½ã€ç½‘ç»œã€ç¯å¢ƒå˜é‡ç­‰    â€¢\tä¸€æ¡å‘½ä»¤å°±èƒ½å¯åŠ¨ï¼šdocker-compose up\näºŒã€åŸºæœ¬è¯­æ³•ç»“æ„version: &#x27;3&#x27;    #Composeæ–‡ä»¶ç‰ˆæœ¬,ä¸€èˆ¬ç”¨â€˜3â€™æˆ–â€˜3.8â€™services:       #å®šä¹‰æ‰€æœ‰å®¹å™¨æœåŠ¡    æœåŠ¡å1:        image: é•œåƒå æˆ– buldè·¯å¾„        ports:            - &quot;æœ¬åœ°ç«¯å£ï¼šå®¹å™¨ç«¯å£&quot;        volumes:            - &quot;æœ¬åœ°è·¯å¾„ï¼šå®¹å™¨è·¯å¾„&quot;        environment:            - &quot;å˜é‡å=å€¼&quot;        depends_on:            - å…¶ä»–æœåŠ¡åï¼ˆå¯åŠ¨é¡ºåºï¼‰    æœåŠ¡å2:        ....\nä¸‰ã€æœ€ç®€å•ç¤ºä¾‹ï¼šéƒ¨ç½²ä¸€ä¸ªå¸¦è‡ªå®šä¹‰æŒ‚è½½çš„ Nginxmy-compose-project/â”œâ”€â”€ docker-compose.ymlâ”œâ”€â”€ html/â”‚   â””â”€â”€ index.htmlâ””â”€â”€ nginx.conf\nğŸ“„ docker-compose.yml å†…å®¹ï¼š\nversion: &#x27;3&#x27;services:  web:    image: nginx    ports:      - &quot;8080:80&quot;    volumes:      - ./html:/usr/share/nginx/html:ro      - ./nginx.conf:/etc/nginx/nginx.conf:ro\nğŸ“Œè¯´æ˜ï¼š    â€¢\tç«¯å£æ˜ å°„ï¼š8080 â†’ å®¹å™¨å†…80    â€¢\tæŒ‚è½½æœ¬åœ° .&#x2F;html åˆ° nginx çš„ç½‘é¡µæ ¹ç›®å½•    â€¢\tæŒ‚è½½æœ¬åœ°é…ç½®æ–‡ä»¶æ›¿æ¢é»˜è®¤ nginx é…ç½®âœ… å¯åŠ¨ï¼š\nUbuntudocker-compose up -d # æˆ–è€… docker compose up -d\nâœ… åœæ­¢ï¼š\nUbuntudocker-compose down -v # æˆ–è€… docker compose down -v\nå››ã€å¤šæœåŠ¡ç»„åˆç¤ºä¾‹ï¼ˆNode.js + MongoDBï¼‰version: &#x27;3&#x27;services:    app:        build: .        ports:            - &quot;3000:3000&quot;        environment:            - MONGO_URL=mongodb://mongo:27017/mydb        depends_on:            - mongo        mongo:        image: mongo        ports:            - &quot;27017:27017&quot;\nğŸ“Œè¯´æ˜ï¼š    â€¢\tapp æœåŠ¡ç”¨ Dockerfile æ„å»º    â€¢\tä¾èµ– Mongo å®¹å™¨ï¼Œå¹¶é€šè¿‡æœåŠ¡å mongo è¿›è¡Œè¿æ¥\näº”ã€å¸¸è§å­—æ®µè¯´æ˜ï¼ˆé€‚åˆè®°ä½ï¼‰\n\n\nå­—æ®µ\nç”¨æ³•\n\n\n\nimage:\nä½¿ç”¨å·²æœ‰é•œåƒ\n\n\nbuild:\nç”¨ Dockerfile æ„å»ºé•œåƒ\n\n\nports:\næœ¬åœ°ç«¯å£:å®¹å™¨ç«¯å£\n\n\nvolumes:\næœ¬åœ°è·¯å¾„:å®¹å™¨è·¯å¾„\n\n\nenvironment:\nè®¾ç½®ç¯å¢ƒå˜é‡\n\n\ndepends_on:\nè®¾ç½®æœåŠ¡å¯åŠ¨é¡ºåº\n\n\nrestart:\nå®¹å™¨å´©æºƒæ—¶æ˜¯å¦è‡ªåŠ¨é‡å¯ï¼ˆå¦‚ alwaysã€on-failureï¼‰\n\n\nnetworks:\nè®¾ç½®è‡ªå®šä¹‰ç½‘ç»œï¼ˆå¯å¤šä¸ªæœåŠ¡é€šä¿¡ï¼‰\n\n\nå…­ã€å®ç”¨å‘½ä»¤å¤§å…¨Ubuntu# å¯åŠ¨æœåŠ¡docker-compose up -d # æˆ–è€… docker compose up -d# åœæ­¢å¹¶åˆ é™¤å®¹å™¨docker-compose down # æˆ–è€… docker compose down# æŸ¥çœ‹è¿è¡Œæ—¥å¿—docker-compose logs # æˆ–è€… docker compose logs# æŸ¥çœ‹æœåŠ¡çŠ¶æ€docker-compose ps # æˆ–è€… docker compose ps# è¿›å…¥å®¹å™¨docker-compose exec æœåŠ¡å bash # æˆ–è€… docker compose exec æœåŠ¡å bash\n\n\n","categories":["æœåŠ¡ç«¯","docker"],"tags":["æœåŠ¡ç«¯","docker"]},{"title":"Prometheus+Grafana","url":"/2025/03/30/moniter/","content":"ç®€ä»‹ğŸ” Prometheus æ˜¯ä»€ä¹ˆï¼ŸPrometheus æ˜¯ä¸€ä¸ªâ€œç›‘æ§å’Œæ•°æ®é‡‡é›†ç³»ç»Ÿâ€ï¼Œç®€å•ç†è§£å°±æ˜¯ä¸€ä¸ªâ€œæ”¶é›†æ•°æ®çš„ä»“åº“+å¤§è„‘â€ã€‚\nğŸ“¦ å®ƒä¸»è¦åšè¿™äº›äº‹ï¼š    â€¢\té‡‡é›†æ•°æ®ï¼šæ¯”å¦‚æœåŠ¡å™¨çš„ CPU ä½¿ç”¨ç‡ã€å†…å­˜å ç”¨ã€ç½‘ç»œæµé‡ã€è¯·æ±‚æ¬¡æ•°ç­‰ã€‚    â€¢\tå­˜å‚¨æ•°æ®ï¼šæŠŠè¿™äº›æ•°æ®ä»¥æ—¶é—´åºåˆ—çš„å½¢å¼å­˜åˆ°è‡ªå·±çš„æ•°æ®åº“é‡Œã€‚    â€¢\tæŸ¥è¯¢æ•°æ®ï¼šæ”¯æŒç”¨ä¸“é—¨çš„ PromQL è¯­è¨€æŸ¥è¯¢ã€ç­›é€‰ã€èšåˆå„ç§æŒ‡æ ‡ã€‚    â€¢\tè®¾ç½®å‘Šè­¦ï¼šå¯ä»¥è®¾ç½®è§„åˆ™ï¼Œå½“æŸä¸ªæŒ‡æ ‡å¼‚å¸¸æ—¶è§¦å‘å‘Šè­¦ï¼ˆä¾‹å¦‚ CPU è¿ç»­5åˆ†é’Ÿè¶…è¿‡ 90%ï¼‰ã€‚\nğŸ‘€ ç®€å•è¯´ï¼Œå®ƒæ˜¯â€œé‡‡é›†ã€å­˜ã€æŸ¥ã€æŠ¥â€çš„ä¸€å¥—ç³»ç»Ÿï¼Œä¸è´Ÿè´£å¯è§†åŒ–ã€‚\nğŸ“Š Grafana æ˜¯ä»€ä¹ˆï¼ŸGrafana æ˜¯ä¸€ä¸ªæ•°æ®å¯è§†åŒ–å·¥å…·ï¼Œç”¨æ¥â€œæŠŠæ•°æ®å˜æˆå›¾è¡¨â€ã€‚\nğŸ¨ å®ƒä¸»è¦åšè¿™äº›äº‹ï¼š    â€¢\tè¿æ¥æ•°æ®æºï¼šæ¯”å¦‚è¿æ¥ Prometheusï¼Œè¯»å–é‡Œé¢çš„æŒ‡æ ‡æ•°æ®ã€‚    â€¢\tç»˜åˆ¶å›¾è¡¨å’Œä»ªè¡¨ç›˜ï¼šä½ å¯ä»¥ç”¨å®ƒåˆ¶ä½œæ¼‚äº®çš„å›¾ã€çº¿ã€é¥¼å›¾ã€çƒ­å›¾ç­‰å„ç§å½¢å¼ã€‚    â€¢\tè®¾ç½®ä»ªè¡¨ç›˜ï¼šå°†ä¸åŒçš„æ•°æ®ç»„åˆæˆç»Ÿä¸€çš„ç›‘æ§é¢æ¿ï¼Œä¾¿äºä¸€çœ¼çœ‹å‡ºç³»ç»Ÿå¥åº·çŠ¶å†µã€‚    â€¢\tå‘Šè­¦é€šçŸ¥ï¼šGrafana ä¹Ÿæ”¯æŒè®¾ç½®å‘Šè­¦ï¼ˆä½†æ•°æ®è¿˜æ˜¯ä» Prometheus æ¥ï¼‰ã€‚\nğŸ‘€ ç®€å•è¯´ï¼Œå®ƒæ˜¯â€œè¯»æ•° + ç”»å›¾ + å±•ç¤ºâ€çš„ä¸€å¥—ç³»ç»Ÿï¼Œä¸è´Ÿè´£é‡‡é›†å’Œå­˜å‚¨ã€‚\nå®‰è£…å®‰è£…Node Exporterï¼ˆç›‘æ§æœåŠ¡å™¨æ€§èƒ½ï¼‰Node Exporteræ˜¯Prometheusçš„å®˜æ–¹å·¥å…·ï¼Œå¯ä»¥å¸®åŠ©é‡‡é›†æœåŠ¡å™¨çš„ç¡¬ä»¶æŒ‡æ ‡ï¼ˆCPUã€å†…å­˜ã€ç£ç›˜ç­‰ï¼‰ã€‚\nUbuntussh root@ä½ çš„æœåŠ¡å™¨ipsudo useradd --no-create-home --shell /bin/false node_exporter# åˆ›å»ºnode_exporterç”¨æˆ·(å®‰å…¨èµ·è§)wget https://github.com/prometheus/node_exporter/releases/download/v1.7.0/node_exporter-1.7.0.linux-amd64.tar.gztar xvf node_exporter-1.7.0.linux-amd64.tar.gzsudo cp node_exporter-1.7.0.linux-amd64/node_exporter /usr/local/bin/# ä¸‹è½½å¹¶è§£å‹node_exportersudo nano /etc/systemd/system/node_exporter.service# è®¾ç½®systemdå¯åŠ¨æœåŠ¡\nå†™å…¥ä»¥ä¸‹å†…å®¹\nUbuntu[Unit]Description=Node ExporterAfter=network.target[Service]User=node_exporterExecStart=/usr/local/bin/node_exporter #æ–‡ä»¶è·¯å¾„[Install]WantedBy=default.target\nå¯åŠ¨å¹¶è®¾ç½®å¼€æœºå¯åŠ¨\nUbuntusudo systemctl daemon-reexecsudo systemctl start node_exportersudo systemctl enable node_exporter\næµ‹è¯•ä¸€ä¸‹ï¼šæ‰“å¼€æµè§ˆå™¨è®¿é—®ï¼šhttp:&#x2F;&#x2F;ä½ çš„æœåŠ¡å™¨IP:9100&#x2F;metricså¦‚æœèƒ½çœ‹åˆ°ä¸€å †æŒ‡æ ‡æ–‡å­—ï¼Œè¯´æ˜æˆåŠŸï¼\nå®‰è£…Prometheusä¸‹è½½Prometheusï¼š\nUbuntuwget https://github.com/prometheus/prometheus/releases/download/v2.50.0/prometheus-2.50.0.linux-amd64.tar.gztar xvf prometheus-2.50.0.linux-amd64.tar.gz # è§£å‹cd prometheus-2.50.0.linux-amd64 # è¿›å…¥æ–‡ä»¶å¤¹é‡Œé¢åˆ›å»º.ymlæ–‡ä»¶nano prometheus.yml # åˆ›å»ºprometheusé…ç½®æ–‡ä»¶\nå†™å…¥ä¸€ä¸‹å†…å®¹ï¼š\nglobal:         # ä¸€å®šè¦å†™æ­£ç¡®æ ¼å¼ï¼ŒåŒ…æ‹¬ç©ºæ ¼ä»¥åŠé‡å¤å®šä¹‰  scrape_interval: 15sscrape_configs:  - job_name: &#x27;node_exporter&#x27;    static_configs: # è¿™ä¸ªå¯èƒ½ä¼šæœ‰å†²çª       - targets: [&#x27;localhost:9100&#x27;]   - job_name: &#x27;website_http_check&#x27;    metrics_path: /probe    params:      module: [http_2xx]    static_configs:      - targets:          - http://ä½ çš„åŸŸåæˆ–è€…IP  # è¿™é‡Œå°±æ˜¯grafanaçš„ç›‘æ§é¡¹          - prometheus:9090    relabel_configs:      - source_labels: [__address__]        target_label: __param_target      - source_labels: [__param_target]        target_label: instance      - target_label: __address__        replacement: localhost:9115  # blackbox_exporter ç›‘å¬ç«¯å£\n\nå®‰è£…Blackbox Exporter(æ¢æµ‹ç½‘ç«™çŠ¶æ€)Ubuntuwget https://github.com/prometheus/blackbox_exporter/releases/download/v0.25.0/blackbox_exporter-0.25.0.linux-amd64.tar.gztar xvf blackbox_exporter-0.25.0.linux-amd64.tar.gzcd blackbox_exporter-0.25.0.linux-amd64 ./blackbox_exporter     # è¿›å…¥æ–‡ä»¶å¤¹å¯åŠ¨# ä¹Ÿå¯ä»¥æ·»åŠ systemdå¯åŠ¨æœåŠ¡ï¼Œå’Œnode_exporterç±»ä¼¼ã€‚\n\nå¯åŠ¨prometheusUbuntu./prometheus --config.file=prometheus.yml\nè®¿é—®æµè§ˆå™¨ï¼šhttp:&#x2F;&#x2F;ä½ çš„æœåŠ¡å™¨IP:9090ï¼Œä½ åº”è¯¥å¯ä»¥çœ‹åˆ° Prometheus çš„ Web é¡µé¢ã€‚\nğŸ“Šå®‰è£… Grafanasudo apt-get install -y apt-transport-https software-properties-common# å®‰è£…ä¾èµ– sudo apt-get install -y wgetwget -q -O - https://packages.grafana.com/gpg.key | sudo apt-key add -echo &quot;deb https://packages.grafana.com/oss/deb stable main&quot; | sudo tee /etc/apt/sources.list.d/grafana.listsudo apt-get update# æ·»åŠ grafanaä»“åº“sudo apt-get install grafanasudo systemctl start grafana-serversudo systemctl enable grafana-server# å®‰è£…å¹¶å¯åŠ¨grafana\nè®¿é—®grafanaï¼šæµè§ˆå™¨æ‰“å¼€ http:&#x2F;&#x2F;ä½ çš„æœåŠ¡å™¨IP:3000ï¼Œé»˜è®¤è´¦å·å¯†ç æ˜¯ï¼šç”¨æˆ·åï¼šadminå¯†ç ï¼šadmin  ç™»å½•ä¹‹åä¼šè¦æ±‚ä¿®æ”¹å¯†ç \nğŸ“ˆé…ç½® Grafanaæ·»åŠ æ•°æ®æºï¼šé€‰æ‹© Prometheusï¼Œå¡«å…¥ http://localhost:9090å¯¼å…¥ Dashboard æ¨¡æ¿ï¼šNode Exporterï¼šå¯¼å…¥æ¨¡æ¿ ID 1860Blackbox ç½‘ç«™çŠ¶æ€ï¼šå¯¼å…¥æ¨¡æ¿ ID 7587\nä½¿ç”¨grafanaæ›´æ”¹ä¸­æ–‡è¦å°†Grafanaé…ç½®ä¸ºä¸­æ–‡ï¼Œä½ å¯ä»¥å‚ç…§ä»¥ä¸‹æ­¥éª¤è¿›è¡Œæ“ä½œ\n\næ‰“å¼€grafanaçš„é»˜è®¤é…ç½®æ–‡ä»¶ï¼š&#x2F;opt&#x2F;bitnami&#x2F;grafana&#x2F;conf&#x2F;defaults.ini                   &#x2F;usr&#x2F;share&#x2F;grafana&#x2F;conf&#x2F;defaults.ini\nåœ¨è¯¥æ–‡ä»¶ä¸­ï¼Œæ‰¾åˆ°default_languageè¿™ä¸€è¡Œï¼Œå°†en-USæ”¹ä¸ºzh-Hansã€‚è¿™æ ·grafanaçš„è¯­è¨€å°±ä¼šæ›´æ”¹ä¸ºä¸­æ–‡ã€‚\nä¿å­˜å¹¶å…³é—­æ–‡ä»¶\nå¯æœåŠ¡åˆ·æ–°ç½‘é¡µå³å¯systemctl restart grafana-server\n\nç›‘æ§å‘Šè­¦ğŸ› ï¸ è®¾ç½® Prometheus å‘Šè­¦è§„åˆ™Prometheus æ”¯æŒåŸºäºæŸ¥è¯¢çš„å‘Šè­¦è§„åˆ™ï¼Œä½ å¯ä»¥é€šè¿‡ PromQL è®¾ç½®æ¡ä»¶ï¼Œæ¯”å¦‚å½“ç³»ç»Ÿè´Ÿè½½è¿‡é«˜æ—¶å‘å‡ºå‘Šè­¦ã€‚\n\nåˆ›å»ºå‘Šè­¦è§„åˆ™æ–‡ä»¶åœ¨ Prometheus é…ç½®ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ª alert.rules æ–‡ä»¶ï¼ˆå¦‚æœæ²¡æœ‰çš„è¯ï¼‰ï¼šUbuntunano /etc/prometheus/alert.rules # çœ‹ä½ prometheuså®‰è£…/è§£å‹åˆ°äº†å“ªé‡Œ\nåœ¨æ–‡ä»¶ä¸­åŠ å…¥å‘Šè­¦è§„åˆ™ï¼Œä¾‹å¦‚ï¼šgroups:  - name: node_alerts    rules:    - alert: HighCPUUsage       expr: 100 * (1 - avg by (instance) (rate(node_cpu_seconds_total&#123;mode=&quot;idle&quot;&#125;[1m]))) &gt; 80      for: 5m      labels:        severity: critical      annotations:        summary: &quot;CPU usage is above 80% on &#123;&#123; $labels.instance &#125;&#125;&quot;        description: &quot;CPU usage is above 80% for 5 minutes on &#123;&#123; $labels.instance &#125;&#125;.&quot;            - alert: HighLoadAverage      expr: node_load1 &gt; 2      for: 5m      labels:        severity: critical      annotations:        summary: &quot;High load average on &#123;&#123; $labels.instance &#125;&#125;&quot;        description: &quot;The 1-minute load average is above 2 on &#123;&#123; $labels.instance &#125;&#125;.&quot;\nHighCPUUsageï¼šå½“ CPU ä½¿ç”¨ç‡è¶…è¿‡ 80% æŒç»­ 5 åˆ†é’Ÿæ—¶ï¼Œè§¦å‘å‘Šè­¦ã€‚HighLoadAverageï¼šå½“ç³»ç»Ÿ 1 åˆ†é’Ÿå¹³å‡è´Ÿè½½è¶…è¿‡ 2 æ—¶ï¼Œè§¦å‘å‘Šè­¦ã€‚\nä¿®æ”¹ Prometheus é…ç½®æ–‡ä»¶ï¼ŒåŠ è½½å‘Šè­¦è§„åˆ™ç¼–è¾‘ Prometheus é…ç½®æ–‡ä»¶ prometheus.ymlï¼ŒåŠ å…¥è§„åˆ™æ–‡ä»¶ï¼šUbunturule_files:  - &quot;/etc/prometheus/alert.rules&quot;\né‡æ–°å¯åŠ¨ Prometheus\n\nä¿®æ”¹å®Œé…ç½®åï¼Œé‡æ–°å¯åŠ¨ Prometheus æœåŠ¡æ¥åº”ç”¨å‘Šè­¦è§„åˆ™ï¼š\nsudo systemctl restart prometheus\nğŸ› ï¸é…ç½® Grafana å‘Šè­¦é€šçŸ¥ä¸€æ—¦ Prometheus è®¾ç½®äº†å‘Šè­¦è§„åˆ™ï¼Œä½ å°±å¯ä»¥åœ¨ Grafana ä¸­æŸ¥çœ‹å‘Šè­¦å¹¶è®¾ç½®é€šçŸ¥ã€‚\n\nè®¾ç½®é€šçŸ¥æ¸ é“\n\né¦–å…ˆéœ€è¦åœ¨ Grafana é…ç½®ä¸€ä¸ªé€šçŸ¥æ¸ é“ï¼Œå¸¸ç”¨çš„æœ‰ é‚®ä»¶ã€é’‰é’‰ã€Slack ç­‰ã€‚\né…ç½®é‚®ä»¶é€šçŸ¥    1.\tæ‰“å¼€ Grafana UIï¼Œè¿›å…¥ â€œAlertingâ€ &gt; â€œNotification channelsâ€ã€‚    2.\tç‚¹å‡» â€œAdd channelâ€ã€‚    3.\té€‰æ‹©é€šçŸ¥æ–¹å¼ï¼ˆæ¯”å¦‚ Emailï¼‰å¹¶å¡«å†™ç›¸å…³ä¿¡æ¯ï¼š    â€¢\tEmail Addressï¼šæ”¶ä»¶äººé‚®ç®±    â€¢\tSMTPï¼šé…ç½®å‘é€é‚®ä»¶çš„ SMTP æœåŠ¡ï¼ˆå¦‚ Gmail æˆ–è‡ªå·±é…ç½®çš„ SMTPï¼‰\né…ç½®é’‰é’‰&#x2F;Slack é€šçŸ¥\nä½ å¯ä»¥é€‰æ‹©ä½¿ç”¨é’‰é’‰æˆ– Slack çš„ Webhookï¼Œæ­¥éª¤ç±»ä¼¼ï¼Œç›´æ¥å¡«å†™ Webhook URLã€‚\n\né…ç½®å‘Šè­¦è§„åˆ™\n\nåœ¨ Grafana ä¸­ï¼Œè¿›å…¥ä½ è¦ç›‘æ§çš„ Dashboardï¼Œå¹¶è¿›è¡Œå‘Šè­¦è®¾ç½®ï¼š    1.\tæ‰“å¼€éœ€è¦è®¾ç½®å‘Šè­¦çš„å›¾è¡¨ï¼Œç‚¹å‡»å›¾è¡¨å³ä¸Šè§’çš„ â€œAlertâ€ æ ‡ç­¾ã€‚    2.\té…ç½®å‘Šè­¦æ¡ä»¶ï¼Œæ¯”å¦‚ï¼š    â€¢\tå½“ç³»ç»Ÿè´Ÿè½½è¶…è¿‡æŸä¸ªé˜ˆå€¼ã€‚    â€¢\té…ç½®å‘Šè­¦æ—¶é—´ï¼ˆæ¯”å¦‚ 5 åˆ†é’Ÿå†…è§¦å‘ï¼‰ã€‚    3.\tåœ¨ â€œNotificationsâ€ éƒ¨åˆ†ï¼Œé€‰æ‹©ä¹‹å‰é…ç½®å¥½çš„é€šçŸ¥æ¸ é“ï¼ˆæ¯”å¦‚ Emailã€é’‰é’‰ç­‰ï¼‰ã€‚\n\nä¿å­˜å‘Šè­¦è®¾ç½®\n\nè®¾ç½®å®Œæˆåï¼Œç‚¹å‡» â€œSaveâ€ æ¥ä¿å­˜å‘Šè­¦è§„åˆ™ã€‚Grafana ä¼šæ ¹æ®ä½ è®¾ç½®çš„æ¡ä»¶ï¼Œå®šæœŸæ£€æŸ¥ï¼Œå¹¶åœ¨è§¦å‘å‘Šè­¦æ—¶é€šè¿‡é‚®ä»¶æˆ–é’‰é’‰ç­‰æ¸ é“å‘é€é€šçŸ¥ã€‚\nğŸ§‘â€ğŸ’»éªŒè¯å‘Šè­¦æ˜¯å¦æœ‰æ•ˆ\nè¦è®© Grafana èƒ½é€šè¿‡ SMTP å‘é€é‚®ä»¶å‘Šè­¦é€šçŸ¥ï¼Œä½ éœ€è¦é…ç½®å®ƒçš„ smtp é‚®ä»¶å‘é€æœåŠ¡ã€‚ä»¥Gmailä¸ºä¾‹\n\n\n\n\né…ç½®é¡¹\nç¤ºä¾‹ï¼ˆä»¥ Gmail ä¸ºä¾‹ï¼‰\n\n\n\nSMTP æœåŠ¡å™¨åœ°å€\nsmtp.gmail.com\n\n\nç«¯å£å·\n587 (TLS) &#x2F; 465 (SSL)\n\n\nå‘ä»¶é‚®ç®±\n&#121;&#111;&#x75;&#x72;&#110;&#97;&#109;&#101;&#64;&#103;&#109;&#x61;&#105;&#108;&#46;&#99;&#111;&#x6d;\n\n\nå‘ä»¶é‚®ç®±å¯†ç \nGmail ç”Ÿæˆçš„â€œåº”ç”¨ä¸“ç”¨å¯†ç â€\n\n\næ¥æ”¶äººé‚®ç®±\nä»»æ„ä½ æƒ³æ”¶åˆ°å‘Šè­¦çš„äººé‚®ç®±åœ°å€\n\n\n\nä¿®æ”¹ Grafana é…ç½®æ–‡ä»¶ grafana.inié»˜è®¤è·¯å¾„é€šå¸¸æ˜¯ï¼šnano /etc/grafana/grafana.ini\næ‰¾åˆ°ä»¥ä¸‹é…ç½®æ®µè½ï¼ŒæŠŠå®ƒä¿®æ”¹æˆä½ çš„ä¿¡æ¯ï¼ˆæ³¨æ„å–æ¶ˆæ³¨é‡Šï¼‰ï¼š#################################### SMTP / Emailing ##########################[smtp]enabled = truehost = smtp.gmail.com:587user = yourname@gmail.compassword = your_app_password   ; # Gmail éœ€è¦ä½¿ç”¨â€œåº”ç”¨ä¸“ç”¨å¯†ç â€è€Œä¸æ˜¯ç™»å½•å¯†ç ;cert_file =;key_file =skip_verify = falsefrom_address = yourname@gmail.comfrom_name = Grafana Monitor[emails];welcome_email_on_sign_up = false\nğŸ’¡å¦‚æœä½ ä½¿ç”¨çš„æ˜¯ QQ é‚®ç®±ã€é˜¿é‡Œé‚®ç®±ã€163 ç­‰éƒ½å¯ä»¥ï¼Œæ”¹ä¸‹ hostã€ç«¯å£ã€å¯†ç å³å¯\nğŸ” å…³äº Gmail çš„â€œåº”ç”¨ä¸“ç”¨å¯†ç â€ï¼š\n   ç™»å½•ä½ çš„ Gmail è´¦å·\n   æ‰“å¼€ï¼š https://myaccount.google.com/security\n   å¼€å¯ ä¸¤æ­¥éªŒè¯\n   æ‰¾åˆ°â€œåº”ç”¨ä¸“ç”¨å¯†ç â€ï¼Œåˆ›å»ºä¸€ä¸ªå¯†ç ç”¨äº Grafana å‘é€é‚®ä»¶\n   æ‹·è´è¯¥å¯†ç ï¼Œè´´åˆ°ä¸Šé¢ password ä¸€æ ä¸­\n\n\nğŸ”„é‡å¯ Grafana æœåŠ¡é…ç½®æ”¹å¥½ä¹‹åéœ€è¦é‡å¯ Grafana æ‰èƒ½ç”Ÿæ•ˆï¼šsudo systemctl restart grafana-server\nâœ‰ï¸åœ¨ Grafana ä¸­æµ‹è¯•å‘é€é‚®ä»¶\n   ç™»å½• Grafana â†’ å·¦ä¾§ç‚¹å‡» â€œAlertingâ€ â†’ â€œContact pointsâ€\n   åˆ›å»ºä¸€ä¸ªæ–°çš„ Email é€šçŸ¥æ–¹å¼\n   è¾“å…¥ä½ å¸Œæœ›æ¥æ”¶å‘Šè­¦çš„é‚®ç®±åœ°å€\n   ä¿å­˜åç‚¹å‡» â€œSend test notificationâ€ æ¥éªŒè¯æ˜¯å¦èƒ½æ”¶åˆ°é‚®ä»¶\n\n\n\nâœ… å¦‚æœè®¾ç½®æˆåŠŸï¼Œä½ åº”è¯¥ä¼šåœ¨é‚®ç®±é‡Œçœ‹åˆ°ä¸€ä¸ªæµ‹è¯•é‚®ä»¶ï¼\nğŸ‰ å®Œæˆï¼\nDocker éƒ¨ç½²æˆ‘ä»¬å¦‚æœè¦ç”¨dockeréƒ¨ç½²çš„è¯ éœ€è¦é¢å¤–ä¸‹è½½ä¸€ä¸ªç»„ä»¶ â€œnginx-prometheus-exporterâ€ å› ä¸ºdockerçš„å®¹å™¨æœ‰éš”ç¦»æœºåˆ¶ å› æ­¤æˆ‘ä»¬éœ€è¦è¿™ä¸ªnginxå®¹å™¨æš´éœ²å‡ºæ¥çš„ stub_status  é¡µé¢\n\n\n\nç»„ä»¶å\nä½œç”¨è¯´æ˜\né•œåƒåç§°ï¼ˆDocker Hubï¼‰\nå¤‡æ³¨\n\n\n\nPrometheus\nç›‘æ§æ•°æ®é‡‡é›†å’Œå­˜å‚¨\nprom&#x2F;prometheus\né‡‡é›† nginx-exporterã€node-exporterã€blackbox-exporter\n\n\nGrafana\næ•°æ®å±•ç¤ºå’Œå¯è§†åŒ–é¢æ¿\ngrafana&#x2F;grafana\nè¿æ¥ Prometheus åšå›¾è¡¨\n\n\nnginx-prometheus-exporter\næŠ“å– Nginx çš„å†…éƒ¨çŠ¶æ€æŒ‡æ ‡\nnginx&#x2F;nginx-prometheus-exporter\néœ€è¦ Nginx å¼€å¯ stub_status\n\n\nnode-exporter\næŠ“å–æœåŠ¡å™¨æœ¬èº« CPUã€å†…å­˜ã€ç£ç›˜ã€ç½‘ç»œæŒ‡æ ‡\nprom&#x2F;node-exporter\næœåŠ¡å™¨åŸºç¡€æ€§èƒ½ç›‘æ§\n\n\nblackbox-exporter\nå¤–éƒ¨æ¢æµ‹ HTTP&#x2F;HTTPS å¯ç”¨æ€§ã€çŠ¶æ€ç­‰\nprom&#x2F;blackbox-exporter\næ£€æµ‹ç½‘ç«™å­˜æ´»ã€SSLè¯ä¹¦æœ‰æ•ˆæœŸç­‰\n\n\nNginxï¼ˆä½ çš„WebæœåŠ¡å™¨ï¼‰\næä¾›ç½‘ç«™æœåŠ¡+åå‘ä»£ç†\nnginx:latest\nè¢«ç›‘æ§çš„å¯¹è±¡\n\n\nDocker Composeçš„é…ç½®æ–¹æ³•\nPrometheusdocker-composeçš„é…ç½®æ–¹æ³•\nservices:    prometheus:      image: prom/prometheus      container_name: prometheus      ports:        - &quot;9090:9090&quot;      volumes:        - &quot;./prometheus.yml:/etc/prometheus/prometheus.yml&quot;      restart: always\nGrafanadocker-composeçš„é…ç½®æ–¹æ³•\nservices:    grafana:      image: grafana/grafana      container_name: grafana      ports:        - &quot;3000:3000&quot;      restart: always      environment:        - GF_SERVER_ROOT_URL=https://yourServername/grafana/\nnginx-prometheus-exporter æš´éœ²å®¹å™¨å†…éƒ¨docker-composeçš„é…ç½®æ–¹æ³•ã€‚\nnginx-exporter:      image: nginx/nginx-prometheus-exporter      container_name: nginx-exporter      ports:        - &quot;9113:9113&quot;      command:#        - nginx.scrape-uri=http://nginx/stub_status        - &quot;--nginx.scrape-uri=https://yourServername/stub_status&quot; # å¦‚æœä½ çš„ç½‘ç«™æ²¡æœ‰sslè¯ä¹¦ æ”¹æˆhttpå³å¯#        - &quot;--nginx.ssl-verify=false&quot;      depends_on:        - nginx      restart: always\n\nnode-exporter ç›‘æ§æœåŠ¡å™¨æ€§èƒ½docker-composeçš„é…ç½®æ–¹æ³•ã€‚\nservices:   nodexport:      image: prom/node-exporter      container_name: exporter      ports:        - &quot;9100:9100&quot;      restart: always\nblackbox-exporter ç›‘æ§ç½‘ç«™çŠ¶æ€docker-composeçš„é…ç½®æ–¹æ³•\nservices:    blackbox-exporter:      image: prom/blackbox-exporter:latest      container_name: blackbox-exporter      ports:        - &quot;9115:9115&quot;      restart: always\n\n","categories":["è¿ç»´","ç›‘æ§","Prometheus+Grafana"],"tags":["è¿ç»´","ç›‘æ§"]},{"title":"DevOps ä¸–ç•Œçš„çµé­‚æŠ€æœ¯ï¼šCI/CD æµæ°´çº¿","url":"/2025/04/13/CI-CD/","content":"DevOps ä¸–ç•Œçš„çµé­‚æŠ€æœ¯ï¼šCI&#x2F;CD æµæ°´çº¿\nä»€ä¹ˆæ˜¯ CI&#x2F;CD æµæ°´çº¿CI&#x2F;CD &#x3D; æŒç»­é›†æˆ + æŒç»­äº¤ä»˜ &#x2F; æŒç»­éƒ¨ç½²æ˜¯ä¸€æ•´å¥—â€œè‡ªåŠ¨åŒ–æµæ°´çº¿â€ï¼Œç”¨æ¥è®©è½¯ä»¶å¼€å‘ä»æäº¤ä»£ç  â†’ è‡ªåŠ¨æ„å»º â†’ è‡ªåŠ¨æµ‹è¯• â†’ è‡ªåŠ¨éƒ¨ç½²ï¼Œä¸€æ¡é¾™å®Œæˆ\nCI&#x2F;CD æ˜¯å¹²å˜›çš„ä½ å†™ä»£ç  â†’ æ¨é€åˆ° GitHub / GitLab           â†“      âœ… CI é˜¶æ®µï¼ˆæŒç»­é›†æˆï¼‰      - è‡ªåŠ¨ç¼–è¯‘æ‰“åŒ…      - è‡ªåŠ¨è·‘å•å…ƒæµ‹è¯•      - è‡ªåŠ¨ä»£ç æ£€æŸ¥           â†“      ğŸš€ CD é˜¶æ®µï¼ˆæŒç»­äº¤ä»˜ / éƒ¨ç½²ï¼‰      - è‡ªåŠ¨æ„å»º Docker é•œåƒ      - è‡ªåŠ¨å‘å¸ƒåˆ°æµ‹è¯• / ç”Ÿäº§ç¯å¢ƒ      - è‡ªåŠ¨é€šçŸ¥ï¼ˆé’‰é’‰ / Slackï¼‰\nCI&#x2F;CD å„é˜¶æ®µéƒ½å¹²äº†å•¥ï¼Ÿ\n\n\né˜¶æ®µ\nä¸­æ–‡å\nåšä»€ä¹ˆä¸¾åŠ¨ï¼Ÿ\n\n\n\nCIï¼ˆæŒç»­é›†æˆï¼‰\nContinuous Integration\nè‡ªåŠ¨æµ‹è¯• + æ‰“åŒ…æ„å»º\n\n\nCDï¼ˆæŒç»­äº¤ä»˜ï¼‰\nContinuous Delivery\nè‡ªåŠ¨å‘å¸ƒåˆ°æµ‹è¯•ç¯å¢ƒï¼Œäººå·¥ç¡®è®¤ä¸Šçº¿\n\n\nCDï¼ˆæŒç»­éƒ¨ç½²ï¼‰\nContinuous Deployment\nè‡ªåŠ¨å‘å¸ƒåˆ°ç”Ÿäº§ç¯å¢ƒï¼Œæ— äººå·¥å¹²é¢„\n\n\nå…¸å‹çš„æµæ°´çº¿é•¿è¿™æ ·\n\n# Gitlab CI ç¤ºä¾‹ .gitlab-ci.ymlstages:    - build    - test    - deploybuild:    stage: build    script:        - npm install         - npm run build    artifacts:        path:            - dist/test:    stage: test    script:        - npm testdeploy:    stage: deploy    script:        - docker build -t my-app .        - docker push myregistry.com/my-app        - ssh deploy@server &#x27;docker pull my-app &amp;&amp; docker restart my-app&#x27;\nğŸ›  å¸¸ç”¨ CI&#x2F;CD å·¥å…·å¹³å°æœ‰å“ªäº›ï¼Ÿ\n\n\nå·¥å…·\nè¯´æ˜\næ¨èæŒ‡æ•°\n\n\n\nGitHub Actions\nGitHub åŸç”Ÿæ”¯æŒï¼Œç®€å•æ˜“ä¸Šæ‰‹\nâ­â­â­â­â­\n\n\nGitLab CI&#x2F;CD\nGitLab è‡ªå¸¦ CI&#x2F;CDï¼Œé›†æˆåº¦é«˜\nâ­â­â­â­\n\n\nJenkins\nå¼€æºç•Œè€ç‰Œ CI&#x2F;CD å·¥å…·\nâ­â­â­â­ï¼ˆé€‚åˆè‡ªå®šä¹‰å¤æ‚æµç¨‹ï¼‰\n\n\nGitea + Drone\nç§æœ‰éƒ¨ç½²ç»„åˆ\nâ­â­â­\n\n\nCircleCI &#x2F; Travis CI\nå›½å¤–æµè¡Œï¼ŒGitHub é¡¹ç›®å¤š\nâ­â­â­ï¼ˆé™å…è´¹é¢åº¦ï¼‰\n\n\nğŸ’¡ ç°å®ä¾‹å­ï¼šéƒ¨ç½²ä¸€ä¸ª Vue é¡¹ç›® + åç«¯æœåŠ¡\n\n\nå¼€å‘äººå‘˜æäº¤ä»£ç åˆ° GitHub\nGitHub Actions è‡ªåŠ¨è§¦å‘ï¼šâ€¢\tè¿è¡Œæµ‹è¯•â€¢\tæ‰§è¡Œæ„å»ºï¼ˆnpm run buildï¼‰â€¢\tæ‰“åŒ…ä¸º Docker é•œåƒâ€¢\tæ¨é€åˆ° Docker Hub &#x2F; ç§æœ‰ä»“åº“â€¢\tSSH ç™»å½•æœåŠ¡å™¨è¿œç¨‹éƒ¨ç½² &#x2F; ä½¿ç”¨ K8s æ»šåŠ¨æ›´æ–°â€¢\té€šçŸ¥é’‰é’‰ &#x2F; é‚®ä»¶ç¾¤â€œéƒ¨ç½²å®Œæˆâ€\n\nğŸ‰ å…¨ç¨‹ä¸ç”¨ä½ æ‰‹ç‚¹ï¼Œè‡ªåŠ¨å®Œæˆ\nCI&#x2F;CD çš„ä»·å€¼æ€»ç»“\n\n\nå¥½å¤„\næè¿°\n\n\n\nğŸ§¹ é™ä½äººä¸ºé”™è¯¯\nå‡å°‘éƒ¨ç½²å‡ºé”™ã€ç¯å¢ƒä¸ä¸€è‡´ç­‰é—®é¢˜\n\n\nğŸš€ åŠ å¿«è¿­ä»£é€Ÿåº¦\næäº¤ä»£ç åå‡ åˆ†é’Ÿå°±èƒ½ä¸Šçº¿\n\n\nğŸ“¦ æé«˜è´¨é‡\næ¯æ¬¡æäº¤éƒ½è·‘æµ‹è¯•ï¼Œä»£ç æ›´ç¨³å®š\n\n\nğŸ¤ æå‡å›¢é˜Ÿåä½œ\næ‰€æœ‰äººæŒ‰ç»Ÿä¸€æ ‡å‡†éƒ¨ç½²ï¼Œä¸å®¹æ˜“æ··ä¹±\n\n\nğŸ”„ æ˜“äºå›æ»š\nç‰ˆæœ¬æ‰“åŒ…æœ‰è®°å½•ï¼Œå¯éšæ—¶åˆ‡å›\n\n\nä½¿ç”¨ä»¥æ­¤åšå®¢ä½œä¸ºå®æˆ˜é¡¹ç›®ã€‚ä½¿ç”¨GitHub Actionsä½œä¸ºæµæ°´çº¿å·¥å…·ğŸ”§\n\nç›®æ ‡æ˜¯ä»€ä¹ˆï¼Ÿå®ç°ä¸€ä»¶äº‹ï¼šæˆ‘æ”¹å®Œåšå®¢å†…å®¹ï¼Œpush åˆ° GitHubï¼ŒæœåŠ¡å™¨è‡ªåŠ¨æ›´æ–°ä¸Šçº¿ï¼Œä¸ç”¨æˆ‘ç‚¹å‹ç¼©ã€FTPï¼\nç›®å‰çš„å·¥å…·ç»„åˆ\n\n\n\n\nå·¥å…·\nç”¨æ³•\nè¯´æ˜\n\n\n\nGitHub + GitHub Actions\næ‰˜ç®¡ä»£ç  + æ‰§è¡Œ CI&#x2F;CD æµæ°´çº¿\nå…è´¹ã€å¥½ç”¨\n\n\nSSH + rsync\nè‡ªåŠ¨è¿œç¨‹ä¸Šä¼ ä»£ç \næ›¿ä»£ FTPï¼Œæ›´å¿«æ›´ç¨³\n\n\nNginx\nä½ å·²ç»éƒ¨ç½²å¥½äº†ï¼Œç”¨ä½œ Web æœåŠ¡\næ ¹ç›®å½•æŒ‚è½½ç½‘ç«™å†…å®¹\n\n\nä½¿ç”¨ Jenkinsä¸‹è½½ jenkisğŸ’¡ Jenkins å®‰è£…ä½ç½®å»ºè®®\n\n\n\nå®‰è£…ä½ç½®\né€‚åˆäººç¾¤\nä¼˜ç‚¹\nç¼ºç‚¹\n\n\n\nâœ… æœ¬åœ°å¼€å‘æœº\nå¼€å‘è€…ã€æµ‹è¯•è€…ã€åšå®¢ç«™ç‚¹ç»´æŠ¤è€…\nå®‰è£…ç®€å•ï¼Œæ˜“è°ƒè¯•ï¼Œä¸æ¶‰åŠå…¬ç½‘å®‰å…¨é—®é¢˜\nç”µè„‘å…³æœºå°±ä¸èƒ½è‡ªåŠ¨éƒ¨ç½²äº†ï¼Œä¸èƒ½è¿œç¨‹æŒç»­è¿è¡Œ\n\n\nâœ… äº‘æœåŠ¡å™¨\næƒ³è®© Jenkins 24å°æ—¶åœ¨çº¿è‡ªåŠ¨éƒ¨ç½²\næŒä¹…åœ¨çº¿ï¼Œé€‚åˆå¤šäººåä½œ\nå®‰è£…å’Œé…ç½®ç•¥å¤æ‚ï¼Œè¦æ³¨æ„å®‰å…¨ï¼ˆå¦‚å¼€æ”¾ 8080 ç«¯å£ã€æƒé™ç®¡ç†ï¼‰\n\n\nMacæœ¬åœ°å®‰è£…Jenkinsï¼ˆæœ€ç®€å•æ–¹å¼ï¼‰\nä½¿ç”¨ Homebrew å®‰è£… Jenkinsbrew install jenkins-lts # ä¸‹è½½jenkinsbrew services start jenkins-lts # å¯åŠ¨jenkins\né»˜è®¤ Jenkins ä¼šè·‘åœ¨ http://localhost:8080 ä¸Šï¼Œä½ å¯ä»¥ç›´æ¥ç”¨æµè§ˆå™¨æ‰“å¼€å®ƒã€‚\nè¾“å…¥ç®¡ç†å‘˜å¯†ç ï¼ˆç¬¬ä¸€æ¬¡ç™»å½•ï¼‰é¡µé¢æ ‡é¢˜æ˜¯ï¼šUnlock Jenkinsï¼ˆè§£é” Jenkinsï¼‰ç¬¬ä¸€æ¬¡æ‰“å¼€ Jenkins ä¼šè®©ä½ è¾“å…¥å¯†ç ï¼Œä½ å¯ä»¥è¿è¡Œcat /Users/ä½ çš„ç”¨æˆ·å/.jenkins/secrets/initialAdminPassword# jenkinsç•Œé¢ä¼šæœ‰æç¤º\nå¤åˆ¶è¾“å‡ºçš„é‚£ä¸²å¯†ç ï¼Œç²˜è´´å› Jenkins é¡µé¢é‡Œï¼Œç‚¹ã€ç»§ç»­ã€‘ã€‚\nå®‰è£…æ’ä»¶ç³»ç»Ÿä¼šé—®ä½ ï¼š â€¢\tã€å®‰è£…æ¨èçš„æ’ä»¶ã€‘ï¼ˆInstall suggested pluginsï¼‰âœ… æ¨èé€‰æ‹©è¿™ä¸ª â€¢\tã€é€‰æ‹©æ’ä»¶è¦å®‰è£…ã€‘ï¼ˆSelect plugins to installï¼‰ğŸ”˜ è¯·ç‚¹å‡»ç¬¬ä¸€ä¸ªã€å®‰è£…æ¨èæ’ä»¶ã€‘ï¼Œå®ƒä¼šè‡ªåŠ¨å®‰è£…å¸¸ç”¨æ’ä»¶ï¼ˆæ¯”å¦‚ Gitã€SSHã€Pipeline ç­‰ï¼‰ã€‚ğŸ’¡ æç¤ºï¼šè¿™ä¸ªè¿‡ç¨‹éœ€è¦å‡ åˆ†é’Ÿæ—¶é—´ã€‚è€å¿ƒç­‰å¾…æ’ä»¶å®‰è£…å®Œæ¯•ã€‚\nåˆ›å»ºç¬¬ä¸€ä¸ªç®¡ç†å‘˜ç”¨æˆ·å®‰è£…æ’ä»¶åï¼Œå®ƒä¼šè¿›å…¥è¿™ä¸ªé¡µé¢ï¼Œè®©ä½ åˆ›å»ºä¸€ä¸ªè´¦æˆ·ï¼š â€¢\tç”¨æˆ·åï¼ˆUsernameï¼‰: ä½ è‡ªå·±å®šä¹‰ä¸€ä¸ª â€¢\tå¯†ç ï¼ˆPasswordï¼‰: è‡ªå·±è®¾ â€¢\tå®Œæ•´åç§°ï¼ˆFull nameï¼‰: éšæ„å¡«å†™ â€¢\té‚®ç®±åœ°å€ï¼ˆEmail addressï¼‰: æ¨èå¡«çœŸå®é‚®ç®±å¡«å¥½åç‚¹å‡»ã€ä¿å­˜å¹¶ç»§ç»­ï¼ˆSave and Continueï¼‰ã€‘ã€‚\né…ç½® Jenkins URLç³»ç»Ÿä¼šæç¤ºä½ é»˜è®¤è®¿é—®åœ°å€ï¼Œä¾‹å¦‚ï¼šhttp://localhost:8080ä¿æŒé»˜è®¤ï¼Œç‚¹å‡»ã€ä¿å­˜å¹¶å®Œæˆï¼ˆSave and Finishï¼‰ã€‘ã€‚\n\nåˆ›å»ºPipelineé¡¹ç›®\næˆ‘ä»¬æ¥åˆ°jenkinsçš„webä¸»ç•Œé¢ï¼Œç‚¹å‡»å·¦ä¸Šè§’çš„ Jenkinsï¼Œå³å¯åˆ°è¾¾é¦–é¡µ\nç‚¹å‡»ã€æ–°å»ºä»»åŠ¡ã€‘ï¼ˆNew Itemï¼‰\nè¾“å…¥ä»»åŠ¡åç§°ï¼Œä¾‹å¦‚ï¼šdeploy-hexo-blog\né€‰æ‹©ç±»å‹ï¼šã€æµæ°´çº¿ï¼ˆPipelineï¼‰ã€‘âœ…\nç‚¹å‡»ã€ç¡®å®šã€‘\nåœ¨ Pipeline é¡µé¢ä¸­é…ç½®åˆ°æœ€ä¸‹é¢çš„ â€œæµæ°´çº¿ï¼ˆPipelineï¼‰â€ åŒºå—ï¼Œï¼ˆæ¨èåœ¨vscodeä¸­ç¼–å†™å¥½Jenkinsfileä¹‹åå¤åˆ¶åˆ°è¿™é‡Œï¼‰\n   å®šä¹‰æ–¹å¼ï¼šé€‰æ‹©ã€Pipeline scriptã€‘\n   åœ¨â€œScriptâ€æ¡†ä¸­ç²˜è´´ä»¥ä¸‹å†…å®¹ï¼ˆæˆ‘ä»¬å…ˆç”¨æœ€åŸºç¡€çš„ç‰ˆæœ¬ï¼‰\n\n\n\npipeline &#123;    agent any    environment &#123;        DEPLOY_SERVER = &#x27;ä½ çš„æœåŠ¡å™¨ip&#x27;        DEPLOY_USER = &#x27;root&#x27;    // ä½ æœåŠ¡å™¨çš„ç”¨æˆ·        DEPLOY_PATH =  &#x27;/var/www/html&#x27;   // ä½ è¦ä¸Šä¼ åˆ°çš„ç›®å½•        SSH_CREDENTIALS_ID = &#x27;ecs-ssh&#x27;   // å‡­è¯        LOCAL_HEXO_DIR = &#x27;/Users/macos/Desktop/blog&#x27;  // æœ¬åœ°çš„ç›®å½•(ç»å¯¹è·¯å¾„)    &#125;    stages &#123;        stage(&#x27;å‹ç¼©publicæ–‡ä»¶å¤¹&#x27;)&#123;            steps &#123;                sh &quot;&quot;&quot;                    cd $&#123;env.LOCAL_HEXO_DIR&#125;                    zip -r ../public.zip ./public                &quot;&quot;&quot;            &#125;        &#125;        stage(&#x27;åˆ é™¤ä¹‹å‰çš„publicæ–‡ä»¶å¤¹&#x27;)&#123;            steps &#123;                script &#123;                    sshagent (credentials: [&quot;$&#123;env.SSH_CREDENTIALS_ID&#125;&quot;]) &#123;                        sh &quot;&quot;&quot;                            ssh $&#123;DEPLOY_USER&#125;@$&#123;DEPLOY_SERVER&#125; &#x27;cd $&#123;DEPLOY_PATH&#125; &amp;&amp; rm -rf public&#x27;                        &quot;&quot;&quot;                    &#125;                &#125;            &#125;        &#125;        stage(&#x27;ä¸Šä¼ å¹¶éƒ¨ç½²&#x27;)&#123;            steps &#123;                script &#123;                    sshagent (credentials: [&quot;$&#123;env.SSH_CREDENTIALS_ID&#125;&quot;]) &#123;                        sh &quot;&quot;&quot;                            scp $&#123;env.LOCAL_HEXO_DIR&#125;/../public.zip $&#123;DEPLOY_USER&#125;@$&#123;DEPLOY_SERVER&#125;:$&#123;DEPLOY_PATH&#125;/                            ssh $&#123;DEPLOY_USER&#125;@$&#123;DEPLOY_SERVER&#125; &#x27;cd $&#123;DEPLOY_PATH&#125; &amp;&amp; unzip -o public.zip &amp;&amp; rm -f public.zip&#x27;                            ssh $&#123;DEPLOY_USER&#125;@$&#123;DEPLOY_SERVER&#125; &#x27;cd $&#123;DEPLOY_PATH&#125; &amp;&amp; chmod -R 755 public&#x27;                        &quot;&quot;&quot;                    &#125;                &#125;            &#125;        &#125;    &#125;&#125;\n\nç‚¹å‡»é¡µé¢åº•éƒ¨çš„ã€ä¿å­˜ã€‘æŒ‰é’®\n\nè¿è¡Œéƒ¨ç½²ä»»åŠ¡ï¼\n   å›åˆ°é¡¹ç›®é¡µé¢ï¼Œç‚¹å‡»å·¦ä¾§ã€ç«‹å³æ„å»ºï¼ˆBuild Nowï¼‰ã€‘\n   Jenkins ä¼šå¼€å§‹æ‰§è¡Œï¼šâ€¢\tå‹ç¼©ä½ æœ¬åœ°çš„publicæ–‡ä»¶å¤¹â€¢\té€šè¿‡ SSH ç™»å½•åˆ° ECS åˆ é™¤ä¹‹å‰çš„publicæ–‡ä»¶å¤¹â€¢\tä¸Šä¼ æ–‡ä»¶åˆ°ä½ çš„éƒ¨ç½²ç›®å½•\n   ç‚¹å‡»å·¦ä¾§ã€æ„å»ºå†å²ã€‘ä¸­çš„è“è‰²å°çƒ â†’ æŸ¥çœ‹ã€æ§åˆ¶å°è¾“å‡ºï¼ˆConsole Outputï¼‰ã€‘âœ… å¦‚æœçœ‹åˆ° Finished: SUCCESS å°±è¯´æ˜éƒ¨ç½²æˆåŠŸå•¦ï¼\n\nè®¾ç½®å‡­è¯åˆšæ‰æˆ‘ä»¬è®¾ç½®äº† SSH_CREDENTIALS_ID ç”±äºæˆ‘ä»¬æ˜¯åˆšåˆšåˆ›å»ºå¥½çš„jenkinsè¿˜æ²¡æœ‰é…ç½®å‡­è¯\n[ssh-agent] Could not find specified credentials: ecs-ssh\nğŸ” Jenkins æŠ¥é”™ï¼šæ‰¾ä¸åˆ°åä¸º ecs-ssh çš„å‡­æ®\næ·»åŠ  SSH å‡­æ®å¹¶å‘½åä¸º ecs-sshğŸ”§ æ­¥éª¤å¦‚ä¸‹ï¼š    1.\tæ‰“å¼€ Jenkins ä¸»ç•Œé¢    2.\tç‚¹å‡»å·¦ä¾§ã€å‡­æ®ï¼ˆCredentialsï¼‰ã€‘    â€¢\tå¦‚æœä½ æ‰¾ä¸åˆ°è¿™ä¸ªå…¥å£ï¼Œä¹Ÿå¯ä»¥é€šè¿‡ï¼š    â€¢\tã€Manage Jenkinsã€‘â†’ã€Securityã€‘æˆ–ã€Manage Credentialsã€‘    3.\té€‰æ‹©ï¼š(global) å…¨å±€ä½œç”¨åŸŸ    4.\tç‚¹å‡»å·¦è¾¹ã€Add Credentialsã€‘ï¼ˆæ·»åŠ å‡­æ®ï¼‰ğŸ“ æ·»åŠ  SSH å‡­æ®å¡«å†™å†…å®¹å¦‚ä¸‹ï¼š\nä½¿ç”¨ Github Actionsç›®å½•ç»“æ„å¦‚æœæ²¡æœ‰workflows éœ€è¦æ‰‹åŠ¨åˆ›å»ºï¼\næˆ‘çš„åšå®¢/â”œâ”€â”€ .github/â”‚   â””â”€â”€ workflows/â”‚       â””â”€â”€ deploy.yml      ğŸ‘ˆ GitHub Actions æµæ°´çº¿è„šæœ¬â”‚   â””â”€â”€ dependabot.yml      â”œâ”€â”€ public/                 ğŸ‘ˆ æ„å»ºåè¾“å‡ºç›®å½•â”œâ”€â”€ package.json / config.yml\nGitHub Actionsè‡ªåŠ¨éƒ¨ç½²è„šæœ¬name: è‡ªåŠ¨éƒ¨ç½²åšå®¢åˆ°æœåŠ¡å™¨on:    push:        branches:            - main  # ä½¿ç”¨çš„åˆ†æ”¯ï¼Œå¦‚æœæ˜¯master ä¿®æ”¹è¿™é‡Œjobs:    deploy:        runs-on: ubuntu-latest        steps:            - name: æ‹‰ä»£ç               uses: actions/checkout@v3            - name: å®‰è£…Node.js               uses: actions/setup-node@v3              with:                node-version: 18                               - name: å®‰è£…ä¾èµ– &amp; æ„å»ºåšå®¢               run: |                npm install                 npm install -g hexo-cli                npx hexo generate            # å¦‚æœåªéœ€è¦ä¸Šä¼ èµ„æºåˆ°æœåŠ¡å™¨ å¯ä»¥çœå»å®‰è£…node å’Œhexoçš„ä¾èµ–            - name: ä¸Šä¼ åˆ°æœåŠ¡å™¨              uses: easingthemes/ssh-deploy@v2.1.5              with:                SSH_PRIVATE_KEY: $&#123;&#123; secrets.SERVER_SSH_KEY &#125;&#125;                REMOTE_USER: root   # ä½ çš„æœåŠ¡å™¨ç”¨æˆ·å                REMOTE_HOST: x.x.x.x    # ä½ çš„æœåŠ¡å™¨IP                TARGET: /var/www/html   # ä½ nginxçš„æ ¹ç›®å½• å†™åˆ°æ ¹ä¸Šä¸€ä¸ªæ–‡ä»¶å¤¹                SOURCE: public/         # ä½ ç½‘é¡µçš„èµ„æº                \né…ç½®æœåŠ¡å™¨ SSH å¯†é’¥\nåœ¨æœ¬åœ°æ‰§è¡Œå‘½ä»¤ç”Ÿæˆå¯†é’¥ï¼šssh-keygen -t rsa -b 4096 -C &quot;you@example.com&quot;\næ‹·è´å…¬é’¥åˆ°æœåŠ¡å™¨ï¼šssh-copy-id your_user@your.server.ip\næˆ–è€…æ‰‹åŠ¨æŠŠ ï½&#x2F;.ssh&#x2F;id_rsa.pubçš„å†…å®¹è¿½åŠ åˆ°æœåŠ¡å™¨çš„ï¼š~/.ssh/authorized_keys\næŠŠç§é’¥~&#x2F;.ssh&#x2F;id_rsa çš„å†…å®¹å¤åˆ¶ï¼Œç²˜è´´åˆ° GitHub ä»“åº“ä¸­ï¼šGitHub â†’ Settings â†’ Secrets â†’ Actions â†’ New repository secretåå­—å«ï¼šSERVER_SSH_KEYå€¼æ˜¯ä½ ç§é’¥çš„å†…å®¹ï¼ˆæ³¨æ„å®‰å…¨ï¼Œä¸è¦æ³„éœ²ï¼‰\n\nä¿®æ”¹ REMOTE_USERã€REMOTE_HOSTã€TARGETæ¯”å¦‚ä½ æœåŠ¡å™¨ç”¨æˆ·åæ˜¯ rootï¼Œå…¬ç½‘ IP æ˜¯ 1.2.3.4ï¼Œéƒ¨ç½²è·¯å¾„æ˜¯ &#x2F;var&#x2F;www&#x2F;htmlï¼Œé‚£ä½ å°±å¡«\nREMOTE_USER: rootREMOTE_HOST: 1.2.3.4TARGET: /var/www/html\næœ€å æ¨é€è¯•è¯•ï¼git add .git commit -m &quot;é¦–æ¬¡æ·»åŠ è‡ªåŠ¨éƒ¨ç½²&quot;git push origin main\nğŸŒŸ ç„¶åè¿›å…¥ GitHub â†’ Actionsï¼Œå°±èƒ½çœ‹åˆ°å®ƒè‡ªåŠ¨æ‰§è¡Œï¼\néƒ¨ç½²æˆåŠŸåï¼Œä½ å°±å¯ä»¥è®¿é—® http:&#x2F;&#x2F; your.server.ip æŸ¥çœ‹æ•ˆæœï¼ğŸ’¡ å°å»ºè®®ï¼šå¯é€‰åŠ ä¸€è¡Œæ—¥å¿—æ‰“å°\n- name: æŸ¥çœ‹æ„å»ºç»“æœæ–‡ä»¶å¤¹  run: ls -al public/ \n"},{"title":"Kubernetes / K8s","url":"/2025/04/13/Kubernetes/","content":"ç®€ä»‹Kubernetesï¼ˆç®€ç§° K8sï¼‰æ˜¯ Google å¼€æºçš„å®¹å™¨ç¼–æ’å¹³å°ï¼Œå®ƒçš„æ ¸å¿ƒèƒ½åŠ›æ˜¯ï¼š\nè‡ªåŠ¨ç®¡ç†å¤§è§„æ¨¡å®¹å™¨ï¼šè¿è¡Œã€æ‰©å®¹ã€é‡å¯ã€æ•…éšœè½¬ç§»ã€æœåŠ¡å‘ç°ç­‰\nå®ƒçš„ç›®æ ‡æ˜¯ï¼šâ€œä½ åªç®¡è¯´â€˜æˆ‘éœ€è¦å‡ ä¸ªæœåŠ¡â€™ï¼ŒK8s æ¥å¸®ä½ éƒ¨ç½²ã€åˆ†é…ã€è°ƒåº¦ã€ç»´æŠ¤â€ã€‚\nå¼€å§‹å‰\nå­¦ä¹  Kubernetes å‰ä½ éœ€è¦ä¼šçš„\n\n\n\n\nå¿…å¤‡çŸ¥è¯†\nçŠ¶æ€\n\n\n\nLinux åŸºæœ¬æ“ä½œ\nâœ…\n\n\nDockerï¼ˆå®¹å™¨é•œåƒã€runã€volumeï¼‰\nâœ…\n\n\nCI&#x2F;CD ç®€å•æ¦‚å¿µ\nâœ…\n\n\nNginxã€Web æœåŠ¡éƒ¨ç½²\nâœ…\n\n\nYAML é…ç½®æ–‡ä»¶\nâœ…\n\n\nğŸ¥‡ å…¥é—¨é˜¶æ®µï¼šäº†è§£æ ¸å¿ƒæ¦‚å¿µï¼ˆå¯ä»¥ 2 å°æ—¶ææ‡‚ï¼‰\n\n\n\næ ¸å¿ƒæ¦‚å¿µ\nç®€å•ç†è§£\n\n\n\nPod\nå®¹å™¨çš„æœ€å°è¿è¡Œå•ä½ï¼Œ1~n ä¸ªå®¹å™¨ç»„æˆ\n\n\nNode\nå·¥ä½œèŠ‚ç‚¹ï¼ˆæœ¬è´¨å°±æ˜¯æœåŠ¡å™¨ï¼‰\n\n\nDeployment\nå£°æ˜ä½ è¦è¿è¡Œå“ªäº› Podã€å¤šå°‘ä¸ªå‰¯æœ¬ã€æ€ä¹ˆå‡çº§\n\n\nService\nç½‘ç»œæœåŠ¡ï¼Œæä¾›è®¿é—®å…¥å£ï¼ˆClusterIP &#x2F; NodePortï¼‰\n\n\nNamespace\né¡¹ç›®éš”ç¦»ç©ºé—´ï¼ˆç±»ä¼¼ Git åˆ†æ”¯ï¼‰\n\n\nğŸ¥ˆ å®æ“é˜¶æ®µï¼šæœ¬åœ°éƒ¨ç½² K8sï¼Œè·‘ä¸ªæœåŠ¡\n\n\n\næ–¹æ³•\næ¨èå·¥å…·\n\n\n\næœ¬åœ°å•èŠ‚ç‚¹æµ‹è¯•\nminikube âœ… æ¨èï¼ˆè½»é‡ + å®˜æ–¹ï¼‰\n\n\nDocker Desktop å†…ç½® K8s\nâœ… Mac ç”¨æˆ·ä¹Ÿé€‚åˆ\n\n\nä½¿ç”¨ kubectl æ§åˆ¶é›†ç¾¤\nå¿…å¤‡ CLI å·¥å…·\n\n\nè·‘ä¸€ä¸ª Nginx\nåˆ›å»º Deployment + Service\n\n\nè·‘ä½ è‡ªå·±çš„åšå®¢é•œåƒ\næ¯”å¦‚ç”¨ä½ å·²æœ‰çš„é™æ€ HTML åšä¸€ä¸ª nginx å®¹å™¨è·‘èµ·æ¥\n\n\nğŸ¥‰ è¿›é˜¶é˜¶æ®µï¼šéƒ¨ç½² + é«˜å¯ç”¨ + CI&#x2F;CD é›†æˆ\n\n\n\næŠ€æœ¯ç‚¹\nåº”ç”¨\n\n\n\nHelm\nK8s çš„ â€œåŒ…ç®¡ç†å™¨â€ï¼Œä¸€é”®éƒ¨ç½² WordPress &#x2F; Redis &#x2F; MySQL\n\n\nIngress\nHTTP ä»£ç†è·¯ç”±å…¥å£ï¼Œæ¯”å¦‚å®ç° blog.karen.com\n\n\nConfigMap + Secret\né…ç½®æ³¨å…¥ï¼ˆå¦‚åšå®¢ configï¼‰\n\n\nKustomize\nå¤šç¯å¢ƒé…ç½®ç®¡ç†\n\n\nGitOps\nCI&#x2F;CD è‡ªåŠ¨éƒ¨ç½²åˆ° K8sï¼ˆArgoCDã€Fluxï¼‰\n\n\nPrometheus + Grafana\né›†ç¾¤ç›‘æ§å¯è§†åŒ–\n\n\nCluster é›†ç¾¤\nä¸€å¥è¯ç†è§£ä»€ä¹ˆæ˜¯â€œé›†ç¾¤â€ï¼ˆClusterï¼‰é›†ç¾¤ &#x3D; ä¸€ç»„â€œè”ç½‘åä½œçš„æœåŠ¡å™¨â€ï¼Œå®ƒä»¬å¯¹å¤–è¡¨ç°æˆâ€œä¸€ä¸ªæ•´ä½“â€æ¥æä¾›æœåŠ¡ã€‚â“é›†ç¾¤æ˜¯ä¸åŒåœ°åŒºçš„ä¸»æœºå—ï¼Ÿä¸ä¸€å®šã€‚é›†ç¾¤å¯ä»¥åœ¨åŒä¸€æœºæˆ¿ï¼Œä¹Ÿå¯ä»¥è·¨åœ°åŒºï¼Œåªè¦ç½‘ç»œèƒ½é€šå°±å¯ä»¥å½¢æˆé›†ç¾¤ã€‚ä½†å¤§å¤šæ•°ä¼ä¸šä¸ºäº†æ€§èƒ½ï¼Œä¼šæŠŠé›†ç¾¤éƒ¨ç½²åœ¨åŒä¸€ä¸ªå±€åŸŸç½‘ &#x2F; æ•°æ®ä¸­å¿ƒé‡Œï¼ˆæ¯”å¦‚é˜¿é‡Œäº‘ã€K8s äº‘æœåŠ¡é›†ç¾¤ï¼‰â“é›†ç¾¤æ˜¯â€œä¸€ä¸ªæœåŠ¡ç”¨ä¸€ç¾¤ä¸»æœºæ¥è·‘â€å—ï¼Ÿ âœ… æ­£è§£ï¼ ä½ å¯ä»¥ï¼š â€¢\tæŠŠä¸€ä¸ªæœåŠ¡éƒ¨ç½²åˆ°å¤šä¸ªèŠ‚ç‚¹ä¸Šï¼Œåˆ†æ‘Šå‹åŠ›ï¼ˆæ¯”å¦‚ä½ çš„åšå®¢ + è´Ÿè½½å‡è¡¡ï¼‰ â€¢\tæŠŠå¤šä¸ªæœåŠ¡ï¼ˆåšå®¢ã€è¯„è®ºã€æ•°æ®åº“ï¼‰éƒ¨ç½²åˆ°åŒä¸€ä¸ªé›†ç¾¤ï¼Œèµ„æºå¤ç”¨ Kubernetes ä¼šè‡ªåŠ¨å†³å®šï¼š â€¢\tå“ªå°æœºå™¨èµ„æºå¤Ÿï¼Ÿå°±åˆ†é…ä¸Šå» â€¢\tå“ªä¸ªæœåŠ¡éœ€è¦ 3 ä¸ªå‰¯æœ¬ï¼Ÿæˆ‘è‡ªåŠ¨å¸®ä½ éƒ¨ç½²åˆ° 3 å°èŠ‚ç‚¹ â€¢\tå“ªä¸ªèŠ‚ç‚¹å®•æœºï¼Ÿè‡ªåŠ¨é‡å¯åˆ°åˆ«çš„èŠ‚ç‚¹ä¸Šï¼\n\nğŸ“¦ ç±»æ¯”è§£é‡Šä¸€ï¼šé›†ç¾¤å°±åƒä¸€ä¸ªâ€œå¨æˆ¿å›¢é˜Ÿâ€\n\n\nâ€¢\tä½ æƒ³ç‚¹ä¸€ä»½â€œå¤§é¤æœåŠ¡â€ï¼ˆæ¯”å¦‚éƒ¨ç½²ä½ åšå®¢ + æ•°æ®åº“ +è¯„è®ºç³»ç»Ÿï¼‰â€¢\tä¸€ä¸ªå¨å¸ˆï¼ˆå•å°æœåŠ¡å™¨ï¼‰å¯èƒ½å¿™ä¸è¿‡æ¥â€¢\tæ‰€ä»¥ä½ è¯·äº†ä¸€æ•´ç»„å¨å¸ˆï¼ˆå¤šå°æœºå™¨ï¼‰â€¢\tå¨æˆ¿å›¢é˜Ÿï¼ˆé›†ç¾¤ï¼‰ä¼šè‡ªåŠ¨å†³å®šï¼šâ€¢\tè°ç…®ä¸»èœï¼Ÿâ€¢\tè°è´Ÿè´£ç‚’èœï¼Ÿâ€¢\tä¸‡ä¸€ä¸€ä¸ªå¨å¸ˆå€’ä¸‹ï¼ˆå®•æœºï¼‰ï¼Œè°æ¥é¡¶ä¸Šï¼Ÿ\nâœ… è¿™æ•´ä¸ªå¨æˆ¿å›¢é˜Ÿ &#x3D; â€œé›†ç¾¤â€âœ… ä»–ä»¬ä¹‹é—´çš„åˆ†å·¥ã€è°ƒåº¦ã€æ•…éšœåˆ‡æ¢ &#x3D; Kubernetes æ¥è´Ÿè´£\n\nğŸ“Œ æŠ€æœ¯ä¸€ç‚¹è¯´ï¼š\n\n\n\n\nåç§°\nå«ä¹‰\n\n\n\né›†ç¾¤ (Cluster)\nä¸€ç»„é€šè¿‡ç½‘ç»œè¿æ¥çš„â€œèŠ‚ç‚¹â€æœåŠ¡å™¨\n\n\nèŠ‚ç‚¹ (Node)\né›†ç¾¤ä¸­çš„ä¸€å°æœºå™¨ï¼Œå¯ä»¥æ˜¯è™šæ‹Ÿæœºæˆ–ç‰©ç†æœº\n\n\nä¸»èŠ‚ç‚¹ (Master)\nç®¡ç†æ•´ä¸ªé›†ç¾¤çš„å¤§è„‘ï¼Œè´Ÿè´£è°ƒåº¦ã€ç›‘æ§ã€API\n\n\nå·¥ä½œèŠ‚ç‚¹ (Worker)\nå®é™…è·‘ä½ åº”ç”¨çš„æœºå™¨ï¼ˆæ¯”å¦‚è·‘ nginx &#x2F; åšå®¢ï¼‰\n\n\nk8sä¸­çš„â€œé›†ç¾¤ç»“æ„å›¾â€            [ Master æ§åˆ¶èŠ‚ç‚¹ ]           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚  è°ƒåº¦æœåŠ¡ kube-scheduler           â”‚  API Server           â”‚  çŠ¶æ€æ§åˆ¶å™¨           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â†“      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â†“              â†“              â†“[Worker Node1]   [Worker Node2]  [Worker Node3]  â””â”€Pod: Nginx     â””â”€Pod: Blog     â””â”€Pod: Redis  â””â”€Pod: Mongo     â””â”€Pod: Hexo     â””â”€Pod: è¯„è®ºç³»ç»Ÿ\nç°å®ä¸­çš„â€œé›†ç¾¤â€éƒ½ç”¨åœ¨å“ªï¼Ÿ\n\n\n\nåœºæ™¯\nåº”ç”¨\n\n\n\nå¤§å…¬å¸ç½‘ç«™\nå¤šåœ°éƒ¨ç½²ï¼Œå½¢æˆå…¨çƒK8sé›†ç¾¤(CDN+æœåŠ¡èŠ‚ç‚¹)\n\n\nä¼ä¸šSaaSå¹³å°\nç”¨é›†ç¾¤æå‡é«˜å¯ç”¨æ€§+è‡ªåŠ¨æ‰©å®¹èƒ½åŠ›\n\n\näº‘æœåŠ¡å•†\nç”¨æˆ·åªç”¨ç”³è¯·ä¸€ä¸ªâ€œé›†ç¾¤â€ï¼ŒèƒŒåå…¨è‡ªåŠ¨   ï½œ\n\n\né›†ç¾¤æ˜¯å¤šå°ä¸»æœºç»„æˆçš„â€œä¸€ä¸ªå¤§è„‘ + å¤šä¸ªæ‰‹â€çš„å›¢é˜Ÿã€‚K8s è´Ÿè´£è°ƒåº¦å¤§è„‘ï¼Œè®©æ¯ä¸ªæœåŠ¡éƒ½èƒ½ç¨³å®šè¿è¡Œï¼Œæ‰äº†å°±è¡¥ã€æ…¢äº†å°±æ‰©ã€‚k8sè§£å†³äº†ä»€ä¹ˆé—®é¢˜ï¼Ÿä½ ç”¨ Docker å¯åŠ¨äº†ä¸€ä¸ª Web æœåŠ¡ï¼š\ndocker run -d -p 80:80 my-app\nå¾ˆå¥½ç”¨æ²¡é”™ã€‚ä½†æ˜¯åæ¥ä½ å‘ç°é—®é¢˜è¶Šæ¥è¶Šå¤šï¼›    1.\tè¦éƒ¨ç½² 10 ä¸ªå®¹å™¨æ€ä¹ˆåŠï¼Ÿæ€ä¹ˆç®¡ç†ï¼Ÿ    2.\tå®¹å™¨æŒ‚äº†æ€ä¹ˆåŠï¼Ÿæ‰‹åŠ¨é‡å¯å¤ªéº»çƒ¦ã€‚    3.\tå¤šä¸ªæœåŠ¡å™¨å¦‚ä½•åˆ†é…èµ„æºï¼Ÿæ€ä¹ˆè°ƒåº¦ï¼Ÿ    4.\té…ç½®ã€å¯†é’¥ã€æœåŠ¡å‘ç°æ€ä¹ˆç»Ÿä¸€ç®¡ç†ï¼Ÿ    5.\tå¦‚ä½•å‡çº§ä¸å½±å“ç”¨æˆ·ï¼Ÿå¦‚ä½•å¿«é€Ÿå›æ»šï¼ŸğŸ¯ è¿™äº›ç—›ç‚¹å°±æ˜¯ Kubernetes è¯ç”Ÿçš„åŸå› ï¼šå®ƒæ˜¯ä¸ºäº†è§£å†³å¤§è§„æ¨¡å®¹å™¨ç®¡ç†ã€è‡ªåŠ¨åŒ–è°ƒåº¦å’Œé«˜å¯ç”¨æ€§é—®é¢˜è€Œç”Ÿçš„ã€‚\nå¿…é¡»çŸ¥é“çš„æ ¸å¿ƒæ¦‚å¿µ\n\n\næ¦‚å¿µ\nå°ç™½ç†è§£æ–¹å¼\n\n\n\nPod\næ˜¯ K8s ä¸­çš„æœ€å° â€œéƒ¨ç½²å•ä½â€ï¼Œé€šå¸¸ä¸€ä¸ª Pod åŒ…å«ä¸€ä¸ªå®¹å™¨ï¼Œå°±åƒä¸€ä¸ªæˆ¿é—´ä½ä¸€ä¸ªäºº\n\n\nNode\nè¿è¡Œ Pod çš„ä¸»æœºï¼Œå¯ä»¥æ˜¯çœŸå®æœºå™¨æˆ–è™šæ‹Ÿæœº\n\n\nCluster\nå¤šä¸ª Node ç»„æˆä¸€ä¸ª K8s é›†ç¾¤\n\n\nDeployment\nå®šä¹‰ä¸€ç»„ Pod æ€ä¹ˆåˆ›å»ºã€å‡çº§ã€å›æ»šï¼Œä¿æŒæ•°é‡ç¨³å®š\n\n\nService\nä¸ºä¸€ç»„ Pod æä¾›ç»Ÿä¸€è®¿é—®å…¥å£ï¼Œç±»ä¼¼ â€œå‰å°æœåŠ¡å°â€\n\n\nNamespace\nç›¸å½“äºé›†ç¾¤é‡Œçš„åˆ†åŒºï¼Œç”¨äºèµ„æºéš”ç¦»ï¼ˆæ¯”å¦‚æµ‹è¯•ç¯å¢ƒå’Œç”Ÿäº§ç¯å¢ƒï¼‰\n\n\nIngress\nè®©å¤–éƒ¨å¯ä»¥é€šè¿‡åŸŸåè®¿é—®é›†ç¾¤å†…æœåŠ¡\n\n\nVolume &#x2F; PVC\nç»™å®¹å™¨æŒ‚è½½æ•°æ®ç›˜ï¼Œè®©æ•°æ®ä¸ä¼šå› å®¹å™¨æ¶ˆå¤±è€Œä¸¢å¤±\n\n\nConfigMap &#x2F; Secret\nå­˜é…ç½®æ–‡ä»¶å’Œå¯†ç çš„åœ°æ–¹ï¼Œé¿å…ç¡¬ç¼–ç è¿›é•œåƒ\n\n\nRBAC æƒé™æ§åˆ¶\né™åˆ¶è°èƒ½åšä»€ä¹ˆæ“ä½œï¼Œé˜²æ­¢æƒé™è¿‡å¤§å‡ºé—®é¢˜\n\n\nKubelet &#x2F; Controller &#x2F; Scheduler\næ˜¯ K8s çš„â€œå¤§è„‘å’Œç¥ç»ç³»ç»Ÿâ€ï¼Œè‡ªåŠ¨å®Œæˆä»»åŠ¡è°ƒåº¦å’Œå®¹å™¨ç”Ÿå‘½å‘¨æœŸç®¡ç†\n\n\nå¿…é¡»çŸ¥é“çš„å®¹å™¨æ¦‚å¿µ\n\n\næ¦‚å¿µ\nç®€è¦è¯´æ˜\n\n\n\né•œåƒ (Image)\næ˜¯ç¨‹åº + ç¯å¢ƒçš„æ‰“åŒ…æ–‡ä»¶ï¼Œç›¸å½“äº App å®‰è£…åŒ…\n\n\nå®¹å™¨ (Container)\næ˜¯è¿è¡Œä¸­çš„é•œåƒï¼Œæ˜¯è¿›ç¨‹ä¸æ˜¯è™šæ‹Ÿæœº\n\n\nDocker\næ˜¯æœ€å¸¸ç”¨çš„å®¹å™¨å¼•æ“ï¼ŒK8s ç”¨å®ƒï¼ˆæˆ– containerdï¼‰è¿è¡Œå®¹å™¨\n\n\nå®¹å™¨ç¼–æ’\nå¤šä¸ªå®¹å™¨å¦‚ä½•è‡ªåŠ¨éƒ¨ç½²ã€æ‰©å®¹ã€é‡å¯ï¼Œå°±æ˜¯ K8s åšçš„äº‹\n\n\nYAML é…ç½®\nK8s æ‰€æœ‰èµ„æºéƒ½é  YAML å®šä¹‰ï¼Œéœ€è¦èƒ½çœ‹æ‡‚åŸºæœ¬ç»“æ„\n\n\nå®‰è£…K8s ç”Ÿäº§ç¯å¢ƒåœ¨å®‰è£… Kubernetesï¼ˆç‰¹åˆ«æ˜¯ç”¨ kubeadm æ­å»ºç”Ÿäº§çº§å¤šèŠ‚ç‚¹é›†ç¾¤ï¼‰ä¹‹å‰ï¼Œç¡®å®éœ€è¦åšä¸€ç³»åˆ—â€œæ‰“åœ°åŸºâ€çš„è®¾ç½®ï¼Œä¸ç„¶åç»­å¾ˆå®¹æ˜“å‡ºç°å„ç§è¯¡å¼‚é—®é¢˜ï¼ˆå¦‚ kubelet å¯åŠ¨å¤±è´¥ã€ç½‘ç»œä¸é€šã€æ— æ³•åŠ å…¥é›†ç¾¤ç­‰ï¼‰ã€‚\nå‰æä¸€ã€ç³»ç»ŸåŸºç¡€é…ç½®ï¼ˆæ‰€æœ‰èŠ‚ç‚¹éƒ½éœ€è¦ï¼‰\n\n\nè®¾ç½®é¡¹\nå»ºè®®å€¼&#x2F;åŠ¨ä½œ\nè¯´æ˜\n\n\n\næ“ä½œç³»ç»Ÿ\nUbuntu 20.04+ &#x2F; CentOS 7+\nå…¼å®¹æœ€å¥½ï¼Œå»ºè®®ä½¿ç”¨ LTS ç‰ˆæœ¬\n\n\nç”¨æˆ·æƒé™\nä½¿ç”¨ root ç”¨æˆ· æˆ– sudo æƒé™ç”¨æˆ·\næ‰€æœ‰è®¾ç½®éƒ½éœ€è¦ç®¡ç†å‘˜æƒé™\n\n\nä¸»æœºåå”¯ä¸€\nhostnamectl set-hostname node1\nå¦åˆ™å¯èƒ½æ— æ³•åŒºåˆ†èŠ‚ç‚¹\n\n\nhosts é…ç½®\næ¯ä¸ªèŠ‚ç‚¹è¦èƒ½è§£æå…¶ä»–èŠ‚ç‚¹å\nä¿®æ”¹ /etc/hosts åŠ å…¥èŠ‚ç‚¹æ˜ å°„\n\n\næ—¶é—´åŒæ­¥\nå®‰è£… chrony æˆ– ntp ä¿è¯æ—¶é—´ä¸€è‡´\næ—¶é—´ä¸ä¸€è‡´ä¼šå¯¼è‡´è¯ä¹¦éªŒè¯å¤±è´¥\n\n\näºŒã€å…³é—­æˆ–é…ç½®ç³»ç»ŸåŠŸèƒ½ï¼ˆé‡è¦ï¼ï¼‰\n\n\né¡¹ç›®\nå‘½ä»¤\nåŸå› \n\n\n\nå…³é—­ swap\nswapoff -a å¹¶æ³¨é‡Š /etc/fstab ä¸­ swap è¡Œ\nKubernetes ç¦æ­¢ä½¿ç”¨ swap\n\n\nå…³é—­é˜²ç«å¢™ï¼ˆå¼€å‘ç¯å¢ƒï¼‰\nsystemctl stop firewalld/ufw\nèŠ‚ç‚¹é—´é€šè®¯å¯èƒ½è¢«æ‹¦æˆªï¼Œç”Ÿäº§ç¯å¢ƒè¦é…ç½®ç­–ç•¥\n\n\nå…³é—­ SELinuxï¼ˆCentOSï¼‰\nsetenforce 0 å¹¶ç¼–è¾‘ /etc/selinux/config\nå¦åˆ™ kubelet å¯åŠ¨å¤±è´¥\n\n\né…ç½® iptables\nmodprobe br_netfilter + è®¾ç½® sysctl å‚æ•°\nå¦åˆ™ç½‘ç»œæ’ä»¶ä¼šå‡ºé—®é¢˜\n\n\ncat &lt;&lt;EOF | sudo tee /etc/modules-load.d/k8s.confbr_netfilterEOFcat &lt;&lt;EOF | sudo tee /etc/sysctl.d/k8s.confnet.bridge.bridge-nf-call-iptables  = 1net.ipv4.ip_forward                 = 1net.bridge.bridge-nf-call-ip6tables = 1EOFsysctl --system\nä¸‰ã€å®¹å™¨è¿è¡Œæ—¶é€‰æ‹©å› ä¸ºk8såœ¨1.24ç‰ˆæœ¬å¼ƒç”¨äº†dockerçš„æ”¯æŒ æ‰€ä»¥æ›´æ”¯æŒç”¨containerdæ¥è·‘å®¹å™¨\n\n\n\né€‰é¡¹\nè¯´æ˜\n\n\n\ncontainerd âœ…\nå®˜æ–¹æ¨èï¼Œè½»é‡ç¨³å®š\n\n\nDocker âŒ\nå·²ä¸æ¨èï¼Œéœ€é¢å¤–å®‰è£… cri-dockerd\n\n\næ¨èå®‰è£… containerdï¼š\nsudo apt install -y containerdsudo mkdir -p /etc/containerdcontainerd config default | sudo tee /etc/containerd/config.tomlsudo systemctl restart containerd\nå››ã€å®‰è£… kubeadm &#x2F; kubelet &#x2F; kubectlï¼ˆæ ¸å¿ƒä¸‰ä»¶å¥—ï¼‰æ·»åŠ  K8s å®˜æ–¹æº + å®‰è£…ï¼š\nsudo apt update &amp;&amp; sudo apt install -y apt-transport-https curlcurl -fsSL https://packages.cloud.google.com/apt/doc/apt-key.gpg | sudo apt-key add -cat &lt;&lt;EOF | sudo tee /etc/apt/sources.list.d/kubernetes.listdeb https://apt.kubernetes.io/ kubernetes-xenial mainEOFsudo apt updatesudo apt install -y kubelet kubeadm kubectlsudo apt-mark hold kubelet kubeadm kubectl\n\nå®‰è£… k8sè¿™æ¬¡æˆ‘ä»¬é‡‡ç”¨çš„å•èŠ‚ç‚¹\ncrictl å’Œ nerdctlä½ åœ¨ crictl ä¸­èƒ½çœ‹åˆ° nginx:latest ç­‰é•œåƒä½†åœ¨ nerdctl images é‡Œæ˜¯ç©ºçš„è¯´æ˜ä½ çš„é•œåƒç›®å‰åªå­˜åœ¨äº containerd çš„é»˜è®¤ namespaceï¼ˆk8s.ioï¼‰ä¸­ï¼Œè€Œ nerdctl é»˜è®¤ä½¿ç”¨çš„æ˜¯ moby namespaceã€‚âœ… è§£å†³æ–¹æ¡ˆï¼šåˆ‡æ¢ nerdctl çš„ namespaceä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æŸ¥çœ‹ containerd ä¸­æœ‰å“ªäº›å‘½åç©ºé—´ï¼š\nctr namespaces list\nä½ å¤§æ¦‚ç‡ä¼šçœ‹åˆ°åƒè¿™æ ·çš„ä¸€äº› namespaceï¼š\nNAME     LABELSdefaultk8s.iomoby\nâ¤ æŸ¥çœ‹ k8s.io ä¸­çš„é•œåƒï¼š\nnerdctl --namespace k8s.io images\nâœ… å¦‚æœä½ æƒ³å¯¼å‡ºè¿™äº›é•œåƒä¾‹å¦‚å¯¼å‡º nginxï¼š\nnerdctl --namespace k8s.io save nginx:latest -o /tmp/nginx.tar\nç„¶ååœ¨ moby æˆ–å…¶ä»–ä½ æ‰“ç®—ç”¨æ¥æ„å»ºçš„ namespace ä¸­å¯¼å…¥ï¼š\nnerdctl --namespace moby load -i /tmp/nginx.tar\nğŸ“Œ ä½ å¯ä»¥è®¾ç½®é»˜è®¤ namespaceï¼ˆå¯é€‰ï¼‰å¦‚æœä½ æƒ³è®© nerdctl é»˜è®¤ä¹Ÿç”¨ k8s.io çš„é•œåƒï¼Œå¯ä»¥è®¾ç½®ï¼š\nexport CONTAINERD_NAMESPACE=k8s.io\nåŠ è¿› .bashrc æˆ– .zshrc é‡Œå°±èƒ½æ°¸ä¹…ç”Ÿæ•ˆã€‚æ“ä½œç›®çš„å‘½ä»¤ç¤ºä¾‹æŸ¥çœ‹é•œåƒåœ¨å“ªäº› namespace ä¸‹ctr namespaces listnerdctl æŸ¥çœ‹ k8s é•œåƒnerdctl â€“namespace k8s.io imageså¯¼å‡º nginx é•œåƒnerdctl â€“namespace k8s.io save nginx -o nginx.tarå¯¼å…¥é•œåƒåˆ°é»˜è®¤ç¯å¢ƒnerdctl load -i nginx.tar\nnerdctl â€“namespace k8s.io images â€“digests\nnerdctl â€“namespace k8s.io image prune\nå®‰è£…K8S å†…ç½‘ç”Ÿäº§ç¯å¢ƒå‡†å¤‡å·¥ä½œæœºå™¨æ•°é‡3ä¸ªï¼Œé‡‡ç”¨1master+2nodeçš„æ¶æ„éƒ¨ç½²é›†ç¾¤\n\n\n\nIP\nä¸»æœºå\nè§’è‰²\næ•°é‡\né…ç½®\n\n\n\n192.168.6.235\nk8s-master\nmaster\n1\n16C 32G\n\n\n192.168.7.75\nk8s-node1\nnode\n1\n16C 32G\n\n\n192.168.7.76\nk8s-node2\nnode\n1\n16C 32G\n\n\néƒ¨ç½² K8S\næ›´æ”¹ä¸»æœºå é…ç½®yumæºæŒ‰ç…§ä¸Šè¿°ï¼Œæ›´æ”¹ä¸»æœºåhostnamectl set-h^Ctname k8s-masterhostnamectl set-h^Ctname k8s-node1hostnamectl set-h^Ctname k8s-node2# æ³¨æ„æŒ‰ç…§ç›¸åº”çš„ç‰ˆæœ¬è°ƒæ•´é˜¿é‡Œäº‘çš„æºåœ°å€wget -O /etc/yum.repos.d/CentOS-Base.repo https://mirrors.aliyun.com/repo/Centos-vault-8.5.2111.repo\né…ç½®hostsæ–‡ä»¶192.168.6.235 k8s-master192.168.7.75 k8s-node1192.168.7.76 k8s-node2\nå…³é—­é˜²ç«å¢™# ä¸´æ—¶å…³é—­sudo setenforce 0# æ°¸ä¹…ç¦ç”¨sudo sed -i &#x27;s/^SELINUX=.*/SELINUX=disabled/&#x27; /etc/selinux/configsudo systemctl stop firewalldsudo systemctl disable firewalld\nç¦ç”¨swapåˆ†åŒº# ä¸´æ—¶å…³é—­ï¼›å…³é—­swapsudo swapoff -a# æ°¸ä¹…å…³é—­sudo sed -i &#x27;/swap/d&#x27; /etc/fstab# å¯ä»¥é€šè¿‡è¿™ä¸ªå‘½ä»¤æŸ¥çœ‹swapæ˜¯å¦å…³é—­äº†free\nå®‰è£…å¿…è¦æ¨¡å—\n\nyum install  -y ipvsadm ipset sysstat conntrack libseccomp# dummy0ç½‘å¡å’Œkube-ipvs0ç½‘å¡ï¼šåœ¨å®‰è£…k8sé›†ç¾¤æ—¶ï¼Œå¯ç”¨äº†ipvsçš„è¯ï¼Œå°±ä¼šæœ‰è¿™ä¸¤ä¸ªç½‘å¡ã€‚ï¼ˆå°†serviceçš„IPç»‘å®šåœ¨kube-ipvs0ç½‘å¡ä¸Šï¼‰cat &gt; /etc/sysconfig/modules/ipvs.modules &lt;&lt;EOF#!/bin/bashipvs_modules=&quot;ip_vs ip_vs_lc ip_vs_wlc ip_vs_rr ip_vs_wrr ip_vs_lblc ip_vs_lblcr ip_vs_dh ip_vs_sh ip_vs_fo ip_vs_nq ip_vs_sed ip_vs_ftp nf_conntrack ip_tables ip_set xt_set ipt_set ipt_rpfilter ipt_REJECT ipip &quot;for kernel_module in \\$&#123;ipvs_modules&#125;; do  /sbin/modinfo -F filename \\$&#123;kernel_module&#125; &gt; /dev/null 2&gt;&amp;1  if [ $? -eq 0 ]; then    /sbin/modprobe \\$&#123;kernel_module&#125;  fidoneEOFchmod 755 /etc/sysconfig/modules/ipvs.modules sh /etc/sysconfig/modules/ipvs.modules lsmod | grep ip_vs# è½¬å‘ IPv4 å¹¶è®© iptables çœ‹åˆ°æ¡¥æ¥æµé‡cat &lt;&lt;EOF | sudo tee /etc/modules-load.d/k8s.confoverlaybr_netfilterEOFsudo modprobe overlaysudo modprobe br_netfilter# è®¾ç½®æ‰€éœ€çš„ sysctl å‚æ•°ï¼Œå‚æ•°åœ¨é‡æ–°å¯åŠ¨åä¿æŒä¸å˜cat &lt;&lt;EOF | sudo tee /etc/sysctl.d/k8s.confnet.bridge.bridge-nf-call-iptables  = 1net.bridge.bridge-nf-call-ip6tables = 1net.ipv4.ip_forward                 = 1EOF# åº”ç”¨ sysctl å‚æ•°è€Œä¸é‡æ–°å¯åŠ¨sudo sysctl --system# æ£€æŸ¥æ˜¯å¦å®‰è£…æ­£ç¡®lsmod | grep br_netfilterlsmod | grep overlay# ç¡®è®¤ net.bridge.bridge-nf-call-iptablesã€net.bridge.bridge-nf-call-ip6tables å’Œ net.ipv4.ip_forward ç³»ç»Ÿå˜é‡åœ¨ä½ çš„ sysctl é…ç½®ä¸­è¢«è®¾ç½®ä¸º 1sysctl net.bridge.bridge-nf-call-iptables net.bridge.bridge-nf-call-ip6tables net.ipv4.ip_forward\n\nè¿è¡Œæ—¶ï¼Œé€‰æ‹© containerd# å¯ä»¥ç›´æ¥å®‰è£…yum install -y containerd# ä¸‹è½½å®‰è£…åŒ…ï¼Œç„¶åè§£å‹å³å¯https://github.com/containerd/containerd/blob/main/docs/getting-started.md\né…ç½®containerdï¼Œé•œåƒåŠ é€Ÿï¼Œcgroupç­‰# æŸ¥çœ‹containerdç‰ˆæœ¬containerd --versionç‰ˆæœ¬ä¸º 1.6.32# é…ç½®ä¸ºaliyunçš„é•œåƒæºmkdir /etc/containerdcontainerd config default &gt; /etc/containerd/config.tomlsed -i &quot;s#registry.k8s.io/pause:3.8#registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.9#g&quot;  /etc/containerd/config.toml# é…ç½®é•œåƒåŠ é€Ÿvim /etc/containerd/config.toml  [plugins.&quot;io.containerd.grpc.v1.cri&quot;.registry.mirrors]    [plugins.&quot;io.containerd.grpc.v1.cri&quot;.registry.mirrors.&quot;docker.io&quot;]      endpoint = [&quot;https://docker-mirror.h3d.com.cn&quot;]# é…ç½®cgroupvim /etc/containerd/config.toml[plugins.&quot;io.containerd.grpc.v1.cri&quot;.containerd.runtimes.runc.options]  SystemdCgroup = true\né…ç½®k8sæº\n\ncat &lt;&lt;EOF &gt; /etc/yum.repos.d/kubernetes.repo[kubernetes]name=Kubernetesbaseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64/enabled=1gpgcheck=1repo_gpgcheck=1gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpgEOF\n\nå®‰è£…kubeletã€kubeadmã€kubectl(æ‰€æœ‰èŠ‚ç‚¹éƒ½éœ€è¦)\n\n# æŸ¥çœ‹å¯ç”¨ç‰ˆæœ¬yum list kubelet --showduplicates |grep 1.28# å®‰è£…yum install -y kubelet-1.28.2 kubeadm-1.28.2 kubectl-1.28.2 --disableexcludes=kubernetessystemctl enable --now kubelet\n\né…ç½®crictl(å¦‚æœæƒ³è¦åœ¨æ‰€æœ‰èŠ‚ç‚¹æ“ä½œï¼Œå¯ä»¥éƒ½å®‰è£…)\n\n# å¦‚æœæ¯ä¸ªèŠ‚ç‚¹éƒ½éœ€è¦crictlï¼Œå¯ä»¥å®‰è£…å¹¶é…ç½®cat  &lt;&lt;EOF | sudo tee /etc/crictl.yamlruntime-endpoint: unix:///var/run/containerd/containerd.socktimeout: 5image-endpoint: unix:///var/run/containerd/containerd.sockEOF\n\nåˆå§‹åŒ–(ä»…åœ¨masterèŠ‚ç‚¹æ“ä½œ)\n\nkubeadm init --kubernetes-version=1.28.15 \\--apiserver-advertise-address=193.168.6.235  \\--image-repository  registry.aliyuncs.com/google_containers \\--pod-network-cidr=10.1.0.0/16--service-cidr=10.96.0.0/12\nè¾“å‡ºå¦‚ä¸‹\nYour Kubernetes control-plane has initialized successfully!To start using your cluster, you need to run the following as a regular user:  mkdir -p $HOME/.kube  sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config  sudo chown $(id -u):$(id -g) $HOME/.kube/configAlternatively, if you are the root user, you can run:  export KUBECONFIG=/etc/kubernetes/admin.confYou should now deploy a pod network to the cluster.Run &quot;kubectl apply -f [podnetwork].yaml&quot; with one of the options listed at:  https://kubernetes.io/docs/concepts/cluster-administration/addons/Then you can join any number of worker nodes by running the following on each as root:kubeadm join 192.168.6.235:6443 --token r10sv8.8wdmesq0hl16ztxy \\    --discovery-token-ca-cert-hash sha256:fdcbd538e705dd0d68ea7d0aea289f09d1b3e461bab539c2f0b4262ae36762b9 \n\næŒ‰ç…§åˆå§‹åŒ–è¾“å‡ºï¼Œè¿›è¡Œæ“ä½œï¼Œå¹¶æ·»åŠ masteræ±¡ç‚¹\n\nmkdir -p $HOME/.kubesudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/configsudo chown $(id -u):$(id -g) $HOME/.kube/configexport KUBECONFIG=/etc/kubernetes/admin.conf# æ·»åŠ æ±¡ç‚¹ï¼Œé¿å…ä¸šåŠ¡è¿›ç¨‹è°ƒåº¦åˆ°masterèŠ‚ç‚¹kubectl taint nodes --all node-role.kubernetes.io/control-plane-\n\næ£€æŸ¥é›†ç¾¤çŠ¶æ€\n\nkubectl get nodeskubectl get pods -A\n\nå®‰è£…ç½‘ç»œæ’ä»¶\n\nkubectl apply -f scripts/calico.yaml\n\n\næ£€æŸ¥é›†ç¾¤å¹¶æ·»åŠ workerèŠ‚ç‚¹\n\n# æ‰€æœ‰workerèŠ‚ç‚¹ä¸Šæ‰§è¡Œkubeadm join 192.168.6.235:6443 --token r10sv8.8wdmesq0hl16ztxy \\    --discovery-token-ca-cert-hash sha256:fdcbd538e705dd0d68ea7d0aea289f09d1b3e461bab539c2f0b4262ae36762b9 # æŸ¥çœ‹nodeçŠ¶æ€kubectl get nodes\n\n\n\n\n\nå®‰è£…K8s nimikube å­¦ä¹ æµ‹è¯•ç‰ˆæœ¬curl -LO https://storage.googleapis.com/minikube/releases/latest/minikube-linux-amd64sudo install minikube-linux-amd64 /usr/local/bin/minikube# x86æ¶æ„ æ˜¯amd64  å¦‚æœæ˜¯armæ¶æ„çš„éœ€è¦æ¢æˆ arm64minikube start --driver=docker # å¦‚æœåˆ°è¿™æ­¥å¡ä½ æ˜¯å› ä¸ºç½‘ç»œé—®é¢˜æ‹‰ä¸åˆ°é•œåƒ # å¯ä»¥æ¢ä¸‹é¢çš„æ–¹æ³•minikube start \\  --image-mirror-country=cn \\  --registry-mirror=https://registry.cn-hangzhou.aliyuncs.com \\  --driver=docker# å¦‚æœè¿˜ä¸å¯ä»¥ é‚£æˆ‘ä»¬å°±ç”¨dockerå»æ‹‰é•œåƒ ç„¶ååœ¨minikubeçš„å¯åŠ¨å‚æ•°ä¸Šæ·»åŠ  --base-image=é•œåƒå# --base-image=registry.cn-hangzhou.aliyuncs.com/google_containers/kicbase:v0.0.46\nä¸çŸ¥é“è‡ªå·±æ˜¯ä»€ä¹ˆCPUæ¶æ„ï¼Ÿ\nuname -m# aarch64   aarch64å°±æ˜¯armæ¶æ„\nkubectl get ns local-path-storage -o json | jq â€˜del(.spec.finalizers)â€™| kubectl replace â€“raw â€œ&#x2F;api&#x2F;v1&#x2F;namespaces&#x2F;local-path-storage&#x2F;finalizeâ€ -f -\nK8så‘½ä»¤ğŸ§­ é›†ç¾¤ä¸ä¸Šä¸‹æ–‡ç®¡ç†\n\n\næ“ä½œ\nå‘½ä»¤\n\n\n\næŸ¥çœ‹é›†ç¾¤ä¿¡æ¯\nkubectl cluster-info\n\n\næŸ¥çœ‹å½“å‰ä¸Šä¸‹æ–‡\nkubectl config current-context\n\n\næŸ¥çœ‹æ‰€æœ‰ä¸Šä¸‹æ–‡\nkubectl config get-contexts\n\n\nåˆ‡æ¢ä¸Šä¸‹æ–‡\nkubectl config use-context &lt;context-name&gt;\n\n\nè®¾ç½®é»˜è®¤å‘½åç©ºé—´\nkubectl config set-context --current --namespace=&lt;namespace&gt;\n\n\nğŸ“¦ èµ„æºç®¡ç†ï¼ˆPodã€Deploymentã€Serviceï¼‰\n\n\næ“ä½œ\nå‘½ä»¤\n\n\n\næŸ¥çœ‹æ‰€æœ‰èµ„æº\nkubectl get all\n\n\næŸ¥çœ‹æ‰€æœ‰ Pod\nkubectl get pods [-n &lt;namespace&gt;] [-o wide]\n\n\næŸ¥çœ‹ Deployment\nkubectl get deployments\n\n\næŸ¥çœ‹ Service\nkubectl get svc\n\n\nåˆ›å»ºèµ„æº\nkubectl apply -f &lt;file.yaml&gt;\n\n\nåˆ é™¤èµ„æº\nkubectl delete -f &lt;file.yaml&gt;\n\n\nåˆ é™¤ Pod\nkubectl delete pod &lt;pod-name&gt;\n\n\næ»šåŠ¨é‡å¯ Deployment\nkubectl rollout restart deployment &lt;deployment-name&gt;\n\n\nä¿®æ”¹èµ„æºé…ç½®\nkubectl edit deployment &lt;deployment-name&gt;\n\n\nğŸ” æŸ¥çœ‹ä¸è°ƒè¯•\n\n\næ“ä½œ\nå‘½ä»¤\n\n\n\næŸ¥çœ‹æ—¥å¿—\nkubectl logs &lt;pod-name&gt;\n\n\nå®æ—¶æŸ¥çœ‹æ—¥å¿—\nkubectl logs -f &lt;pod-name&gt;\n\n\næŸ¥çœ‹å®¹å™¨æ—¥å¿—\nkubectl logs &lt;pod-name&gt; -c &lt;container-name&gt;\n\n\nè¿›å…¥å®¹å™¨ç»ˆç«¯\nkubectl exec -it &lt;pod-name&gt; -- /bin/bash\n\n\næŸ¥çœ‹ Pod ä¿¡æ¯\nkubectl describe pod &lt;pod-name&gt;\n\n\næŸ¥çœ‹é›†ç¾¤äº‹ä»¶\nkubectl get events\n\n\nğŸ§± å‘½åç©ºé—´ç®¡ç†\n\n\næ“ä½œ\nå‘½ä»¤\n\n\n\næŸ¥çœ‹å‘½åç©ºé—´\nkubectl get namespaces\n\n\nåˆ›å»ºå‘½åç©ºé—´\nkubectl create namespace &lt;name&gt;\n\n\nåˆ é™¤å‘½åç©ºé—´\nkubectl delete namespace &lt;name&gt;\n\n\nğŸ’¾ å­˜å‚¨ç®¡ç†ï¼ˆPVCã€PVï¼‰\n\n\næ“ä½œ\nå‘½ä»¤\n\n\n\næŸ¥çœ‹ PVC\nkubectl get pvc\n\n\næŸ¥çœ‹ PV\nkubectl get pv\n\n\nğŸ›  é…ç½®ç®¡ç†ï¼ˆConfigMapã€Secretï¼‰\n\n\næ“ä½œ\nå‘½ä»¤\n\n\n\nåˆ›å»º ConfigMap\nkubectl create configmap &lt;name&gt; --from-literal=key=value\n\n\næŸ¥çœ‹ ConfigMap\nkubectl get configmap\n\n\nåˆ›å»º Secret\nkubectl create secret generic &lt;name&gt; --from-literal=key=value\n\n\næŸ¥çœ‹ Secret\nkubectl get secrets\n\n\nğŸ“ˆ ç½‘ç»œä¸æœåŠ¡ï¼ˆServiceã€Ingressï¼‰\n\n\næ“ä½œ\nå‘½ä»¤\n\n\n\nåˆ›å»º Deployment\nkubectl create deployment &lt;name&gt; --image=&lt;image&gt;\n\n\nåˆ›å»º Service\nkubectl expose deployment &lt;name&gt; --port=80 --target-port=8080 --type=NodePort\n\n\næŸ¥çœ‹ Ingress\nkubectl get ingress\n\n\nğŸ§ª ä¸´æ—¶è°ƒè¯•ä¸å¯¼å‡º\n\n\næ“ä½œ\nå‘½ä»¤\n\n\n\nä¸´æ—¶å¯åŠ¨å®¹å™¨\nkubectl run -it --rm debug --image=busybox -- /bin/sh\n\n\nå¯¼å‡ºèµ„æºä¸º YAML\nkubectl get deployment &lt;name&gt; -o yaml &gt; deployment.yaml\n\n\nHelm K8sçš„ã€ŒåŒ…ç®¡ç†å·¥å…·ã€ä»€ä¹ˆæ˜¯ Chartï¼Ÿå®ƒæœ‰ä»€ä¹ˆä½œç”¨ï¼ŸChart æ˜¯ Helm çš„æ ¸å¿ƒæ¦‚å¿µï¼Œç®€å•è¯´å°±æ˜¯ï¼š\nChart æ˜¯ä¸€ä¸ªæ‰“åŒ…å¥½çš„ Kubernetes åº”ç”¨æ¨¡æ¿ï¼ŒåŒ…å«äº†ä¸€ç»„ YAML æ–‡ä»¶ + å‚æ•°é…ç½®æ–‡ä»¶ã€‚\nä¸€ä¸ª Chart åŒ…å«çš„å†…å®¹é€šå¸¸å¦‚ä¸‹ï¼š\nmychart/â”œâ”€â”€ Chart.yaml           # Chart çš„å…ƒä¿¡æ¯ï¼ˆåç§°ã€ç‰ˆæœ¬ç­‰ï¼‰â”œâ”€â”€ values.yaml          # é»˜è®¤å‚æ•°ï¼ˆå¯è¢« -f è¦†ç›–ï¼‰â”œâ”€â”€ templates/           # å­˜æ”¾å®é™…çš„ YAML æ¨¡æ¿â”‚   â”œâ”€â”€ deployment.yamlâ”‚   â”œâ”€â”€ service.yamlâ”‚   â””â”€â”€ _helpers.tpl     # å…¬å…±æ¨¡æ¿å‡½æ•°\nChart çš„ä½œç”¨ï¼š\n\n\n\nä½œç”¨\nè¯´æ˜\n\n\n\nğŸ“¦ æ‰“åŒ…\næŠŠä¸€å¥—å¤æ‚çš„éƒ¨ç½²é€»è¾‘ï¼ˆDeploymentã€Serviceã€Ingress ç­‰ï¼‰ç»Ÿä¸€å°è£…\n\n\nğŸ” å¤ç”¨\nä½ å¯ä»¥åå¤åœ¨ä¸åŒé›†ç¾¤ã€ä¸åŒç¯å¢ƒä¸­ä½¿ç”¨å®ƒï¼Œåªéœ€è¦ä¼ ä¸åŒå‚æ•°\n\n\nğŸ§© å‚æ•°åŒ–\né€šè¿‡ values.yaml é…ç½®æ–‡ä»¶ï¼Œçµæ´»æ§åˆ¶å‰¯æœ¬æ•°ã€é•œåƒã€ç«¯å£ç­‰\n\n\nğŸ” ç‰ˆæœ¬ç®¡ç†\nChart æ”¯æŒç‰ˆæœ¬æ§åˆ¶ï¼Œä¸ Helm release ä¸€èµ·å›æ»šå‡çº§\n\n\nğŸš€ å¿«é€Ÿéƒ¨ç½²\nä¸€æ¡å‘½ä»¤å³å¯éƒ¨ç½²å¤æ‚åº”ç”¨ï¼ˆä¾‹å¦‚ Lokiã€Prometheusã€GitLab ç­‰ï¼‰\n\n\nhelmå‘½ä»¤ğŸ“¦ Chart ä»“åº“ç®¡ç†helm repo add &lt;name&gt; &lt;url&gt;             # æ·»åŠ  Helm ä»“åº“helm repo list                         # æŸ¥çœ‹å·²æ·»åŠ çš„ä»“åº“helm repo update                       # æ›´æ–°ä»“åº“ä¿¡æ¯helm search repo &lt;keyword&gt;             # åœ¨ä»“åº“ä¸­æœç´¢ chart\nğŸ“¥ å®‰è£… &#x2F; å‡çº§helm install &lt;release-name&gt; &lt;chart&gt; -n &lt;namespace&gt; -f &lt;values.yaml&gt;# å®‰è£…ä¸€ä¸ª chartï¼Œæ¯”å¦‚ï¼š# helm install loki grafana/loki-stack -n monitor -f loki-values.yamlhelm upgrade &lt;release-name&gt; &lt;chart&gt; -n &lt;namespace&gt; -f &lt;values.yaml&gt;# å‡çº§å·²æœ‰çš„ releaseï¼Œä½†ä¸ä¼šè‡ªåŠ¨å®‰è£…helm upgrade --install &lt;release-name&gt; &lt;chart&gt; ...# å®‰è£…æˆ–å‡çº§ï¼ˆæ¨èç”¨äºè„šæœ¬æˆ– CI/CDï¼‰helm uninstall &lt;release-name&gt; -n &lt;namespace&gt;# å¸è½½ releasehelm rollback &lt;release-name&gt; &lt;revision&gt; -n &lt;namespace&gt;# å›æ»šåˆ°å†å²ç‰ˆæœ¬\nğŸ” çŠ¶æ€ &#x2F; æ—¥å¿— &#x2F; è°ƒè¯•helm list -n &lt;namespace&gt;             # æŸ¥çœ‹æŸä¸ªå‘½åç©ºé—´ä¸‹çš„ releasehelm status &lt;release-name&gt; -n &lt;namespace&gt;  # æŸ¥çœ‹ release çŠ¶æ€helm get values &lt;release-name&gt; -n &lt;namespace&gt;       # æŸ¥çœ‹å·²éƒ¨ç½²æ—¶ä½¿ç”¨çš„ valueshelm get manifest &lt;release-name&gt; -n &lt;namespace&gt;     # æŸ¥çœ‹æ¸²æŸ“åçš„ Kubernetes YAMLhelm history &lt;release-name&gt; -n &lt;namespace&gt;          # æŸ¥çœ‹å†å²ç‰ˆæœ¬\n\nKustomize æ˜¯ä»€ä¹ˆğŸ§© ä¸€å¥è¯æ€»ç»“ Helm ä¸ Kustomize çš„åŒºåˆ«ï¼š\nHelm æ˜¯â€œæ‰“åŒ…éƒ¨ç½²æ¨¡æ¿â€ç³»ç»Ÿï¼ŒKustomize æ˜¯â€œYAML è¡ç”Ÿå˜ç§â€ç³»ç»Ÿã€‚\nğŸ“¦ Kustomize æ˜¯ä»€ä¹ˆï¼Ÿ\nKustomize æ˜¯ Kubernetes åŸç”Ÿæ”¯æŒçš„é…ç½®ç®¡ç†å·¥å…·ï¼ˆkubectl ä» 1.14 èµ·å†…ç½®æ”¯æŒï¼‰ï¼Œå®ƒé€šè¿‡è¦†ç›–å’Œç»„åˆ YAML æ–‡ä»¶æ¥å®ç°â€œç›¸åŒåŸºç¡€ã€ä¸åŒç¯å¢ƒâ€çš„éƒ¨ç½²é…ç½®ã€‚\nä½ ä¸ç”¨å†™æ¨¡æ¿è¯­æ³•ï¼ˆåƒ Helm çš„ { { } } ï¼‰ï¼Œè€Œæ˜¯é€šè¿‡æ–‡ä»¶å¤¹ + patch çš„å½¢å¼ç»„åˆ YAMLã€‚\nğŸ§± Kustomize çš„ç»“æ„ï¼ˆå…¸å‹ç›®å½•ç¤ºä¾‹ï¼‰ï¼š\nmy-app/â”œâ”€â”€ base/   # åŸºç¡€éƒ¨ç½²é€»è¾‘ï¼Œé€‚ç”¨äºæ‰€æœ‰ç¯å¢ƒâ”‚   â”œâ”€â”€ deployment.yamlâ”‚   â”œâ”€â”€ service.yamlâ”‚   â””â”€â”€ kustomization.yamlâ”œâ”€â”€ overlays/  # ç¯å¢ƒä¸“å±é…ç½®ï¼Œé€šè¿‡ patch æˆ–å˜é‡è¦†ç›–åŸºç¡€é…ç½®â”‚   â”œâ”€â”€ dev/â”‚   â”‚   â”œâ”€â”€ kustomization.yamlâ”‚   â”‚   â””â”€â”€ patch.yamlâ”‚   â”œâ”€â”€ prod/â”‚   â”‚   â”œâ”€â”€ kustomization.yamlâ”‚   â”‚   â””â”€â”€ patch.yaml\n\nğŸ“Œ Kustomize æ”¯æŒçš„åŠŸèƒ½ï¼š\n\n\n\nåŠŸèƒ½\nè¯´æ˜\n\n\n\nnamePrefix &#x2F; nameSuffix\nç»™èµ„æºååŠ å‰ç¼€ &#x2F; åç¼€ï¼Œé¿å…å†²çª\n\n\nconfigMapGenerator &#x2F; secretGenerator\nè‡ªåŠ¨ç”Ÿæˆ ConfigMap &#x2F; Secret\n\n\npatchesStrategicMerge\néƒ¨åˆ†å­—æ®µæ‰“è¡¥ä¸\n\n\nimages æ›¿æ¢\nå¯ä»¥æŒ‡å®šé•œåƒç‰ˆæœ¬\n\n\nèµ„æºåˆå¹¶ &#x2F; ç»§æ‰¿\næ”¯æŒå¤šå±‚åµŒå¥—ç®¡ç† base å’Œ overlay\n\n\nğŸ” Helm vs Kustomizeï¼šæ ¸å¿ƒå¯¹æ¯”è¡¨\n\n\n\né¡¹ç›®\nHelm\nKustomize\n\n\n\næ¨¡æ¿æœºåˆ¶\nGo æ¨¡æ¿è¯­æ³• &#123;&#123; &#125;&#125;ï¼Œçµæ´»ä½†å¤æ‚\nåŸç”Ÿ YAML + Patchï¼Œç®€å•ç›´è§‚\n\n\nåº”ç”¨å°è£…\næ”¯æŒ Chart æ‰“åŒ…ï¼Œç‰ˆæœ¬æ§åˆ¶\næ— æ‰“åŒ…ï¼Œä»…ç»“æ„åŒ–ç»„ç»‡ç›®å½•\n\n\nå‚æ•°æ³¨å…¥æ–¹å¼\nvalues.yaml\npatch.yaml + kustomization.yaml\n\n\né€‚åˆåœºæ™¯\nç¬¬ä¸‰æ–¹åº”ç”¨éƒ¨ç½²ï¼ˆå¦‚ Prometheusã€Harborï¼‰\nè‡ªç ”é¡¹ç›®å¤šç¯å¢ƒç®¡ç†ï¼ˆå¦‚ dev&#x2F;test&#x2F;prodï¼‰\n\n\nå‘å¸ƒç‰ˆæœ¬å›æ»š\nHelm æœ‰ Release ç®¡ç†ï¼Œæ”¯æŒç‰ˆæœ¬å’Œå›æ»š\næ—  Release æ¦‚å¿µï¼Œé  Git æ§åˆ¶\n\n\nå®‰è£…æ–¹å¼\nhelm install\nkubectl apply -k æˆ– kustomize build\n\n\nğŸ§  å¯ä»¥è¿™æ ·è®°ï¼šHelm æ›´åƒæ˜¯ï¼šyum &#x2F; apt â€”â€” å®‰è£…åˆ«äººåšå¥½çš„åŒ…ï¼ˆå®˜æ–¹ã€ç¬¬ä¸‰æ–¹ç»„ä»¶ï¼‰    â€¢\tKustomize æ›´åƒæ˜¯ï¼šè‡ªå·±å†™ docker-compose.override.yml â€”â€” åœ¨è‡ªå·± YAML åŸºç¡€ä¸Šåšçµæ´»çš„ç¯å¢ƒå˜ä½“ç®¡ç†\nğŸš€ ä¸¾ä¸ªå®é™…ä¾‹å­\n# ä½ åœ¨ç”¨ Helm å®‰è£… Grafanaï¼šhelm install grafana grafana/grafana -f prod-values.yaml# ä½ åœ¨ç”¨ Kustomize éƒ¨ç½²è‡ªå·±å¼€å‘çš„ appï¼škubectl apply -k overlays/prod\n\n\nK8sè¿›é˜¶â‘  è°ƒåº¦ç›¸å…³    â€¢\tNodeSelector &#x2F; Affinity &#x2F; Taints &amp; Tolerationsï¼šç²¾ç»†æ§åˆ¶ Pod åœ¨å“ªäº›èŠ‚ç‚¹ä¸Šè¿è¡Œã€‚    â€¢\tnodeSelectorï¼šç®€å•æ ‡ç­¾åŒ¹é…ã€‚    â€¢\taffinityï¼šæ”¯æŒå¤šæ¡ä»¶ã€äº²å’Œ&#x2F;åäº²å’Œè°ƒåº¦ã€‚    â€¢\ttaints &amp; tolerationsï¼šç”¨äºâ€œæ‹’ç»éç‰¹å®šå®¹å¿æ¡ä»¶çš„ Podâ€è°ƒåº¦ã€‚    â€¢\tä¼˜å…ˆçº§ä¸æŠ¢å ï¼ˆPriority &amp; Preemptionï¼‰ï¼šé«˜ä¼˜å…ˆçº§çš„ Pod å¯ä»¥é©±é€ä½ä¼˜å…ˆçº§ Podã€‚\nâ¸»\nâ‘¡ å·¥ä½œè´Ÿè½½æ§åˆ¶å™¨    â€¢\tStatefulSetï¼šé€‚ç”¨äºæœ‰çŠ¶æ€åº”ç”¨ï¼ˆå¦‚æ•°æ®åº“ï¼‰ï¼Œæä¾›ç¨³å®šçš„ç½‘ç»œæ ‡è¯†å’ŒæŒä¹…å­˜å‚¨ã€‚    â€¢\tDaemonSetï¼šç¡®ä¿æ¯ä¸ªèŠ‚ç‚¹éƒ½è¿è¡Œä¸€ä¸ª Podï¼ˆå¸¸ç”¨äºæ—¥å¿—é‡‡é›†ã€ç›‘æ§ç­‰ï¼‰ã€‚    â€¢\tJob &#x2F; CronJobï¼šä¸€æ¬¡æ€§ä»»åŠ¡æˆ–å‘¨æœŸæ€§ä»»åŠ¡ï¼Œç±»ä¼¼ Linux çš„ cronã€‚    â€¢\tHorizontal Pod Autoscalerï¼ˆHPAï¼‰ï¼šæ ¹æ® CPU æˆ–è‡ªå®šä¹‰æŒ‡æ ‡è‡ªåŠ¨ä¼¸ç¼© Pod æ•°é‡ã€‚    â€¢\tVertical Pod Autoscalerï¼ˆVPAï¼‰ï¼šè‡ªåŠ¨è°ƒæ•´ Pod çš„èµ„æºè¯·æ±‚ï¼ˆç›®å‰åœ¨å¾ˆå¤šåœºæ™¯ä¸‹ä»è°¨æ…ä½¿ç”¨ï¼‰ã€‚    â€¢\tCluster Autoscalerï¼šèŠ‚ç‚¹èµ„æºä¸è¶³æ—¶è‡ªåŠ¨æ‰©å®¹åº•å±‚èŠ‚ç‚¹ã€‚\nâ¸»\nâ‘¢ ç½‘ç»œä¸æœåŠ¡å‘ç°    â€¢\tNetworkPolicyï¼šK8s çš„é˜²ç«å¢™ï¼Œå¯ä»¥é™åˆ¶ Pod é—´é€šä¿¡ã€‚    â€¢\tService Meshï¼ˆå¦‚ Istioã€Linkerdï¼‰ï¼šç”¨äºæµé‡ç®¡ç†ã€æœåŠ¡è§‚å¯Ÿã€ç†”æ–­ã€A&#x2F;B æµ‹è¯•ç­‰é«˜çº§æœåŠ¡æ²»ç†ã€‚\nâ¸»\nâ‘£ å­˜å‚¨ä¸æ•°æ®ç®¡ç†    â€¢\tStorageClassï¼šå®šä¹‰ä¸åŒçš„å­˜å‚¨ç­–ç•¥ï¼ˆæ…¢é€Ÿã€é«˜IOç­‰ï¼‰ï¼Œä¸ PVC é…åˆä½¿ç”¨ã€‚    â€¢\tVolumeSnapshot &#x2F; VolumeCloneï¼šå®ç° PVC å¿«ç…§å’Œå…‹éš†ï¼ˆé€‚åˆå¤‡ä»½ã€è¿˜åŸï¼‰ã€‚    â€¢\tCSIï¼ˆContainer Storage Interfaceï¼‰ï¼šæ’ä»¶åŒ–çš„å­˜å‚¨é©±åŠ¨æ ‡å‡†ï¼Œæ”¯æŒäº‘å‚å•†å’Œè‡ªå®šä¹‰å­˜å‚¨ã€‚\nâ¸»\nâ‘¤ å®‰å…¨    â€¢\tRBACï¼ˆRole-Based Access Controlï¼‰ï¼šåŸºäºè§’è‰²çš„æƒé™æ§åˆ¶ã€‚    â€¢\tPodSecurityPolicyï¼ˆå·²åºŸå¼ƒï¼‰&#x2F; Pod Security Admissionï¼šæ§åˆ¶ Pod çš„å®‰å…¨è¡Œä¸ºï¼ˆå¦‚æ˜¯å¦å…è®¸ç‰¹æƒæ¨¡å¼ï¼‰ã€‚    â€¢\tNetworkPolicyï¼šé™åˆ¶ç½‘ç»œè®¿é—®æƒé™ã€‚    â€¢\tServiceAccount &amp; Secretsï¼šèº«ä»½ç®¡ç†å’ŒåŠ å¯†æ•æ„Ÿä¿¡æ¯ã€‚\nâ¸»\nâ‘¥ å¯è§‚æµ‹æ€§ä¸è°ƒè¯•    â€¢\tEvents &#x2F; Probes &#x2F; Metrics APIï¼šè¯Šæ–­è¿è¡ŒçŠ¶å†µã€‚    â€¢\tæ—¥å¿—é‡‡é›†ï¼šLoki &#x2F; ELK &#x2F; Fluentd &#x2F; Promtailï¼šç»“åˆ DaemonSet æ”¶é›†é›†ç¾¤æ—¥å¿—ã€‚    â€¢\tTracingï¼šä½¿ç”¨ Jaeger&#x2F;Zipkin ç­‰è¿›è¡Œåˆ†å¸ƒå¼è¿½è¸ªã€‚    â€¢\tç›‘æ§å‘Šè­¦ï¼šPrometheus + Grafana + Alertmanagerï¼šå®Œæ•´çš„æŒ‡æ ‡ã€å‘Šè­¦ã€å¯è§†åŒ–ä½“ç³»ã€‚\nâ¸»\nâ‘¦ é«˜çº§éƒ¨ç½²ç­–ç•¥    â€¢\tCanary &#x2F; Blue-Green &#x2F; RollingUpdate &#x2F; Recreateï¼šæ”¯æŒå¤šç§å‡çº§ç­–ç•¥ã€‚    â€¢\tKustomize &#x2F; Helmï¼šæ›´å¼ºå¤§çš„èµ„æºæ‰“åŒ…å’Œç®¡ç†æ–¹å¼ï¼Œé€‚åˆå¤æ‚é¡¹ç›®ã€‚\nâ¸»\nâ‘§ å¹³å°æ‰©å±•èƒ½åŠ›    â€¢\tOperatorï¼ˆCRD + Controllerï¼‰ï¼šè‡ªå®šä¹‰æ§åˆ¶å™¨ç®¡ç†éåŸç”Ÿèµ„æºï¼Œæ¯”å¦‚éƒ¨ç½²è‡ªå·±çš„æ•°æ®åº“ã€ç¼“å­˜ã€‚    â€¢\tWebhooksï¼ˆMutating &#x2F; Validatingï¼‰ï¼šç”¨æ¥åœ¨èµ„æºåˆ›å»ºå‰åšæ‹¦æˆªå’Œä¿®æ”¹ã€‚    â€¢\tAdmission Controllerï¼šæ§åˆ¶èµ„æºåˆ›å»ºå’Œæ›´æ–°çš„â€œå®ˆé—¨å‘˜â€ã€‚\n","categories":["è¿ç»´","k8s"],"tags":["è¿ç»´","k8s"]},{"title":"Ansible","url":"/2025/04/23/Ansible/","content":"Ansible æ˜¯ä¸€ä¸ªè‡ªåŠ¨åŒ–è¿ç»´å·¥å…·ï¼Œå¯ä»¥å¸®ä½ ç”¨â€œä¸€æ®µè„šæœ¬â€è‡ªåŠ¨åšä¸€å †æœåŠ¡å™¨ä¸Šçš„é‡å¤å·¥ä½œï¼Œæ¯”å¦‚ï¼šè£…è½¯ä»¶ã€æ”¹é…ç½®ã€é‡å¯æœåŠ¡ã€éƒ¨ç½²é¡¹ç›®â€¦â€¦ä½ å¯ä»¥æŠŠå®ƒç†è§£æˆï¼šâ€œæˆ‘æŠŠè¦åšçš„äº‹æƒ…å†™è¿›ä¸€æœ¬â€˜å‰§æœ¬â€™ï¼ŒAnsible æ¥å¸®æˆ‘è¿œç¨‹åœ¨æœåŠ¡å™¨ä¸Šä¸€æ­¥æ­¥æ‰§è¡Œã€‚\nç®€ä»‹ğŸ”‘ Ansible çš„å·¥ä½œæœºåˆ¶ï¼ˆä¸€å¥è¯æ€»ç»“ï¼‰ï¼šä½ å†™å¥½è¦åšçš„äº‹æƒ…ï¼ˆPlaybookï¼‰ â†’ Ansible ç”¨ SSH è¿æ¥åˆ°ä½ çš„æœåŠ¡å™¨ â†’ æŒ‰æ­¥éª¤ä¸€æ¡æ¡æ‰§è¡Œä»»åŠ¡ã€‚ğŸ§± Ansible çš„åŸºç¡€ç»„æˆéƒ¨åˆ†ï¼š\n\nInventoryï¼ˆæ¸…å•ï¼‰ğŸ—‚ï¸å‘Šè¯‰ Ansible è¦è¿æ¥å“ªäº›æœåŠ¡å™¨ï¼Œç”¨ä»€ä¹ˆæ–¹å¼è¿æ¥ã€‚[webservers]192.168.1.10192.168.1.11[db]127.0.0.1 ansible_connection=local\nModulesï¼ˆæ¨¡å—ï¼‰ğŸ§© Ansible æä¾›çš„åŠŸèƒ½å°å·¥å…·ï¼Œæ¯”å¦‚â€œå®‰è£…è½¯ä»¶â€ã€â€œåˆ›å»ºæ–‡ä»¶â€ã€â€œå¯åŠ¨æœåŠ¡â€ç­‰ç­‰ï¼Œéƒ½æ˜¯æ¨¡å—å®Œæˆçš„ã€‚\n\n\n\n\næ¨¡å—\nç”¨é€”\n\n\n\napt&#x2F;yum\næŸ¥çœ‹ç½‘ç»œ\n\n\ncopy&#x2F;template\nåˆ›å»ºç½‘ç»œ\n\n\nservice\næŸ¥çœ‹ç½‘ç»œè¯¦æƒ…\n\n\nuser\nå°†å®¹å™¨åŠ å…¥æŸä¸ªç½‘ç»œ\n\n\ncommand&#x2F;shell\nå¯åŠ¨æ—¶æŒ‡å®šç½‘ç»œ\n\n\n\nPlaybookï¼ˆå‰§æœ¬ï¼‰ğŸ“œä½ å†™çš„ä¸€ä»½ .yaml æ–‡ä»¶ï¼Œå®šä¹‰äº†â€œåœ¨å“ªäº›æœºå™¨ä¸Šæ‰§è¡Œå“ªäº›ä»»åŠ¡â€ã€‚- hosts: all  become: yes  tasks:    - name: å®‰è£…nginx      apt:        name: nginx        state: present\nTasks(ä»»åŠ¡)ğŸ§¾Playbook ä¸­çš„æ¯ä¸€ä¸ªåŠ¨ä½œï¼Œæ¯”å¦‚â€œå®‰è£… nginxâ€ã€â€œå¤åˆ¶æ–‡ä»¶â€ï¼Œéƒ½å«ä¸€ä¸ªä»»åŠ¡ï¼ˆtaskï¼‰ã€‚\nVariablesï¼ˆå˜é‡ï¼‰ğŸ“¦ä½ å¯ä»¥ç»™ä¸€äº›å€¼èµ·åå­—ï¼Œæ–¹ä¾¿å¤ç”¨ã€‚æ¯”å¦‚ï¼švars:  nginx_port:8080\nRolesï¼ˆè§’è‰²ï¼‰ğŸ“è®©ä½ çš„é¡¹ç›®ç»“æ„æ›´æ¸…æ™°ï¼Œæ¯”å¦‚ä¸“é—¨æä¸€ä¸ª â€œnginxâ€ çš„æ–‡ä»¶å¤¹ï¼Œé‡Œé¢æ˜¯å®‰è£…ã€é…ç½®ã€é‡å¯ nginx çš„æ‰€æœ‰å†…å®¹ã€‚\n\nğŸ’¡ Ansible è·Ÿ Shell è„šæœ¬çš„åŒºåˆ«ï¼Ÿ\n\n\né¡¹ç›®\nShell è„šæœ¬\nAnsible\n\n\n\nå†™æ³•\nBash å‘½ä»¤ä¸²\nYAML å†™çš„ä»»åŠ¡æ¸…å•\n\n\nå¯è¯»æ€§\nä¸€èˆ¬\nå¾ˆé«˜ï¼Œæ˜“è¯»\n\n\nå¤ç”¨æ€§\nå·®\nå¥½ï¼Œæ”¯æŒå˜é‡å’Œæ¨¡å—\n\n\né”™è¯¯å¤„ç†\nè¦æ‰‹å†™åˆ¤æ–­\nè‡ªåŠ¨åˆ¤æ–­æ‰§è¡Œç»“æœ\n\n\nå¤šæœºéƒ¨ç½²\nè¦å¾ªç¯ + è¿œç¨‹å‘½ä»¤\nå¤©ç”Ÿå¤šæœºæ‰§è¡Œï¼ˆInventory é…ç½®å³å¯ï¼‰\n\n\nä½¿ç”¨Ansible\nğŸ§¾ ç¬¬ä¸€æ­¥ï¼šå‡†å¤‡ä½ çš„ Ansible ä¸»æœºæ¸…å•ï¼ˆInventoryï¼‰åˆ›å»ºä¸€ä¸ªhosts.iniçš„æ–‡ä»¶ï¼š[all]192.168.1.101192.168.1.102192.168.1.103192.168.1.104\nğŸ“Œ è¯´æ˜ï¼šè¿™é‡Œå®šä¹‰äº†ä¸€ä¸ªå« webservers çš„ç»„ï¼ŒåŒ…å«3å°è¦åˆ é™¤ Nginx çš„æœåŠ¡å™¨ IPã€‚ä½ å¯ä»¥æ¢æˆä½ è‡ªå·±çš„æœåŠ¡å™¨åœ°å€ã€‚\nğŸ› ï¸ ç¬¬äºŒæ­¥ï¼šå†™ä¸€ä¸ªä¸‹è½½ Nginx çš„ Playbookåˆ›å»ºä¸€ä¸ªåä¸º install_nginx.yml çš„ YAML æ–‡ä»¶ï¼š- name: install nginx  # æ­¤ä»»åŠ¡åç§°  hosts: all        # è¿™é‡Œçš„allæŒ‡å‘çš„æ˜¯hostsæ–‡ä»¶ä¸­çš„[all]  become: yes       # ä½¿ç”¨ sudo æƒé™æ‰§è¡Œ  tasks:      # ä¸‹é¢è¦æ‰§è¡Œçš„å…·ä½“ä»»åŠ¡åˆ—è¡¨    - name: install nginx    # ç¬¬ä¸€ä¸ªä»»åŠ¡ å®‰è£… nginx      apt:      # ä½¿ç”¨ apt æ¨¡å—        name: nginx     # è¦å®‰è£…çš„è½¯ä»¶åŒ…å: nginx        state: present    # ä¿è¯è½¯ä»¶åŒ…â€œå·²å®‰è£…â€çŠ¶æ€ï¼ˆä¸å­˜åœ¨å°±ä¼šè¢«å®‰è£…ï¼‰        update_cache: yes     # æ›´æ–° apt æºç¼“å­˜    - name: start nginx      # ç¬¬äºŒä¸ªä»»åŠ¡ å¯åŠ¨ nginx      service:   # ä½¿ç”¨ serviceæ¨¡å—æ“ä½œç³»ç»ŸæœåŠ¡        name: nginx     # æ“ä½œçš„æœåŠ¡åç§°: nginx        state: started    # ä¿è¯æœåŠ¡å¤„äº â€œå¯åŠ¨â€çŠ¶æ€        enabled: yes      #è®¾ç½®ä¸ºå¼€æœºè‡ªå¯\nâ–¶ï¸ ç¬¬ä¸‰æ­¥ï¼šè¿è¡Œè¿™ä¸ª Playbook å‘½ä»¤ansible-playbook -i ../hosts install_nginx.yml \n\nå®æˆ˜æ‰¹é‡å®‰è£… Kubernetes\nç¬¬ä¸€æ­¥ å…ˆåˆ›å»ºinventorymkdir -p ~/k8scd k8snano hosts.ini\nç¼–å†™hostsæ–‡ä»¶[all]172.17.50.246 ansible_user=h3d ansible_become=true ansible_become_method=sudo172.17.50.247 ansible_user=h3d ansible_become=true ansible_become_method=sudo172.17.50.248 ansible_user=h3d ansible_become=true ansible_become_method=sudo172.17.50.249 ansible_user=h3d ansible_become=true ansible_become_method=sudo[master]172.17.50.246[worker]172.17.50.247172.17.50.248172.17.50.249\n\nè®¾ç½®åŸºç¡€ç¯å¢ƒç”¨ansibleæ¥æ‰¹é‡è®¾ç½®masterå’Œworkerçš„ç¯å¢ƒ\n\nåˆ›å»ºplaybooknano setup.yml\n- name: base environment (shuting swap)  hosts: all  become: yes  tasks:    - name: shuting swap      shell: swapoff -a      ignore_errors: true    - name: permenant shuting swap      replace:        path: /etc/fstab        regexp: &#x27;^\\s*(.+?\\s+)+swap\\s+&#x27;        replace: &#x27;# \\1&#x27;      ignore_errors: true    - name: enable kernel module      shell: |        modprobe overlay        modprobe br_netfilter      ignore_errors: true    - name: deploy kernel arguments      copy:        dest: /etc/sysctl.d/k8s.conf        content: |          net.bridge.bridge-nf-call-ip6tables = 1          net.bridge.bridge-nf-call-iptables = 1    - name: apply sysctl configration      shell: sysctl --system\n\nå®¹å™¨é€‰æ‹©å› ä¸ºk8såœ¨1.24ç‰ˆæœ¬ç§»é™¤äº†dockerçš„æ”¯æŒï¼Œå› æ­¤æˆ‘ä»¬æ¨èä½¿ç”¨containerdæ¥åº§ä½k8sçš„å®¹å™¨ï¼Œå…·ä½“ä¸ºä»€ä¹ˆæˆ‘ä»¬ç§»æ­¥ K8s ç« èŠ‚è§‚çœ‹\n\nåˆ›å»ºplaybooknano install-containerd.yml\n\n- name: install containerd  hosts: all  become: yes  tasks:    - name: install containerd      apt:        name: containerd        state: present        update_cache: yes    - name: make containerd configuration file      file:        path: /etc/containerd        state: directory    - name: create default configuration file      shell: containerd config default &gt; /etc/containerd/config.toml      args:        creates: /etc/contaierd/config.toml    - name: enable SystemdCgroup (compatable kubernetes)      replace:        path: /etc/containerd/config.toml        regexp: &#x27;SystemdCgroup = false&#x27;        replace: &#x27;SystemdCgroup = true&#x27;    - name: restart &amp;&amp; enable containerd service      systemd:        name: containerd        enabled: yes        state: restarted\næˆ‘ä»¬åœ¨ä¸»èŠ‚ç‚¹ç”Ÿæˆé…ç½®æ–‡ä»¶\ncontainerd config default &gt; /etc/containerd/config.toml\næ‰¾åˆ°è¿™ä¸ªä½ç½®ï¼Œç¡®è®¤å­˜åœ¨å¹¶è®¾ç½®ä¸ºé˜¿é‡Œäº‘é•œåƒï¼š\n[plugins.&quot;io.containerd.grpc.v1.cri&quot;]  sandbox_image = &quot;registry.aliyuncs.com/google_containers/pause:3.8&quot;\nå‘ä¸‹ç»§ç»­æ‰¾åˆ° runc é…ç½®æ®µï¼Œè®¾ç½®å¦‚ä¸‹ï¼ˆä¸€å®šè¦åŠ ä¸Š SystemdCgroup &#x3D; trueï¼‰ï¼š\n[plugins.&quot;io.containerd.grpc.v1.cri&quot;.containerd.runtimes.runc.options]  SystemdCgroup = true\nå®‰è£…k8s\nåˆ›å»ºplaybooknano install-k8s.yml\nå†™å…¥ä»¥ä¸‹é…ç½®- name: install kubernetes module  hosts: all  become: yes  tasks:    - name: add Kubernetes source      copy:        dest: /etc/apt/sources.list.d/kubernetes.list        content: |          deb [trusted=yes] https://mirrors.aliyun.com/kubernetes/apt/ kubernetes-xenial main    - name: update apt source      apt:        update_cache: yes    - name: install kueblet kubeadm kubectl      apt:        name:          - kubelet          - kubeadm          - kubectl        state: present        update_cache: yes    - name: lock version      shell: apt-mark hold kubelet kubeadm kubectl\nè¿è¡Œansible-playbook -i ../hosts install-k8s.yml --ask-pass --ask-become-pass\n\n","categories":["è¿ç»´","Ansible"],"tags":["è¿ç»´","Ansible"]},{"title":"Docker/Kuberneteså†…ç½‘ç”Ÿäº§ç¯å¢ƒå¯¼è‡´é•œåƒæ— æ³•æ‹‰å–","url":"/2025/05/24/issuer/","content":"dockerå› ä¸ºå¢™çš„é—®é¢˜å¾ˆå¥½è§£å†³ï¼Œè¿™ç¯‡ä¸»è¦æ˜¯å…³äºä¼ä¸šå†…ç½‘è‡ªå»º1.24ç‰ˆæœ¬ä¹‹åçš„k8sé›†ç¾¤ï¼Œcontainerdæ— æ³•æ‹‰å–é•œåƒçš„é—®é¢˜ã€‚\nDockerç”±äº2024å¹´6æœˆå¼€å§‹å›½å†…çš„å¤§é‡dockeré•œåƒåœæœğŸ˜¤ï¼ŒDockeræ— æ³•ä¸‹è½½å®‰è£…é•œåƒæ— æ³•æ‹‰å–ğŸ˜­ è¯¦æƒ…æˆ‘åœ¨dockerç¯‡å·²ç»å†™è¿‡ã€‚è¿™é‡Œå°±ä¸å†èµ˜è¿°ã€‚\nK8s Containerdçš„è¿è¡Œæ—¶ä¸‹ç”±äºk8såœ¨1.24ç‰ˆæœ¬å¼ƒç”¨äº†dockerçš„æ”¯æŒ æ‰€ä»¥æ›´æ”¯æŒç”¨containerdæ¥è·‘å®¹å™¨ï¼Œå¯æ˜¯åœ¨æˆ‘ä»¬åœ¨åˆ›å»ºpodä»¥åŠå„ç§ç»„ä»¶containerdéƒ½ä¼šé»˜è®¤å»ä»dockerhubå»æ‹‰å–é•œåƒï¼Œåœ¨è¿™é‡Œä¸è®ºæˆ‘å»containerdçš„config.tomlæ–‡ä»¶ä¸‹æ·»åŠ é•œåƒæºä¹Ÿä¸ç®¡äº‹å„¿ï¼Œæ‹‰å–é•œåƒéƒ½æ˜¯å¤±è´¥ã€‚æ‰€ä»¥æˆ‘ç›´æ¥ç”¨æ¢¯å­çš„æ–¹å¼ç»™æˆ‘çš„å†…ç½‘é›†ç¾¤éƒ½æ·»åŠ ä¸Šäº†ä»£ç†ã€‚\nå¯æ˜¯åœ¨æ·»åŠ ä¸Šå…¨å±€ä»£ç†ä¹‹åï¼Œæˆ‘çš„k8sè¿˜æ˜¯æ‹‰ä¸åˆ°é•œåƒï¼Œ å› ä¸ºKubernetes çš„å®¹å™¨æ‹‰å–è¡Œä¸ºç”± å®¹å™¨è¿è¡Œæ—¶ï¼ˆå¦‚ containerdã€Dockerï¼‰ æ‰§è¡Œï¼Œå®ƒä»¬è¿è¡Œåœ¨ç³»ç»ŸæœåŠ¡ä¸­ï¼Œå¹¶ ä¸ç»§æ‰¿ä½  shell ä¸­çš„ä»£ç†ç¯å¢ƒå˜é‡ï¼ˆå¦‚ ALL_PROXYï¼‰ã€‚ç”±äºæˆ‘çš„ä»£ç†æ˜¯ç”¨shadowsocksåè®® æ˜¯å¦ä¸€å°æµ·å¤–çš„æœåŠ¡å™¨è‡ªå»ºçš„vpnéš§é“ï¼Œæˆ‘ç›´æ¥åœ¨æœ¬åœ°çš„å„ä¸ªèŠ‚ç‚¹ä¸‹è½½å¥½å®¢æˆ·ç«¯å°±è¡Œã€‚æ¥ä¸‹æ¥ æˆ‘ä»¬å¼€å¯å®Œæ•´çš„æ“ä½œæ­¥éª¤ è®©ä½ çš„å†…ç½‘è‡ªå»ºk8sé›†ç¾¤ä¹Ÿèƒ½è½»æ¾è®¿é—®å¤–ç½‘æ‹‰å–åˆ°é•œåƒã€‚\nç¬¬ä¸€æ­¥ï¼šåœ¨å…¬å¸æœåŠ¡å™¨ä¸Šå®‰è£… shadowsocks-libevï¼ˆä½œä¸ºå®¢æˆ·ç«¯ï¼‰\nsudo apt updatesudo apt install shadowsocks-libev -y# centos å°±æ›¿æ¢æˆ yum\nç¬¬äºŒæ­¥ï¼šé…ç½® Shadowsocks å®¢æˆ·ç«¯\nsudo nano /etc/shadowsocks-libev/config.json\nå¡«å…¥å¦‚ä¸‹å†…å®¹(æ”¹æˆä½ è‡ªå·±çš„)ï¼š\n&#123;    &quot;server&quot;:&quot;123.123.123.123&quot;,        // ä½ é¦™æ¸¯ECSçš„å…¬ç½‘IP    &quot;server_port&quot;:8388,                // SSç«¯å£    &quot;local_port&quot;:1080,                 // æœ¬åœ°ç›‘å¬ç«¯å£ï¼ˆé»˜è®¤1080ï¼‰    &quot;password&quot;:&quot;your_password&quot;,        // SSå¯†ç     &quot;timeout&quot;:300,    &quot;method&quot;:&quot;aes-256-gcm&quot;,            // åŠ å¯†æ–¹å¼ï¼Œéœ€ä¸ä½ çš„SSæœåŠ¡ç«¯ä¸€è‡´    &quot;fast_open&quot;: false&#125;\nç¬¬ä¸‰æ­¥ï¼šå¯åŠ¨ Shadowsocks å®¢æˆ·ç«¯\nsudo systemctl restart shadowsocks-libev-localsudo systemctl enable shadowsocks-libev-local\nå¦‚æœæ˜¾ç¤ºnotfoundè¯ é‚£å°±ä»£è¡¨æ²¡æœ‰å®ˆæŠ¤è¿›ç¨‹ è¿™é‡Œæˆ‘ä»¬éœ€è¦é…ç½®ä¸‹å®ˆæŠ¤è¿›ç¨‹\n\næˆ‘ä»¬ç”¨çš„æ˜¯ ss-local å‘½ä»¤ï¼ˆå®¢æˆ·ç«¯ï¼Œç»‘å®šæœ¬åœ° 127.0.0.1:1080ï¼‰which ss-local /usr/bin/ss-local   # å¤åˆ¶è¿™ä¸ª# å¦‚æœæ‰¾ä¸åˆ°ï¼Œè¯·å…ˆå®‰è£…sudo apt install shadowsocks-libev\nåˆ›å»º systemd æœåŠ¡æ–‡ä»¶ï¼šsudo nano /etc/systemd/system/ss-local.service\nå¡«å…¥ä»¥ä¸‹å†…å®¹ï¼ˆæ³¨æ„é…ç½®æ–‡ä»¶è·¯å¾„ä¸ä½ å®é™…ä¸€è‡´ï¼‰ï¼š[Unit]Description=Shadowsocks Local Client ServiceAfter=network.target[Service]ExecStart=/usr/bin/ss-local -c /etc/shadowsocks-libev/config.jsonRestart=on-failure[Install]WantedBy=multi-user.target\nå¦‚æœ ss-local è·¯å¾„ä¸æ˜¯ &#x2F;usr&#x2F;bin&#x2F;ss-localï¼Œè¯·ç”¨ which ss-local æ›¿æ¢å®ƒã€‚\né‡æ–°åŠ è½½ systemd å¹¶å¯åŠ¨æœåŠ¡ï¼šsudo systemctl daemon-reexecsudo systemctl daemon-reloadsudo systemctl start ss-local.servicesudo systemctl enable ss-local.service# æŸ¥çœ‹çŠ¶æ€ç¡®è®¤æ˜¯å¦å¯åŠ¨æˆåŠŸsudo systemctl status ss-local.service\nâœ… å¯åŠ¨æˆåŠŸåï¼Œä½ çš„æœ¬åœ° 127.0.0.1:1080 å°±å¯ä»¥ä½œä¸º socks5 ä»£ç†ä½¿ç”¨äº†ï¼šcurl --socks5-hostname 127.0.0.1:1080 https://google.com\nğŸ§ª é™„ï¼šæµ‹è¯• IP æ˜¯å¦æˆåŠŸé€šè¿‡ä»£ç†curl --socks5-hostname 127.0.0.1:1080 cip.cc\nç¬¬å››æ­¥ï¼šä½¿ç”¨ Privoxy è½¬æ¢ SOCKS5 â†’ HTTPè¿™é‡Œä½ ä¼šå‘ç°containerdè¿˜æ˜¯æ‹‰å–ä¸äº†é•œåƒï¼Œè¿™é‡Œæˆ‘ä»¬å°±éœ€è¦ä¸€ä¸ªPrivoxyå·¥å…·å°†SOCKS5â†’HTTP\n\nå®‰è£…å¹¶é…ç½®privoxy\nsudo apt install privoxy -y# é…ç½® Privoxy å°† HTTP è¯·æ±‚è½¬å‘ç»™ ss-local çš„ SOCKS5 ç«¯å£sudo nano /etc/privoxy/config\næ·»åŠ ä¸€è¡Œï¼ˆæ”¾åˆ°æ–‡ä»¶æœ€åï¼‰ï¼š\nforward-socks5t / 127.0.0.1:1080 . \nå¯åŠ¨å¹¶æ£€æŸ¥ç«¯å£ç›‘å¬\nsudo systemctl restart privoxysudo systemctl enable privoxy# æ£€æŸ¥ç›‘å¬ï¼šss -tuln | grep 8118# ä½ åº”è¯¥èƒ½çœ‹åˆ°ï¼š127.0.0.1:8118\nç¬¬äº”æ­¥ï¼šä¸ºå®¹å™¨è¿è¡Œæ—¶é…ç½®ä»£ç†\n\nåˆ›å»ºæˆ–ç¼–è¾‘ä»£ç†é…ç½®æ–‡ä»¶ï¼ˆcontainerd ä½¿ç”¨ systemd å¯åŠ¨ï¼‰ï¼šsudo mkdir -p /etc/systemd/system/containerd.service.dsudo nano /etc/systemd/system/containerd.service.d/http-proxy.conf\nå†…å®¹å¦‚ä¸‹ï¼ˆè¯·æ”¹ä¸ºä½ å®é™…ä½¿ç”¨çš„ä»£ç†ç«¯å£ï¼‰ï¼š[Service]Environment=&quot;HTTP_PROXY=http://127.0.0.1:8118&quot;Environment=&quot;HTTPS_PROXY=http://127.0.0.1:8118&quot;Environment=&quot;NO_PROXY=127.0.0.1,localhost,10.0.0.0/8,192.168.0.0/16&quot;\nğŸ§  æ³¨æ„ï¼šâ€¢\tcontainerd ä¸èƒ½ç›´æ¥è¯†åˆ« SOCKS5ï¼Œæ‰€ä»¥éœ€è¦ç”¨ä¸€ä¸ªé¢å¤–çš„æœ¬åœ° HTTP ä»£ç†è½¬æ¥ SOCKS5ï¼Œæˆ–è€…è®© ss-local å¯åŠ¨ä¸€ä¸ª http-local ç«¯å£\n\nè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥ç›´æ¥ç”¨containerdæ¥æ‹‰å–é•œåƒäº†ï¼\n"},{"title":"MCP å¤§æ¨¡å‹ä¸Šä¸‹æ–‡åè®®","url":"/2025/06/12/MCP/","content":"èƒŒæ™¯ä¸èŠå¤©æœºå™¨äººäº¤æµæ—¶ï¼Œå¤§æ¨¡å‹éœ€è¦è®°ä½ä¹‹å‰çš„å†…å®¹ï¼Œæ‰èƒ½ç»™å‡ºè¿è´¯çš„å›ç­”ã€‚è¿™äº›å†å²æ¶ˆæ¯å°±å«åšâ€œä¸Šä¸‹æ–‡â€ã€‚å¦‚æœä¸Šä¸‹æ–‡ä¸¢å¤±ï¼Œæ¨¡å‹å°±ä¼šç­”éæ‰€é—®ã€‚MCPï¼ˆModel Context Protocolï¼‰æ˜¯ä¸€å¥—ç®€å•çš„è®°å½•è§„åˆ™ï¼Œå¸®åŠ©æˆ‘ä»¬åœ¨ä¸åŒç³»ç»Ÿé—´å…±äº«è¿™äº›å¯¹è¯ä¿¡æ¯ã€‚\nä¸ºä»€ä¹ˆè¦ç”¨ MCP\nç»Ÿä¸€æ ¼å¼ï¼šæ‰€æœ‰æœåŠ¡éƒ½æŒ‰åŒä¸€ç§æ–¹å¼ä¿å­˜å’Œè¯»å–å¯¹è¯ï¼Œé¿å…æ··ä¹±ã€‚\næ¨¡å‹äº’é€šï¼šä¸€å¥—åè®®å³å¯è®©å¤šä¸ªæ¨¡å‹æˆ–æ’ä»¶å…±äº«ä¸Šä¸‹æ–‡ã€‚\nå¯è¿½æº¯ï¼šæ¶ˆæ¯æŒ‰èŠ‚ç‚¹å­˜å‚¨ï¼Œéšæ—¶èƒ½æŸ¥åˆ°æ¯ä¸€æ­¥è¯´äº†ä»€ä¹ˆã€‚\n\nåè®®ç»“æ„æ ¸å¿ƒæ¦‚å¿µ\nConversationï¼šä¸€æ¬¡å®Œæ•´çš„èŠå¤©ï¼Œå¯¹åº”å”¯ä¸€çš„ä¼šè¯ IDã€‚\nContextNodeï¼šå•æ¡æ¶ˆæ¯èŠ‚ç‚¹ï¼Œè®°å½•è§’è‰²å’Œå†…å®¹ï¼Œå¯æŒ‡å‘ä¸Šä¸€æ¡æ¶ˆæ¯ã€‚\nMetadataï¼šé™„åŠ ä¿¡æ¯ï¼Œå¦‚æ¨¡å‹å‚æ•°æˆ–æ’ä»¶çŠ¶æ€ã€‚\n\nç®€å•ç¤ºä¾‹&#123;  &quot;conversation_id&quot;: &quot;123456&quot;,  &quot;nodes&quot;: [    &#123;      &quot;id&quot;: &quot;node1&quot;,      &quot;role&quot;: &quot;user&quot;,      &quot;content&quot;: &quot;ä½ å¥½ï¼ŒMCP æ˜¯ä»€ä¹ˆï¼Ÿ&quot;,      &quot;timestamp&quot;: 1718200000    &#125;,    &#123;      &quot;id&quot;: &quot;node2&quot;,      &quot;role&quot;: &quot;assistant&quot;,      &quot;content&quot;: &quot;MCP æ˜¯ä¸€ç§ç”¨äºç®¡ç†å¤§æ¨¡å‹å¯¹è¯ä¸Šä¸‹æ–‡çš„åè®®ã€‚&quot;,      &quot;parent&quot;: &quot;node1&quot;,      &quot;timestamp&quot;: 1718200001    &#125;  ]&#125;\nè¿™é‡Œæ¯æ¡æ¶ˆæ¯éƒ½é€šè¿‡ parent å­—æ®µä¸ä¸Šä¸€æ¡ç›¸è¿ï¼Œå½¢æˆæ¸…æ™°çš„å¯¹è¯é“¾è·¯ã€‚è‹¥éœ€å¼•ç”¨æ›´æ—©çš„å†…å®¹ï¼Œå¯åœ¨èŠ‚ç‚¹ä¸­åˆ—å‡º referenceã€‚\nä¸Šä¸‹æ–‡ç®¡ç†æœåŠ¡å™¨ä¿å­˜æ•´ä¸ªä¼šè¯ï¼Œåªåœ¨éœ€è¦æ—¶æŠŠç›¸å…³ç‰‡æ®µä¼ ç»™æ¨¡å‹ã€‚å®¢æˆ·ç«¯åªéœ€å‘Šè¯‰æœåŠ¡å™¨æœ€æ–°çš„èŠ‚ç‚¹ç¼–å·ï¼Œæ— é¡»é‡å¤å‘é€æ‰€æœ‰å†å²æ¶ˆæ¯ã€‚\nå‚è€ƒå®ç°ç¤¾åŒºä¸­æœ‰ Node.js çš„ mcp-js ç­‰è½»é‡åº“ï¼Œå¯è‡ªåŠ¨è®°å½•æ¶ˆæ¯å¹¶ä»æ•°æ®åº“è¯»å–ã€‚æ¨ç†å‰æŒ‰é¡ºåºæ‹¼æ¥æ–‡æœ¬å³å¯ã€‚\nä¸å…¶ä»–ç³»ç»Ÿçš„åŒºåˆ«ä¼ ç»Ÿ API æ›´å¤šå…³æ³¨â€œä¸€é—®ä¸€ç­”â€ï¼Œè€Œ MCP è®°å½•äº†æ¶ˆæ¯ä¹‹é—´çš„å…³ç³»ã€‚é€šè¿‡ä¼šè¯ ID å’Œçˆ¶å­èŠ‚ç‚¹ï¼Œæˆ‘ä»¬å¯ä»¥é‡ç°å®Œæ•´çš„èŠå¤©è¿‡ç¨‹ã€‚\næœªæ¥å±•æœ›æœªæ¥å¯èƒ½è¿˜ä¼šå‡ºç°å›¾ç‰‡ã€è¯­éŸ³ç­‰å¯Œåª’ä½“å†…å®¹ã€‚MCP çš„å¼€æ”¾ç»“æ„å…è®¸åœ¨Metadata æˆ–èŠ‚ç‚¹ä¸­æ‰©å±•æ–°å­—æ®µï¼Œæ–¹ä¾¿é€‚åº”æ›´å¤šåœºæ™¯ã€‚\n","categories":["AI","MCP"],"tags":["å¤§æ¨¡å‹","åè®®"]}]