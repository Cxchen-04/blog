---
title: Kubernetes / K8s
date: 2025-04-13 15:19:50
tags: [è¿ç»´,k8s]
categories: [è¿ç»´, k8s]
cover: /images/k8s.png
---
## ç®€ä»‹
Kubernetesï¼ˆç®€ç§° K8sï¼‰æ˜¯ Google å¼€æºçš„å®¹å™¨ç¼–æ’å¹³å°ï¼Œå®ƒçš„æ ¸å¿ƒèƒ½åŠ›æ˜¯ï¼š

__è‡ªåŠ¨ç®¡ç†å¤§è§„æ¨¡å®¹å™¨ï¼šè¿è¡Œã€æ‰©å®¹ã€é‡å¯ã€æ•…éšœè½¬ç§»ã€æœåŠ¡å‘ç°ç­‰__

å®ƒçš„ç›®æ ‡æ˜¯ï¼šâ€œä½ åªç®¡è¯´â€˜æˆ‘éœ€è¦å‡ ä¸ªæœåŠ¡â€™ï¼ŒK8s æ¥å¸®ä½ éƒ¨ç½²ã€åˆ†é…ã€è°ƒåº¦ã€ç»´æŠ¤â€ã€‚

### å¼€å§‹å‰
1. å­¦ä¹  Kubernetes å‰ä½ éœ€è¦ä¼šçš„
   
| å¿…å¤‡çŸ¥è¯†                  | çŠ¶æ€  |
|---------------------------|-------|
| Linux åŸºæœ¬æ“ä½œ            | âœ…    |
| Dockerï¼ˆå®¹å™¨é•œåƒã€runã€volumeï¼‰ | âœ…    |
| CI/CD ç®€å•æ¦‚å¿µ            | âœ…    |
| Nginxã€Web æœåŠ¡éƒ¨ç½²       | âœ…    |
| YAML é…ç½®æ–‡ä»¶             | âœ…    |

ğŸ¥‡ å…¥é—¨é˜¶æ®µï¼šäº†è§£æ ¸å¿ƒæ¦‚å¿µï¼ˆå¯ä»¥ 2 å°æ—¶ææ‡‚ï¼‰

| æ ¸å¿ƒæ¦‚å¿µ     | ç®€å•ç†è§£                                                         |
|--------------|------------------------------------------------------------------|
| Pod          | å®¹å™¨çš„æœ€å°è¿è¡Œå•ä½ï¼Œ1~n ä¸ªå®¹å™¨ç»„æˆ                               |
| Node         | å·¥ä½œèŠ‚ç‚¹ï¼ˆæœ¬è´¨å°±æ˜¯æœåŠ¡å™¨ï¼‰                                      |
| Deployment   | å£°æ˜ä½ è¦è¿è¡Œå“ªäº› Podã€å¤šå°‘ä¸ªå‰¯æœ¬ã€æ€ä¹ˆå‡çº§                      |
| Service      | ç½‘ç»œæœåŠ¡ï¼Œæä¾›è®¿é—®å…¥å£ï¼ˆClusterIP / NodePortï¼‰                 |
| Namespace    | é¡¹ç›®éš”ç¦»ç©ºé—´ï¼ˆç±»ä¼¼ Git åˆ†æ”¯ï¼‰                                   |

ğŸ¥ˆ å®æ“é˜¶æ®µï¼šæœ¬åœ°éƒ¨ç½² K8sï¼Œè·‘ä¸ªæœåŠ¡

| æ–¹æ³•               | æ¨èå·¥å…·                                                    |
|--------------------|-------------------------------------------------------------|
| æœ¬åœ°å•èŠ‚ç‚¹æµ‹è¯•     | minikube âœ… æ¨èï¼ˆè½»é‡ + å®˜æ–¹ï¼‰                              |
| Docker Desktop å†…ç½® K8s | âœ… Mac ç”¨æˆ·ä¹Ÿé€‚åˆ                                       |
| ä½¿ç”¨ kubectl æ§åˆ¶é›†ç¾¤ | å¿…å¤‡ CLI å·¥å…·                                             |
| è·‘ä¸€ä¸ª Nginx       | åˆ›å»º Deployment + Service                                   |
| è·‘ä½ è‡ªå·±çš„åšå®¢é•œåƒ | æ¯”å¦‚ç”¨ä½ å·²æœ‰çš„é™æ€ HTML åšä¸€ä¸ª nginx å®¹å™¨è·‘èµ·æ¥             |

ğŸ¥‰ è¿›é˜¶é˜¶æ®µï¼šéƒ¨ç½² + é«˜å¯ç”¨ + CI/CD é›†æˆ

| æŠ€æœ¯ç‚¹                 | åº”ç”¨                                                       |
|------------------------|------------------------------------------------------------|
| Helm                   | K8s çš„ â€œåŒ…ç®¡ç†å™¨â€ï¼Œä¸€é”®éƒ¨ç½² WordPress / Redis / MySQL     |
| Ingress                | HTTP ä»£ç†è·¯ç”±å…¥å£ï¼Œæ¯”å¦‚å®ç° blog.karen.com               |
| ConfigMap + Secret     | é…ç½®æ³¨å…¥ï¼ˆå¦‚åšå®¢ configï¼‰                                 |
| Kustomize              | å¤šç¯å¢ƒé…ç½®ç®¡ç†                                             |
| GitOps                 | CI/CD è‡ªåŠ¨éƒ¨ç½²åˆ° K8sï¼ˆArgoCDã€Fluxï¼‰                      |
| Prometheus + Grafana   | é›†ç¾¤ç›‘æ§å¯è§†åŒ–                                             |

### Cluster é›†ç¾¤
1. ä¸€å¥è¯ç†è§£ä»€ä¹ˆæ˜¯â€œé›†ç¾¤â€ï¼ˆClusterï¼‰
é›†ç¾¤ = ä¸€ç»„â€œè”ç½‘åä½œçš„æœåŠ¡å™¨â€ï¼Œå®ƒä»¬å¯¹å¤–è¡¨ç°æˆâ€œä¸€ä¸ªæ•´ä½“â€æ¥æä¾›æœåŠ¡ã€‚
__â“é›†ç¾¤æ˜¯ä¸åŒåœ°åŒºçš„ä¸»æœºå—ï¼Ÿ__
__ä¸ä¸€å®šã€‚é›†ç¾¤å¯ä»¥åœ¨åŒä¸€æœºæˆ¿ï¼Œä¹Ÿå¯ä»¥è·¨åœ°åŒºï¼Œåªè¦ç½‘ç»œèƒ½é€šå°±å¯ä»¥å½¢æˆé›†ç¾¤ã€‚__
ä½†å¤§å¤šæ•°ä¼ä¸šä¸ºäº†æ€§èƒ½ï¼Œä¼šæŠŠé›†ç¾¤éƒ¨ç½²åœ¨åŒä¸€ä¸ªå±€åŸŸç½‘ / æ•°æ®ä¸­å¿ƒé‡Œï¼ˆæ¯”å¦‚é˜¿é‡Œäº‘ã€K8s äº‘æœåŠ¡é›†ç¾¤ï¼‰
__â“é›†ç¾¤æ˜¯â€œä¸€ä¸ªæœåŠ¡ç”¨ä¸€ç¾¤ä¸»æœºæ¥è·‘â€å—ï¼Ÿ__
    âœ… æ­£è§£ï¼
    ä½ å¯ä»¥ï¼š
        â€¢	æŠŠä¸€ä¸ªæœåŠ¡éƒ¨ç½²åˆ°å¤šä¸ªèŠ‚ç‚¹ä¸Šï¼Œåˆ†æ‘Šå‹åŠ›ï¼ˆæ¯”å¦‚ä½ çš„åšå®¢ + è´Ÿè½½å‡è¡¡ï¼‰
        â€¢	æŠŠå¤šä¸ªæœåŠ¡ï¼ˆåšå®¢ã€è¯„è®ºã€æ•°æ®åº“ï¼‰éƒ¨ç½²åˆ°åŒä¸€ä¸ªé›†ç¾¤ï¼Œèµ„æºå¤ç”¨
    Kubernetes ä¼šè‡ªåŠ¨å†³å®šï¼š
        â€¢	å“ªå°æœºå™¨èµ„æºå¤Ÿï¼Ÿå°±åˆ†é…ä¸Šå»
        â€¢	å“ªä¸ªæœåŠ¡éœ€è¦ 3 ä¸ªå‰¯æœ¬ï¼Ÿæˆ‘è‡ªåŠ¨å¸®ä½ éƒ¨ç½²åˆ° 3 å°èŠ‚ç‚¹
    	â€¢	å“ªä¸ªèŠ‚ç‚¹å®•æœºï¼Ÿè‡ªåŠ¨é‡å¯åˆ°åˆ«çš„èŠ‚ç‚¹ä¸Šï¼

2. ğŸ“¦ ç±»æ¯”è§£é‡Šä¸€ï¼šé›†ç¾¤å°±åƒä¸€ä¸ªâ€œå¨æˆ¿å›¢é˜Ÿâ€

â€¢	ä½ æƒ³ç‚¹ä¸€ä»½â€œå¤§é¤æœåŠ¡â€ï¼ˆæ¯”å¦‚éƒ¨ç½²ä½ åšå®¢ + æ•°æ®åº“ +è¯„è®ºç³»ç»Ÿï¼‰
â€¢	ä¸€ä¸ªå¨å¸ˆï¼ˆå•å°æœåŠ¡å™¨ï¼‰å¯èƒ½å¿™ä¸è¿‡æ¥
â€¢	æ‰€ä»¥ä½ è¯·äº†ä¸€æ•´ç»„å¨å¸ˆï¼ˆå¤šå°æœºå™¨ï¼‰
â€¢	å¨æˆ¿å›¢é˜Ÿï¼ˆé›†ç¾¤ï¼‰ä¼šè‡ªåŠ¨å†³å®šï¼š
â€¢	è°ç…®ä¸»èœï¼Ÿ
â€¢	è°è´Ÿè´£ç‚’èœï¼Ÿ
â€¢	ä¸‡ä¸€ä¸€ä¸ªå¨å¸ˆå€’ä¸‹ï¼ˆå®•æœºï¼‰ï¼Œè°æ¥é¡¶ä¸Šï¼Ÿ

âœ… è¿™æ•´ä¸ªå¨æˆ¿å›¢é˜Ÿ = â€œé›†ç¾¤â€
âœ… ä»–ä»¬ä¹‹é—´çš„åˆ†å·¥ã€è°ƒåº¦ã€æ•…éšœåˆ‡æ¢ = Kubernetes æ¥è´Ÿè´£

3. ğŸ“Œ æŠ€æœ¯ä¸€ç‚¹è¯´ï¼š

| åç§°                     | å«ä¹‰                                                         |
|--------------------------|--------------------------------------------------------------|
| é›†ç¾¤ (Cluster)           | ä¸€ç»„é€šè¿‡ç½‘ç»œè¿æ¥çš„â€œèŠ‚ç‚¹â€æœåŠ¡å™¨                              |
| èŠ‚ç‚¹ (Node)              | é›†ç¾¤ä¸­çš„ä¸€å°æœºå™¨ï¼Œå¯ä»¥æ˜¯è™šæ‹Ÿæœºæˆ–ç‰©ç†æœº                      |
| ä¸»èŠ‚ç‚¹ (Master)          | ç®¡ç†æ•´ä¸ªé›†ç¾¤çš„å¤§è„‘ï¼Œè´Ÿè´£è°ƒåº¦ã€ç›‘æ§ã€API                     |
| å·¥ä½œèŠ‚ç‚¹ (Worker)        | å®é™…è·‘ä½ åº”ç”¨çš„æœºå™¨ï¼ˆæ¯”å¦‚è·‘ nginx / åšå®¢ï¼‰                   |
#### k8sä¸­çš„â€œé›†ç¾¤ç»“æ„å›¾â€

``` bash
             [ Master æ§åˆ¶èŠ‚ç‚¹ ]
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚  è°ƒåº¦æœåŠ¡ kube-scheduler
            â”‚  API Server
            â”‚  çŠ¶æ€æ§åˆ¶å™¨
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â†“
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â†“              â†“              â†“
 [Worker Node1]   [Worker Node2]  [Worker Node3]
   â””â”€Pod: Nginx     â””â”€Pod: Blog     â””â”€Pod: Redis
   â””â”€Pod: Mongo     â””â”€Pod: Hexo     â””â”€Pod: è¯„è®ºç³»ç»Ÿ
```
__ç°å®ä¸­çš„â€œé›†ç¾¤â€éƒ½ç”¨åœ¨å“ªï¼Ÿ__

| åœºæ™¯             | åº”ç”¨                          |
|-----------------|--------------------------------------|
| å¤§å…¬å¸ç½‘ç«™         | å¤šåœ°éƒ¨ç½²ï¼Œå½¢æˆå…¨çƒK8sé›†ç¾¤(CDN+æœåŠ¡èŠ‚ç‚¹) |
| ä¼ä¸šSaaSå¹³å°      | ç”¨é›†ç¾¤æå‡é«˜å¯ç”¨æ€§+è‡ªåŠ¨æ‰©å®¹èƒ½åŠ› |
| äº‘æœåŠ¡å•†          | ç”¨æˆ·åªç”¨ç”³è¯·ä¸€ä¸ªâ€œé›†ç¾¤â€ï¼ŒèƒŒåå…¨è‡ªåŠ¨   ï½œ

##### é›†ç¾¤æ˜¯å¤šå°ä¸»æœºç»„æˆçš„â€œä¸€ä¸ªå¤§è„‘ + å¤šä¸ªæ‰‹â€çš„å›¢é˜Ÿã€‚K8s è´Ÿè´£è°ƒåº¦å¤§è„‘ï¼Œè®©æ¯ä¸ªæœåŠ¡éƒ½èƒ½ç¨³å®šè¿è¡Œï¼Œæ‰äº†å°±è¡¥ã€æ…¢äº†å°±æ‰©ã€‚

## å®‰è£…K8s
``` bash
curl -LO https://storage.googleapis.com/minikube/releases/latest/minikube-linux-amd64
sudo install minikube-linux-amd64 /usr/local/bin/minikube
# x86æ¶æ„ æ˜¯amd64  å¦‚æœæ˜¯armæ¶æ„çš„éœ€è¦æ¢æˆ arm64
minikube start --driver=docker # å¦‚æœåˆ°è¿™æ­¥å¡ä½ æ˜¯å› ä¸ºç½‘ç»œé—®é¢˜æ‹‰ä¸åˆ°é•œåƒ 
# å¯ä»¥æ¢ä¸‹é¢çš„æ–¹æ³•
minikube start \
  --image-mirror-country=cn \
  --registry-mirror=https://registry.cn-hangzhou.aliyuncs.com \
  --driver=docker
# å¦‚æœè¿˜ä¸å¯ä»¥ é‚£æˆ‘ä»¬å°±ç”¨dockerå»æ‹‰é•œåƒ ç„¶ååœ¨minikubeçš„å¯åŠ¨å‚æ•°ä¸Šæ·»åŠ  --base-image=é•œåƒå
# --base-image=registry.cn-hangzhou.aliyuncs.com/google_containers/kicbase:v0.0.46
```
ä¸çŸ¥é“è‡ªå·±æ˜¯ä»€ä¹ˆCPUæ¶æ„ï¼Ÿ
``` bash
uname -m
# aarch64   aarch64å°±æ˜¯armæ¶æ„
```
## K8så‘½ä»¤
1. ğŸš€ é›†ç¾¤ä¸é…ç½®
``` bash
# æŸ¥çœ‹é›†ç¾¤ä¿¡æ¯
kubectl cluster-info

# æŸ¥çœ‹å½“å‰ä¸Šä¸‹æ–‡
kubectl config current-context

# è®¾ç½®ä¸Šä¸‹æ–‡ï¼ˆåˆ‡æ¢é›†ç¾¤ã€å‘½åç©ºé—´ç­‰ï¼‰
kubectl config use-context <context-name>

# æŸ¥çœ‹æ‰€æœ‰ä¸Šä¸‹æ–‡
kubectl config get-contexts
```
2. ğŸ“¦ èµ„æºç®¡ç†ï¼ˆPods, Deployments, Servicesç­‰ï¼‰

``` bash
# æŸ¥çœ‹æ‰€æœ‰èµ„æº
kubectl get all

# æŸ¥çœ‹æ‰€æœ‰Pod
kubectl get pods [-n <namespace>] [-o wide]

# æŸ¥çœ‹Deployment
kubectl get deployments

# æŸ¥çœ‹Service
kubectl get svc

# åˆ›å»ºèµ„æº
kubectl apply -f <file.yaml>

# åˆ é™¤èµ„æº
kubectl delete -f <file.yaml>
kubectl delete pod <pod-name>

# æ›´æ–°èµ„æº
kubectl edit deployment <deployment-name>

# æ»šåŠ¨æ›´æ–°
kubectl rollout restart deployment <deployment-name>
```
3. ğŸ” æŸ¥çœ‹ä¸è°ƒè¯•
``` bash
# æŸ¥çœ‹ Pod æ—¥å¿—
kubectl logs <pod-name>
kubectl logs -f <pod-name>  # å®æ—¶æŸ¥çœ‹

# æŸ¥çœ‹æŸä¸ªå®¹å™¨çš„æ—¥å¿—ï¼ˆå¤šå®¹å™¨ Podï¼‰
kubectl logs <pod-name> -c <container-name>

# è¿›å…¥ Podï¼ˆç»ˆç«¯ï¼‰
kubectl exec -it <pod-name> -- /bin/bash

# æè¿°èµ„æº
kubectl describe pod <pod-name>

# æŸ¥çœ‹äº‹ä»¶
kubectl get events
```
4. ğŸ’¾ å­˜å‚¨ï¼ˆPVC, PVï¼‰
``` bash
# æŸ¥çœ‹æŒä¹…å·å£°æ˜
kubectl get pvc

# æŸ¥çœ‹æŒä¹…å·
kubectl get pv
```
5. ğŸ¯ éƒ¨ç½²ä¸æœåŠ¡ï¼ˆDeployment, Service, Ingressï¼‰
``` bash
# åˆ›å»º Deployment
kubectl create deployment <name> --image=<image-name>

# å¯¹å¤–æš´éœ²ç«¯å£ï¼ˆåˆ›å»º Serviceï¼‰
kubectl expose deployment <deployment-name> --port=80 --target-port=8080 --type=NodePort

# æŸ¥çœ‹ Ingress
kubectl get ingress
```
6. ğŸ”§ é…ç½®èµ„æºï¼ˆConfigMap, Secretï¼‰
``` bash
# åˆ›å»º ConfigMap
kubectl create configmap <name> --from-literal=key=value

# æŸ¥çœ‹ ConfigMap
kubectl get configmap

# åˆ›å»º Secret
kubectl create secret generic <name> --from-literal=password=123456

# æŸ¥çœ‹ Secret
kubectl get secrets
```
7. ğŸ§ª è°ƒè¯•å’Œæµ‹è¯•
``` bash
# è¿è¡Œä¸€ä¸ªä¸´æ—¶Podè¿›è¡Œæµ‹è¯•
kubectl run -it --rm debug --image=busybox -- /bin/sh

# æŸ¥çœ‹PodçŠ¶æ€
kubectl get pod <pod-name> -o json
```
8. ğŸ“„ YAML ç”Ÿæˆå’Œå¯¼å‡º
``` bash
# å¯¼å‡ºèµ„æºä¸ºyaml
kubectl get deployment <name> -o yaml > deployment.yaml
```
9.  ğŸš« åˆ é™¤èµ„æº
``` bash
# åˆ é™¤æ‰€æœ‰èµ„æº
kubectl delete all --all

# åˆ é™¤å‘½åç©ºé—´
kubectl delete namespace <name>
```