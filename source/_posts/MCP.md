---
title: MCP 大模型上下文协议
date: 2025-06-12 18:11:27
tags: [大模型, 协议]
categories: [AI, MCP]
---

## 背景

当我们与大模型聊天时，模型需要记住之前说过的话才能正确回答。这些聊天记录就叫做“上下文”。如果上下文丢失，模型可能会忘记我们聊到哪一步，回答也会变得奇怪。MCP（Model Context Protocol）就是一套简单的规则，用来统一记录和传递这些聊天内容，让模型在不同场景下都能正确理解对话。

## MCP 有什么用

1. **统一格式**：不论是哪个模型，都能用同样的方式保存对话记录。
2. **模型互通**：不同的服务可以根据同一套规则交换上下文，不容易出错。
3. **完整追溯**：聊天记录以节点的形式保存，方便回看每一步都说了什么。

## 协议结构

### 核心概念

- **Conversation**：一次完整的聊天，拥有唯一的会话 ID。
- **ContextNode**：每一条消息，就是一个节点，记录了角色和内容。
- **Metadata**：可以附加一些额外信息，比如模型的设置或插件状态。

### 消息结构示例

```json
{
  "conversation_id": "123456",
  "nodes": [
    {
      "id": "node1",
      "role": "user",
      "content": "你好，MCP 是什么？",
      "timestamp": 1718200000
    },
    {
      "id": "node2",
      "role": "assistant",
      "content": "MCP 是一种用于管理大模型对话上下文的协议。",
      "parent": "node1",
      "timestamp": 1718200001
    }
  ]
}
```

上面的 JSON 展示了 MCP 最简单的格式：每条消息都可以通过 `parent` 字段关联上一条内容，形成一条清晰的聊天记录。如果需要引用更早的内容，也可以在节点里列出相关的 `reference`。

### 上下文管理

服务端会保存整条聊天记录，只在需要时把相关片段传给模型。这样客户端不必每次都发送所有历史消息，只需告诉服务端最新的节点编号即可。

## 参考实现

已有社区用 Node.js 写了 `mcp-js` 这类简单框架，可以在请求时自动记录并读取节点。服务端把节点存进数据库或内存，模型推理前只需按顺序拼接内容即可。

## 与现有系统的区别

与传统的 REST 或 WebSocket 接口只关注一次请求不同，MCP 会记录消息之间的关系，让模型在跨服务合作时仍能保持正确的上下文。通过会话 ID 和父子节点关系，我们能清楚地看到对话的每一步。

## 未来展望

未来聊天内容可能不止文字，还会包含图片或语音等信息。MCP 设计得比较开放，可以在 `Metadata` 或节点里扩展新字段，适应不同的需求。如果大家都采用 MCP，大模型在各种应用场景下就能更好地协同工作。

