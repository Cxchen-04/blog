---
title: Prometheus+Grafana
date: 2025-03-30 13:43:43
tags: [è¿ç»´,ç›‘æ§,]
categories: [è¿ç»´,ç›‘æ§,Prometheus+Grafana]
cover: /images/ç›‘æ§.png
---
## ç®€ä»‹
#### ğŸ” Prometheus æ˜¯ä»€ä¹ˆï¼Ÿ

Prometheus æ˜¯ä¸€ä¸ªâ€œç›‘æ§å’Œæ•°æ®é‡‡é›†ç³»ç»Ÿâ€ï¼Œç®€å•ç†è§£å°±æ˜¯ä¸€ä¸ªâ€œæ”¶é›†æ•°æ®çš„ä»“åº“+å¤§è„‘â€ã€‚

ğŸ“¦ å®ƒä¸»è¦åšè¿™äº›äº‹ï¼š
	â€¢	é‡‡é›†æ•°æ®ï¼šæ¯”å¦‚æœåŠ¡å™¨çš„ CPU ä½¿ç”¨ç‡ã€å†…å­˜å ç”¨ã€ç½‘ç»œæµé‡ã€è¯·æ±‚æ¬¡æ•°ç­‰ã€‚
	â€¢	å­˜å‚¨æ•°æ®ï¼šæŠŠè¿™äº›æ•°æ®ä»¥æ—¶é—´åºåˆ—çš„å½¢å¼å­˜åˆ°è‡ªå·±çš„æ•°æ®åº“é‡Œã€‚
	â€¢	æŸ¥è¯¢æ•°æ®ï¼šæ”¯æŒç”¨ä¸“é—¨çš„ PromQL è¯­è¨€æŸ¥è¯¢ã€ç­›é€‰ã€èšåˆå„ç§æŒ‡æ ‡ã€‚
	â€¢	è®¾ç½®å‘Šè­¦ï¼šå¯ä»¥è®¾ç½®è§„åˆ™ï¼Œå½“æŸä¸ªæŒ‡æ ‡å¼‚å¸¸æ—¶è§¦å‘å‘Šè­¦ï¼ˆä¾‹å¦‚ CPU è¿ç»­5åˆ†é’Ÿè¶…è¿‡ 90%ï¼‰ã€‚

ğŸ‘€ ç®€å•è¯´ï¼Œå®ƒæ˜¯â€œé‡‡é›†ã€å­˜ã€æŸ¥ã€æŠ¥â€çš„ä¸€å¥—ç³»ç»Ÿï¼Œä¸è´Ÿè´£å¯è§†åŒ–ã€‚

#### ğŸ“Š Grafana æ˜¯ä»€ä¹ˆï¼Ÿ

Grafana æ˜¯ä¸€ä¸ªæ•°æ®å¯è§†åŒ–å·¥å…·ï¼Œç”¨æ¥â€œæŠŠæ•°æ®å˜æˆå›¾è¡¨â€ã€‚

ğŸ¨ å®ƒä¸»è¦åšè¿™äº›äº‹ï¼š
	â€¢	è¿æ¥æ•°æ®æºï¼šæ¯”å¦‚è¿æ¥ Prometheusï¼Œè¯»å–é‡Œé¢çš„æŒ‡æ ‡æ•°æ®ã€‚
	â€¢	ç»˜åˆ¶å›¾è¡¨å’Œä»ªè¡¨ç›˜ï¼šä½ å¯ä»¥ç”¨å®ƒåˆ¶ä½œæ¼‚äº®çš„å›¾ã€çº¿ã€é¥¼å›¾ã€çƒ­å›¾ç­‰å„ç§å½¢å¼ã€‚
	â€¢	è®¾ç½®ä»ªè¡¨ç›˜ï¼šå°†ä¸åŒçš„æ•°æ®ç»„åˆæˆç»Ÿä¸€çš„ç›‘æ§é¢æ¿ï¼Œä¾¿äºä¸€çœ¼çœ‹å‡ºç³»ç»Ÿå¥åº·çŠ¶å†µã€‚
	â€¢	å‘Šè­¦é€šçŸ¥ï¼šGrafana ä¹Ÿæ”¯æŒè®¾ç½®å‘Šè­¦ï¼ˆä½†æ•°æ®è¿˜æ˜¯ä» Prometheus æ¥ï¼‰ã€‚

ğŸ‘€ ç®€å•è¯´ï¼Œå®ƒæ˜¯â€œè¯»æ•° + ç”»å›¾ + å±•ç¤ºâ€çš„ä¸€å¥—ç³»ç»Ÿï¼Œä¸è´Ÿè´£é‡‡é›†å’Œå­˜å‚¨ã€‚

## å®‰è£…
#### æ­¥éª¤ä¸€ å®‰è£…Node Exporterï¼ˆç›‘æ§æœåŠ¡å™¨æ€§èƒ½ï¼‰
Node Exporteræ˜¯Prometheusçš„å®˜æ–¹å·¥å…·ï¼Œå¯ä»¥å¸®åŠ©é‡‡é›†æœåŠ¡å™¨çš„ç¡¬ä»¶æŒ‡æ ‡ï¼ˆCPUã€å†…å­˜ã€ç£ç›˜ç­‰ï¼‰ã€‚

``` bash Ubuntu
ssh root@ä½ çš„æœåŠ¡å™¨ip

sudo useradd --no-create-home --shell /bin/false node_exporter
# åˆ›å»ºnode_exporterç”¨æˆ·(å®‰å…¨èµ·è§)

wget https://github.com/prometheus/node_exporter/releases/download/v1.7.0/node_exporter-1.7.0.linux-amd64.tar.gz
tar xvf node_exporter-1.7.0.linux-amd64.tar.gz
sudo cp node_exporter-1.7.0.linux-amd64/node_exporter /usr/local/bin/
# ä¸‹è½½å¹¶è§£å‹node_exporter

sudo nano /etc/systemd/system/node_exporter.service
# è®¾ç½®systemdå¯åŠ¨æœåŠ¡
```
å†™å…¥ä»¥ä¸‹å†…å®¹
``` bash Ubuntu
[Unit]
Description=Node Exporter
After=network.target

[Service]
User=node_exporter
ExecStart=/usr/local/bin/node_exporter #æ–‡ä»¶è·¯å¾„

[Install]
WantedBy=default.target
```
å¯åŠ¨å¹¶è®¾ç½®å¼€æœºå¯åŠ¨
``` bash Ubuntu
sudo systemctl daemon-reexec
sudo systemctl start node_exporter
sudo systemctl enable node_exporter
```
æµ‹è¯•ä¸€ä¸‹ï¼š
æ‰“å¼€æµè§ˆå™¨è®¿é—®ï¼š
http://ä½ çš„æœåŠ¡å™¨IP:9100/metrics
å¦‚æœèƒ½çœ‹åˆ°ä¸€å †æŒ‡æ ‡æ–‡å­—ï¼Œè¯´æ˜æˆåŠŸï¼

#### æ­¥éª¤äºŒ å®‰è£…Prometheus
ä¸‹è½½Prometheusï¼š
``` bash Ubuntu
wget https://github.com/prometheus/prometheus/releases/download/v2.50.0/prometheus-2.50.0.linux-amd64.tar.gz
tar xvf prometheus-2.50.0.linux-amd64.tar.gz # è§£å‹
cd prometheus-2.50.0.linux-amd64 
# è¿›å…¥æ–‡ä»¶å¤¹é‡Œé¢åˆ›å»º.ymlæ–‡ä»¶

nano prometheus.yml # åˆ›å»ºprometheusé…ç½®æ–‡ä»¶
```
å†™å…¥ä¸€ä¸‹å†…å®¹ï¼š
``` bash Ubuntu
global:         # ä¸€å®šè¦å†™æ­£ç¡®æ ¼å¼ï¼ŒåŒ…æ‹¬ç©ºæ ¼ä»¥åŠé‡å¤å®šä¹‰
  scrape_interval: 15s

scrape_configs:
  - job_name: 'node_exporter'
    static_configs: # è¿™ä¸ªå¯èƒ½ä¼šæœ‰å†²çª 
      - targets: ['localhost:9100'] 

  - job_name: 'website_http_check'
    metrics_path: /probe
    params:
      module: [http_2xx]
    static_configs:
      - targets:
          - http://ä½ çš„åŸŸåæˆ–è€…IP
    relabel_configs:
      - source_labels: [__address__]
        target_label: __param_target
      - source_labels: [__param_target]
        target_label: instance
      - target_label: __address__
        replacement: localhost:9115  # blackbox_exporter ç›‘å¬ç«¯å£
```

#### æ­¥éª¤ä¸‰ å®‰è£…Blackbox Exporter(æ¢æµ‹ç½‘ç«™çŠ¶æ€)
``` bash Ubuntu
wget https://github.com/prometheus/blackbox_exporter/releases/download/v0.25.0/blackbox_exporter-0.25.0.linux-amd64.tar.gz
tar xvf blackbox_exporter-0.25.0.linux-amd64.tar.gz
cd blackbox_exporter-0.25.0.linux-amd64 
./blackbox_exporter     # è¿›å…¥æ–‡ä»¶å¤¹å¯åŠ¨
# ä¹Ÿå¯ä»¥æ·»åŠ systemdå¯åŠ¨æœåŠ¡ï¼Œå’Œnode_exporterç±»ä¼¼ã€‚
```

#### æ­¥éª¤å›› å¯åŠ¨prometheus
``` bash Ubuntu
./prometheus --config.file=prometheus.yml
```
è®¿é—®æµè§ˆå™¨ï¼š
http://ä½ çš„æœåŠ¡å™¨IP:9090ï¼Œä½ åº”è¯¥å¯ä»¥çœ‹åˆ° Prometheus çš„ Web é¡µé¢ã€‚

#### ğŸ“Š æ­¥éª¤äº”ï¼šå®‰è£… Grafana
``` bash
sudo apt-get install -y apt-transport-https software-properties-common
# å®‰è£…ä¾èµ–
 
sudo apt-get install -y wget
wget -q -O - https://packages.grafana.com/gpg.key | sudo apt-key add -
echo "deb https://packages.grafana.com/oss/deb stable main" | sudo tee /etc/apt/sources.list.d/grafana.list
sudo apt-get update
# æ·»åŠ grafanaä»“åº“

sudo apt-get install grafana
sudo systemctl start grafana-server
sudo systemctl enable grafana-server
# å®‰è£…å¹¶å¯åŠ¨grafana
```
è®¿é—®grafanaï¼š
æµè§ˆå™¨æ‰“å¼€ http://ä½ çš„æœåŠ¡å™¨IP:3000ï¼Œé»˜è®¤è´¦å·å¯†ç æ˜¯ï¼š
ç”¨æˆ·åï¼šadmin
å¯†ç ï¼šadmin  ç™»å½•ä¹‹åä¼šè¦æ±‚ä¿®æ”¹å¯†ç 

#### ğŸ“ˆ æ­¥éª¤å…­ï¼šé…ç½® Grafana
	1.	æ·»åŠ æ•°æ®æºï¼šé€‰æ‹© Prometheusï¼Œå¡«å…¥ http://localhost:9090
	2.	å¯¼å…¥ Dashboard æ¨¡æ¿ï¼š
	â€¢	Node Exporterï¼šå¯¼å…¥æ¨¡æ¿ ID 1860
	â€¢	Blackbox ç½‘ç«™çŠ¶æ€ï¼šå¯¼å…¥æ¨¡æ¿ ID 7587



### è¿è¡ŒæœåŠ¡å™¨

``` bash
$ hexo server
```

æ›´å¤šä¿¡æ¯: [æœåŠ¡ç«¯](https://hexo.io/docs/server.html)

### ç”Ÿæˆé™æ€æ–‡ä»¶

``` bash
$ hexo generate
```

æ›´å¤šä¿¡æ¯: [ç”Ÿæˆ](https://hexo.io/docs/generating.html)

### éƒ¨ç½²åˆ°è¿œç¨‹ä»“åº“

``` bash
$ hexo deploy
```

æ›´å¤šä¿¡æ¯: [éƒ¨ç½²](https://hexo.io/docs/one-command-deployment.html)
